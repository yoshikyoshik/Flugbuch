<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <script>
      // Initiales Laden des Themes, um Flackern zu verhindern
      if (
        localStorage.theme === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mein Digitales Flugbuch</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="api_service.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .autocomplete-container {
        position: relative;
      }
      .autocomplete-list {
        position: absolute;
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-top: none;
        background: white;
        width: 100%;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
      .autocomplete-item:hover,
      .autocomplete-item.active {
        background-color: #e0e7ff;
      }
      .flight-number-label {
        background-color: transparent;
        border: none;
        box-shadow: none;
        color: #1e293b;
        font-weight: bold;
        font-size: 10px;
        text-shadow: 0 0 2px white, 0 0 3px white;
      }
      .sort-btn.active,
      .chart-view-btn.active {
        background-color: #4338ca;
        color: white;
      }
      .logbook-view-btn.active {
        background-color: #4338ca;
        color: white;
      }
      .toast {
        padding: 1rem;
        border-radius: 0.5rem;
        color: white;
        font-size: 0.875rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateX(100%);
        animation: slideInFadeIn 0.5s forwards,
          slideOutFadeOut 0.5s 4.5s forwards;
      }
      .toast-success {
        background-color: #10b981;
      }
      .toast-error {
        background-color: #ef4444;
      }
      .toast-info {
        background-color: #3b82f6;
      }
      .dark body {
        background-color: #111827;
        color: #d1d5db;
      }
      .dark .bg-white {
        background-color: #1f2937;
        border-color: #374151;
      }
      .dark .bg-gray-100 {
        background-color: #111827;
      }
      .dark .bg-gray-50 {
        background-color: #1f2937;
      }
      .dark .bg-gray-200 {
        background-color: #374151;
      }
      .dark .bg-gray-200:hover {
        background-color: #4b5563;
      }
      .dark .bg-indigo-50 {
        background-color: #1f2937;
      }
      .dark .border-gray-200 {
        border-color: #4b5563;
      }
      .dark .text-gray-500 {
        color: #9ca3af;
      }
      .dark .text-gray-700 {
        color: #e5e7eb;
      }
      .dark .text-gray-800 {
        color: #f9fafb;
      }
      .dark .text-indigo-600 {
        color: #818cf8;
      }
      .dark .text-indigo-700 {
        color: #a5b4fc;
      }
      .dark input,
      .dark select,
      .dark textarea {
        background-color: #374151;
        border-color: #4b5563;
        color: #f9fafb;
      }
      .dark .autocomplete-list {
        background: #1f2937;
        border-color: #4b5563;
      }
      .dark .autocomplete-item:hover,
      .dark .autocomplete-item.active {
        background-color: #312e81;
      }
      .auth-tab {
        color: #6b7280;
      }
      .dark .auth-tab {
        color: #9ca3af;
      }
      .auth-tab.active-tab {
        color: #4f46e5;
        border-bottom: 2px solid #4f46e5;
      }
      .dark .auth-tab.active-tab {
        color: #818cf8;
        border-color: #818cf8;
      }
      @keyframes slideInFadeIn {
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes slideOutFadeOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }
    </style>
  </head>

  <body class="bg-gray-100 dark:bg-gray-900">
    <div
      id="auth-container"
      class="min-h-screen flex items-center justify-center p-4"
    >
      <div
        class="w-full max-w-md bg-white dark:bg-gray-800 shadow-2xl rounded-xl p-8"
      >
        <h1
          class="text-3xl font-extrabold text-indigo-700 dark:text-indigo-400 mb-6 text-center"
        >
          ‚úàÔ∏è Digitales Flugbuch
        </h1>
        <div id="auth-tabs" class="flex justify-center border-b mb-6">
          <button
            onclick="switchAuthTab('login')"
            id="login-tab"
            class="auth-tab active-tab px-4 py-2 font-semibold"
          >
            Login
          </button>
          <button
            onclick="switchAuthTab('register')"
            id="register-tab"
            class="auth-tab px-4 py-2 font-semibold"
          >
            Registrieren
          </button>
        </div>
        <form id="login-form" class="space-y-4">
          <input
            type="email"
            id="login-email"
            placeholder="E-Mail"
            required
            class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
          />
          <input
            type="password"
            id="login-password"
            placeholder="Passwort"
            required
            class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
          />
          <div class="text-right">
            <a
              href="#"
              onclick="event.preventDefault(); showPasswordResetForm();"
              class="text-sm font-medium text-indigo-600 hover:underline dark:text-indigo-400"
              >Passwort vergessen?</a
            >
          </div>
          <button
            type="submit"
            class="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
          >
            Einloggen
          </button>
        </form>
        <form id="register-form" class="space-y-4 hidden">
          <input
            type="email"
            id="register-email"
            placeholder="E-Mail"
            required
            class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
          />
          <input
            type="password"
            id="register-password"
            placeholder="Passwort"
            required
            class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
          />
          <button
            type="submit"
            class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
          >
            Registrieren
          </button>
        </form>
        <div id="password-reset-container" class="hidden">
          <form id="request-reset-form" class="space-y-4">
            <p class="text-sm text-center text-gray-600 dark:text-gray-400">
              Gib deine E-Mail-Adresse ein, um einen Link zum Zur√ºcksetzen
              deines Passworts zu erhalten.
            </p>
            <input
              type="email"
              id="reset-email"
              placeholder="E-Mail"
              required
              class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
            />
            <button
              type="submit"
              class="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
            >
              Reset-Link anfordern
            </button>
          </form>
          <form id="update-password-form" class="space-y-4 hidden">
            <p class="text-sm text-center text-gray-600 dark:text-gray-400">
              Gib dein neues Passwort ein.
            </p>
            <input
              type="password"
              id="update-password-input"
              placeholder="Neues Passwort (mind. 6 Zeichen)"
              required
              class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
            />
            <button
              type="submit"
              class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
            >
              Neues Passwort speichern
            </button>
          </form>
          <div class="text-center mt-4">
            <a
              href="#"
              onclick="event.preventDefault(); backToLogin();"
              class="text-sm font-medium text-indigo-600 hover:underline dark:text-indigo-400"
              >Zur√ºck zum Login</a
            >
          </div>
        </div>
        <p id="auth-error" class="text-red-500 text-sm mt-4 text-center"></p>
      </div>
    </div>

    <div
      id="app-container"
      class="hidden min-h-screen p-4 md:p-8 flex items-center justify-center"
    >
      <div
        class="w-full max-w-4xl bg-white dark:bg-gray-800 shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100 dark:border-gray-700"
      >
        <div class="flex justify-between items-center mb-2">
          <h1
            class="text-2xl md:text-4xl font-extrabold text-indigo-700 dark:text-indigo-400"
          >
            ‚úàÔ∏è Digitales Flugbuch
          </h1>
          <div class="relative">
            <button
              id="burger-menu-btn"
              class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16m-7 6h7"
                ></path>
              </svg>
            </button>
            <div
              id="burger-menu"
              class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg z-50 border dark:border-gray-700"
            >
              <div class="md:hidden border-b dark:border-gray-700">
                <a
                  href="#"
                  onclick="event.preventDefault(); showTab('neue-fluege')"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Neuer Flug</a
                >
                <a
                  href="#"
                  onclick="event.preventDefault(); showTab('fluege')"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Fl√ºge</a
                >
                <a
                  href="#"
                  onclick="event.preventDefault(); showTab('stats')"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Statistiken</a
                >
                <a
                  href="#"
                  onclick="event.preventDefault(); showTab('charts')"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Charts</a
                >
                <a
                  href="#"
                  onclick="event.preventDefault(); showTab('logbook')"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Logbuch</a
                >
				<a href="#" onclick="event.preventDefault(); showTab('achievements')" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Errungenschaften</a>
              </div>
              <div class="py-1">
                <a
                  href="#"
                  onclick="event.preventDefault(); showPasswordChangeModal()"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Passwort √§ndern</a
                >
                <a
                  href="#"
                  id="menu-theme-toggle"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Modus wechseln</a
                >
                <a
                  href="#"
                  id="menu-logout-btn"
                  class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Logout</a
                >
              </div>
              <div class="border-t dark:border-gray-700 px-4 py-2">
                <span
                  id="user-display"
                  class="block text-xs text-gray-500"
                ></span>
                <span
                  id="app-version"
                  class="block text-xs text-gray-400"
                ></span>
              </div>
            </div>
          </div>
        </div>

        <h2
          class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white mb-4 border-b pb-2 border-gray-200 dark:border-gray-700"
        >
          Zuletzt geloggter/bearbeiteter Flug
        </h2>
        <div class="mb-6">
          <p
            id="map-info"
            class="text-center text-sm text-gray-700 dark:text-gray-300 mb-2 italic"
          >
            Flugroute wird visualisiert.
          </p>
          <div
            id="flight-map-container"
            class="h-[300px] rounded-lg mb-6 shadow-lg z-0"
          ></div>
        </div>
        <div>
          <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="hidden md:flex -mb-px space-x-6" aria-label="Tabs">
              <button
                onclick="showTab('neue-fluege')"
                id="tab-btn-neue-fluege"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600"
              >
                Neuer Flug
              </button>
              <button
                onclick="showTab('fluege')"
                id="tab-btn-fluege"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600"
              >
                Fl√ºge
              </button>
              <button
                onclick="showTab('stats')"
                id="tab-btn-stats"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              >
                Statistiken
              </button>
              <button
                onclick="showTab('charts')"
                id="tab-btn-charts"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              >
                Charts
              </button>
              <button
                onclick="showTab('logbook')"
                id="tab-btn-logbook"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              >
                Logbuch
              </button>
              <button
                onclick="showTab('achievements')"
                id="tab-btn-achievements"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              >
                Errungenschaften
              </button>
            </nav>
          </div>
          <div class="py-6">
            <div id="tab-content-neue-fluege">
              <p class="text-gray-500 dark:text-gray-400 mb-8">
                W√§hlen Sie einen Flughafen aus der Liste oder geben Sie einen
                Code/Namen manuell ein.
              </p>
			  
			  <div class="bg-gray-50 dark:bg-gray-700 p-5 rounded-lg mb-6 shadow-inner border dark:border-gray-600">
					<h3 class="text-lg font-semibold text-indigo-600 dark:text-indigo-400 mb-4 flex items-center gap-2">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
						Autopilot: Flugdaten per Flugnummer laden
					</h3>
					<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
						<div>
							<label for="auto-flight-number" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Flugnummer</label>
							<input type="text" id="auto-flight-number" placeholder="z.B. LH202" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
						</div>
						<div>
							<label for="auto-flight-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Flugdatum</label>
							<input type="date" id="auto-flight-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
						</div>
						<button id="autofill-btn" class="w-full py-3 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">Daten abrufen</button>
					</div>
				</div>
			  
              <div
                class="bg-indigo-50 dark:bg-gray-900 p-5 rounded-lg mb-6 shadow-inner"
              >
                <h2
                  class="text-xl font-semibold text-indigo-600 dark:text-indigo-400 mb-4"
                >
                  Neuen Flug loggen
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div class="autocomplete-container">
                    <label
                      for="departure"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Abflugort (IATA/Name)</label
                    >
                    <input
                      type="text"
                      id="departure"
                      placeholder="z.B. FRA"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                    />
                    <div
                      id="departure-list"
                      class="autocomplete-list hidden rounded-lg"
                    ></div>
                  </div>
                  <div class="autocomplete-container">
                    <label
                      for="arrival"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Zielort (IATA/Name)</label
                    >
                    <input
                      type="text"
                      id="arrival"
                      placeholder="z.B. JFK"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                    />
                    <div
                      id="arrival-list"
                      class="autocomplete-list hidden rounded-lg"
                    ></div>
                  </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                  <div>
                    <label
                      for="flightDate"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Flugdatum (Optional)</label
                    ><input
                      type="date"
                      id="flightDate"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"
                    />
                  </div>
                  <div>
                    <label
                      for="flightClass"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Klasse/Zweck (Optional)</label
                    ><select
                      id="flightClass"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 bg-white"
                    >
                      <option value="Economy">Economy</option>
                      <option value="Business">Business</option>
                      <option value="First">First</option>
                      <option value="Privat">Privat</option>
                      <option value="Cargo">Cargo</option>
                    </select>
                  </div>
                  <div>
                    <label
                      for="flightNumber"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Flugnummer (Optional)</label
                    ><input
                      type="text"
                      id="flightNumber"
                      placeholder="z.B. LH400"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"
                    />
                  </div>
                  <div>
                    <label
                      for="aircraftType"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Flugzeugtyp (Optional)</label
                    ><input
                      type="text"
                      id="aircraftType"
                      placeholder="z.B. B747-8"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"
                    />
                  </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                  <div>
                    <label
                      for="price"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Ticketpreis (Optional)</label
                    >
                    <input
                      type="number"
                      id="price"
                      placeholder="z.B. 199.99"
                      step="0.01"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"
                    />
                  </div>
                  <div>
                    <label
                      for="currency"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >W√§hrung (Optional)</label
                    >
                    <input
                      type="text"
                      id="currency"
                      placeholder="z.B. EUR"
                      maxlength="3"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"
                    />
                  </div>
                </div>

                <div class="mb-6">
                  <label
                    for="flightPhoto"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                    >Foto (Optional)</label
                  >
                  <input
                    type="file"
                    id="flightPhoto"
                    accept="image/*"
                    class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"
                    multiple
                  />
                  <div id="photo-preview-container" class="hidden mt-2">
                    <p
                      id="photo-preview-text"
                      class="text-sm text-gray-600 dark:text-gray-400"
                    ></p>
                  </div>
                </div>
                <div class="mb-6">
                  <label
                    for="notes"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                    >Bemerkungen (Optional)</label
                  >
                  <textarea
                    id="notes"
                    rows="3"
                    placeholder="Besondere Vorkommnisse oder pers√∂nliche Notizen..."
                    class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 text-sm"
                  ></textarea>
                </div>
                <div
                  class="grid grid-cols-2 gap-4 bg-indigo-100 dark:bg-indigo-900/50 p-4 rounded-lg border border-indigo-200 dark:border-indigo-800 mb-4"
                >
                  <div>
                    <p
                      class="text-xs font-medium text-indigo-700 dark:text-indigo-300"
                    >
                      Gesch√§tzte Entfernung
                    </p>
                    <p
                      id="distance-display"
                      class="text-xl font-bold text-indigo-800 dark:text-indigo-400"
                    >
                      -
                    </p>
                  </div>
                  <div>
                    <p
                      class="text-xs font-medium text-indigo-700 dark:text-indigo-300"
                    >
                      Gesch√§tzte Flugzeit
                    </p>
                    <p
                      id="time-display"
                      class="text-xl font-bold text-indigo-800 dark:text-indigo-400"
                    >
                      -
                    </p>
                  </div>
                </div>
                <div
                  class="flex flex-col sm:flex-row items-stretch sm:items-center gap-4"
                >
                  <button
                    onclick="logFlight()"
                    id="log-button"
                    disabled
                    class="w-full py-3 px-4 ..."
                  >
                    Flug loggen und speichern
                  </button>
                  <button
                    onclick="resetForm()"
                    id="cancel-edit-button"
                    class="hidden w-full sm:w-1/3 py-3 px-4 ..."
                  >
                    Abbrechen
                  </button>
                </div>
              </div>
            </div>

            <div id="tab-content-fluege">
              <div
                class="flex items-center justify-between mb-4 border-b pb-2 border-gray-200 dark:border-gray-700"
              >
                <h2
                  class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white"
                >
                  Gespeicherte Fl√ºge
                </h2>
                <div class="flex flex-wrap items-center space-x-4">
                  <button
                    id="toggle-map-view-btn"
                    onclick="toggleAllRoutesView()"
                    class="text-sm font-medium text-indigo-600 hover:text-indigo-800 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition"
                  >
                    Alle Routen zeigen
                  </button>
                  <button
                    onclick="renderFlights()"
                    class="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center p-2 rounded-lg bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition"
                  >
                    Aktualisieren
                  </button>
                </div>
              </div>
              <div
                class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg mb-4 border border-gray-200 dark:border-gray-700"
              >
                <h3
                  class="text-lg font-semibold text-gray-800 dark:text-white mb-3"
                >
                  Fl√ºge filtern
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                  <div>
                    <label
                      for="filter-departure"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Abflugort (IATA)</label
                    ><input
                      type="text"
                      id="filter-departure"
                      placeholder="z.B. FRA"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                  </div>
                  <div>
                    <label
                      for="filter-arrival"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Zielort (IATA)</label
                    ><input
                      type="text"
                      id="filter-arrival"
                      placeholder="z.B. JFK"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                  </div>
                  <div>
                    <label
                      for="filter-date-from"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Datum (von)</label
                    ><input
                      type="date"
                      id="filter-date-from"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                  </div>
                  <div>
                    <label
                      for="filter-date-to"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Datum (bis)</label
                    ><input
                      type="date"
                      id="filter-date-to"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                  </div>
                  <div class="flex space-x-2">
                    <button
                      onclick="applyFilters()"
                      class="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition"
                    >
                      Filtern</button
                    ><button
                      onclick="resetFilters()"
                      class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition"
                    >
                      Reset
                    </button>
                  </div>
                </div>
              </div>
              <div
                id="sort-bar"
                class="flex flex-wrap items-center gap-2 mb-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-md text-sm font-semibold"
              >
                <span class="text-gray-600 dark:text-gray-300 mr-2"
                  >Sortieren nach:</span
                >
                <button
                  id="sort-btn-flightLogNumber"
                  onclick="setSortOrder('flightLogNumber')"
                  class="sort-btn flex-shrink-0 px-3 py-1 rounded-md transition hover:bg-gray-300 dark:hover:bg-gray-500"
                >
                  #
                </button>
                <button
                  id="sort-btn-date"
                  onclick="setSortOrder('date')"
                  class="sort-btn flex-shrink-0 px-3 py-1 rounded-md transition hover:bg-gray-300 dark:hover:bg-gray-500"
                >
                  Datum
                </button>
                <button
                  id="sort-btn-departure"
                  onclick="setSortOrder('departure')"
                  class="sort-btn flex-grow px-3 py-1 rounded-md transition hover:bg-gray-300 dark:hover:bg-gray-500 text-left"
                >
                  Route
                </button>
                <button
                  id="sort-btn-distance"
                  onclick="setSortOrder('distance')"
                  class="sort-btn flex-shrink-0 px-3 py-1 rounded-md transition hover:bg-gray-300 dark:hover:bg-gray-500"
                >
                  Distanz
                </button>
              </div>
              <div
                id="flight-log-list"
                class="space-y-3 max-h-96 overflow-y-auto pr-2"
              ></div>
              <div
                id="pagination-controls"
                class="flex justify-between items-center mt-4 text-sm text-gray-600 dark:text-gray-400"
              >
                <button
                  id="prev-page-btn"
                  onclick="prevPage()"
                  class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  ‚Äπ Zur√ºck
                </button>
                <span id="page-info" class="font-semibold"></span>
                <button
                  id="next-page-btn"
                  onclick="nextPage()"
                  class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Weiter ‚Ä∫
                </button>
              </div>
            </div>

            <div id="tab-content-stats">
              <div
                id="statistics-panel"
                class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-100 dark:bg-gray-900 p-4 rounded-lg text-center"
              >
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    Gesamte Fl√ºge
                  </p>
                  <p
                    id="stat-count"
                    class="text-xl font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    0
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    Gesamtdistanz
                  </p>
                  <p
                    id="stat-distance"
                    class="text-xl font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    0 km
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    H√§ufigster Flughafen
                  </p>
                  <p
                    id="stat-frequent"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    Daten-Export
                  </p>
                  <div class="flex space-x-2 mt-1 justify-center">
                    <button
                      onclick="exportData('csv')"
                      class="text-xs py-1 px-2 bg-green-500 text-white rounded hover:bg-green-600 transition"
                    >
                      CSV</button
                    ><button
                      onclick="exportData('json')"
                      class="text-xs py-1 px-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition"
                    >
                      JSON
                    </button>
                  </div>
                </div>

                <div
                  class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm col-span-2"
                >
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    Gesamtausgaben
                  </p>
                  <p
                    id="stat-total-spending"
                    class="text-xl font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    Teuerster Flug
                  </p>
                  <p
                    id="stat-most-expensive"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    G√ºnstigster Flug
                  </p>
                  <p
                    id="stat-least-expensive"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>

                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    L√§ngster Flug
                  </p>
                  <p
                    id="stat-longest-flight"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    K√ºrzester Flug
                  </p>
                  <p
                    id="stat-shortest-flight"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    √ò Flugdistanz
                  </p>
                  <p
                    id="stat-avg-distance"
                    class="text-xl font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    0 km
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400"
                  >
                    H√§ufigster Flugzeugtyp
                  </p>
                  <p
                    id="stat-frequent-aircraft"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div
                  class="col-span-2 md:col-span-4 p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm"
                >
                  <div class="flex items-center justify-between">
                    <p
                      class="text-xs font-medium text-gray-700 dark:text-gray-400"
                    >
                      Jahreszusammenfassung
                    </p>
                    <select
                      id="stat-year-select"
                      class="text-xs p-1 rounded border-gray-300 dark:bg-gray-700 dark:border-gray-600"
                    ></select>
                  </div>
                  <p
                    id="stat-yearly-summary"
                    class="text-lg font-bold text-indigo-800 dark:text-indigo-400 mt-2"
                  >
                    -
                  </p>
                </div>
              </div>
            </div>
            <div id="tab-content-charts" class="hidden">
              <div
                class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700"
              >
                <div
                  class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-600 pb-2"
                >
                  <h2
                    class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-100"
                  >
                    Visuelle Auswertungen
                  </h2>
                  <div class="flex items-center gap-2 text-sm">
                    <button
                      id="chart-view-year"
                      class="chart-view-btn active px-3 py-1 rounded-md transition"
                    >
                      Pro Jahr
                    </button>
                    <button
                      id="chart-view-month"
                      class="chart-view-btn px-3 py-1 rounded-md transition"
                    >
                      Pro Monat
                    </button>
                  </div>
                </div>
                <div class="grid grid-cols-1 gap-8 mt-4">
                  <div>
                    <h3
                      class="font-semibold text-center text-gray-700 dark:text-gray-300 mb-2"
                    >
                      Fl√ºge pro Zeitraum
                    </h3>
                    <canvas id="flightsChart"></canvas>
                  </div>
                  <div>
                    <h3
                      class="font-semibold text-center text-gray-700 dark:text-gray-300 mb-2"
                    >
                      Distanz pro Zeitraum (km)
                    </h3>
                    <canvas id="distanceChart"></canvas>
                  </div>
                  <div>
                    <h3
                      class="font-semibold text-center text-gray-700 dark:text-gray-300 mb-2"
                    >
                      Flugzeit pro Zeitraum
                    </h3>
                    <canvas id="timeChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div id="tab-content-logbook" class="hidden">
              <div
                class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700"
              >
                <div
                  class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-600 pb-2"
                >
                  <h2
                    class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-100"
                  >
                    Logbuch-Ansichten
                  </h2>
                  <div
                    id="logbook-nav"
                    class="flex flex-wrap items-center gap-2 text-sm"
                  >
                    <button
                      id="logbook-view-aircraft"
                      class="logbook-view-btn active px-3 py-1 rounded-md transition"
                    >
                      Nach Flugzeugtyp
                    </button>
                    <button
                      id="logbook-view-airline"
                      class="logbook-view-btn px-3 py-1 rounded-md transition"
                    >
                      Nach Airline
                    </button>
                    <button
                      id="logbook-view-airport"
                      class="logbook-view-btn px-3 py-1 rounded-md transition"
                    >
                      Nach Flughafen
                    </button>
                  </div>
                </div>
                <div id="logbook-content" class="mt-4 space-y-4"></div>
              </div>
            </div>

            <div id="tab-content-achievements" class="hidden">
              <div
                class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700"
              >
                <h2
                  class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4"
                >
                  Deine Errungenschaften
                </h2>
                <div
                  id="achievements-container"
                  class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="password-change-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-md"
      >
        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
          Neues Passwort festlegen
        </h3>
        <form id="password-change-form" class="space-y-4">
          <div>
            <label
              for="new-password"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Neues Passwort</label
            >
            <input
              type="password"
              id="new-password"
              placeholder="Mindestens 6 Zeichen"
              class="mt-1 w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
            />
          </div>
          <div class="flex justify-end gap-4">
            <button
              type="button"
              onclick="closePasswordChangeModal(event)"
              class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition"
            >
              Abbrechen
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition"
            >
              Speichern
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <script>
      // (JavaScript content follows)

      // =================================================================
      // INITIALISIERUNG & GLOBALE VARIABLEN
      // =================================================================

      const SUPABASE_URL = "https://sbmjdwktxsnmukbooycu.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNibWpkd2t0eHNubXVrYm9veWN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyOTczNDgsImV4cCI6MjA3NTg3MzM0OH0.NN9EHfS7iyAZvFm_UYs3PxEWj2pMbYmMduUeVA70rpo";
      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Achievements
      const achievements = {
        flights: [
          {
            milestone: 1,
            emoji: "üéâ",
            title: "Erster Eintrag",
            description: "Dein erster Flug ist geloggt!",
          },
          {
            milestone: 10,
            emoji: "‚úàÔ∏è",
            title: "Vielflieger-Anw√§rter",
            description: "10 Fl√ºge geloggt",
          },
          {
            milestone: 25,
            emoji: "üõ´",
            title: "Bronze-Flieger",
            description: "25 Fl√ºge erreicht",
          },
          {
            milestone: 50,
            emoji: "üåç",
            title: "Globetrotter",
            description: "50 Fl√ºge absolviert",
          },
          {
            milestone: 100,
            emoji: "üíØ",
            title: "Hunderter-Club",
            description: "100 Fl√ºge gemeistert!",
          },
          {
            milestone: 150,
            emoji: "üåü",
            title: "Silber-Status",
            description: "150 Fl√ºge im Logbuch",
          },
          {
            milestone: 250,
            emoji: "üèÜ",
            title: "Gold-Status",
            description: "250 Fl√ºge erreicht!",
          },
          {
            milestone: 500,
            emoji: "üöÄ",
            title: "Luftfahrt-Legende",
            description: "500 Fl√ºge, unglaublich!",
          },
          {
            milestone: 750,
            emoji: "üíé",
            title: "Diamant-Status",
            description: "750 Fl√ºge, der Himmel geh√∂rt dir!",
          },
          {
            milestone: 1000,
            emoji: "üåå",
            title: "Meister der L√ºfte",
            description: "1.000 Fl√ºge geloggt!",
          },
        ],
        distance: [
          {
            milestone: 10000,
            emoji: "üèÉ",
            title: "Zehntausender-Marke",
            description: "10.000 km zur√ºckgelegt",
          },
          {
            milestone: 40075,
            emoji: "üåê",
            title: "Weltumrunder",
            description: "Einmal um den √Ñquator geflogen (40.075 km)",
          },
          {
            milestone: 100000,
            emoji: "‚ú®",
            title: "Sechsstellige Distanz",
            description: "100.000 km geknackt",
          },
          {
            milestone: 250000,
            emoji: "üèÖ",
            title: "Viertelmillion√§r",
            description: "250.000 km in der Luft",
          },
          {
            milestone: 384400,
            emoji: "üåï",
            title: "Mond-Reisender",
            description: "Die Distanz zum Mond zur√ºckgelegt (384.400 km)",
          },
          {
            milestone: 500000,
            emoji: "üå†",
            title: "Halbe Million",
            description: "500.000 km gereist",
          },
          {
            milestone: 768800,
            emoji: "üõ∞Ô∏è",
            title: "Hin und Zur√ºck",
            description:
              "Die Distanz zum Mond und zur√ºck zur Erde (768.800 km)",
          },
          {
            milestone: 1000000,
            emoji: "üí•",
            title: "Distanz-Million√§r",
            description: "Eine Million Kilometer geflogen!",
          },
        ],
        time: [
          // in Stunden
          {
            milestone: 24,
            emoji: "‚òÄÔ∏è",
            title: "Rund um die Uhr",
            description: "24 Stunden in der Luft verbracht",
          },
          {
            milestone: 100,
            emoji: "üóìÔ∏è",
            title: "Hundert Stunden",
            description: "√úber 100 Stunden Flugzeit",
          },
          {
            milestone: 500,
            emoji: "üï∞Ô∏è",
            title: "500-Stunden-Marke",
            description: "Mehr als 20 Tage im Flugzeug verbracht",
          },
          {
            milestone: 1000,
            emoji: "‚è≥",
            title: "Tausend Stunden Flugzeit",
            description: "√úber 1.000 Stunden in der Luft",
          },
          {
            milestone: 2500,
            emoji: "‚ú®",
            title: "Viertausend Stunden",
            description: "Mehr als 100 Tage Flugzeit",
          },
          {
            milestone: 8760,
            emoji: "üí´",
            title: "Ein Jahr im Himmel",
            description: "Ein ganzes Jahr (8.760h) in der Luft verbracht",
          },
        ],
        uniqueAirports: [
          {
            milestone: 10,
            emoji: "üó∫Ô∏è",
            title: "Entdecker",
            description: "10 verschiedene Flugh√§fen besucht",
          },
          {
            milestone: 25,
            emoji: "üß≠",
            title: "Weltenbummler",
            description: "25 einzigartige Flugh√§fen im Logbuch",
          },
          {
            milestone: 50,
            emoji: "üèõÔ∏è",
            title: "Kultursammler",
            description: "50 verschiedene Flugh√§fen gesehen",
          },
          {
            milestone: 100,
            emoji: "üóΩ",
            title: "Hub-Hopper",
            description: "100 einzigartige Flugh√§fen angeflogen!",
          },
        ],
        longestFlight: [
          {
            milestone: 3000,
            emoji: "‚úàÔ∏è",
            title: "Langstrecken-Deb√ºt",
            description: "Ein Flug √ºber 3.000 km",
          },
          {
            milestone: 5000,
            emoji: "üõ´",
            title: "Kontinentspringer",
            description: "Einen Flug √ºber 5.000 km absolviert",
          },
          {
            milestone: 8000,
            emoji: "üåä",
            title: "Ozean-√úberquerer",
            description: "Ein Flug √ºber 8.000 km",
          },
          {
            milestone: 12000,
            emoji: "üöÄ",
            title: "Ultra-Langstrecke",
            description: "Einen epischen Flug √ºber 12.000 km gemeistert",
          },
        ],
      };

      let map;
      let routeLayer;
      let currentlyEditingFlightData = null;
      let isAllRoutesViewActive = false;
      let currentSort = { key: "flightLogNumber", direction: "asc" };
      let currentPage = 1;
      const ITEMS_PER_PAGE = 5;
      let flightsChartInstance, distanceChartInstance, timeChartInstance;
      let currentChartTimeframe = "year";
      let isAppInitialized = false; // NEUER SCHUTZSCHALTER
      var airportData = {
        FRA: {
          name: "Frankfurt",
          city: "Frankfurt",
          lat: 50.0333,
          lon: 8.5706,
        },
        MUC: { name: "M√ºnchen", city: "Munich", lat: 48.3538, lon: 11.7861 },
        BER: {
          name: "Berlin Brandenburg",
          city: "Berlin",
          lat: 52.3667,
          lon: 13.5033,
        },
        HAM: { name: "Hamburg", city: "Hamburg", lat: 53.6304, lon: 9.9882 },
        DUS: {
          name: "D√ºsseldorf",
          city: "Dusseldorf",
          lat: 51.2895,
          lon: 6.7667,
        },
        VIE: { name: "Wien", city: "Vienna", lat: 48.1103, lon: 16.5697 },
        ZRH: { name: "Z√ºrich", city: "Zurich", lat: 47.4647, lon: 8.5492 },
        AMS: {
          name: "Amsterdam Schiphol",
          city: "Amsterdam",
          lat: 52.3086,
          lon: 4.7638,
        },
        LHR: {
          name: "London Heathrow",
          city: "London",
          lat: 51.47,
          lon: -0.4543,
        },
        CDG: {
          name: "Paris Charles de Gaulle",
          city: "Paris",
          lat: 49.0097,
          lon: 2.5479,
        },
        IST: { name: "Istanbul", city: "Istanbul", lat: 41.2619, lon: 28.7361 },
        JFK: {
          name: "New York JFK",
          city: "New York",
          lat: 40.6413,
          lon: -73.7781,
        },
        LAX: {
          name: "Los Angeles Intl",
          city: "Los Angeles",
          lat: 33.9416,
          lon: -118.4085,
        },
        ATL: {
          name: "Atlanta Intl",
          city: "Atlanta",
          lat: 33.6407,
          lon: -84.4277,
        },
        DXB: { name: "Dubai Intl", city: "Dubai", lat: 25.2532, lon: 55.3653 },
        SIN: {
          name: "Singapur Changi",
          city: "Singapore",
          lat: 1.3644,
          lon: 103.9915,
        },
        NRT: {
          name: "Tokio Narita",
          city: "Tokyo",
          lat: 35.7647,
          lon: 140.3864,
        },
        SYD: {
          name: "Sydney Intl",
          city: "Sydney",
          lat: -33.9461,
          lon: 151.1772,
        },
        HND: {
          name: "Tokio Haneda",
          city: "Tokyo",
          lat: 35.5523,
          lon: 139.7797,
        },
        ICN: {
          name: "Seoul Incheon",
          city: "Seoul",
          lat: 37.4692,
          lon: 126.4505,
        },
        PEK: {
          name: "Peking Capital",
          city: "Beijing",
          lat: 40.0799,
          lon: 116.6031,
        },
        PVG: {
          name: "Shanghai Pudong",
          city: "Shanghai",
          lat: 31.1434,
          lon: 121.7876,
        },
        DFW: {
          name: "Dallas/Fort Worth",
          city: "Dallas",
          lat: 32.8998,
          lon: -97.0403,
        },
        ORD: {
          name: "Chicago O'Hare",
          city: "Chicago",
          lat: 41.9742,
          lon: -87.9073,
        },
        MAD: {
          name: "Madrid Barajas",
          city: "Madrid",
          lat: 40.4839,
          lon: -3.5679,
        },
        BCN: {
          name: "Barcelona-El Prat",
          city: "Barcelona",
          lat: 41.2974,
          lon: 2.0787,
        },
        FCO: {
          name: "Rom Fiumicino",
          city: "Rome",
          lat: 41.8003,
          lon: 12.2389,
        },
        DOH: {
          name: "Doha Hamad Intl",
          city: "Doha",
          lat: 25.273,
          lon: 51.608,
        },
        GRU: {
          name: "S√£o Paulo Guarulhos",
          city: "Sao Paulo",
          lat: -23.4356,
          lon: -46.4731,
        },
        CPT: {
          name: "Kapstadt",
          city: "Cape Town",
          lat: -33.9692,
          lon: 18.6017,
        },
        JNB: {
          name: "Johannesburg OR Tambo",
          city: "Johannesburg",
          lat: -26.1367,
          lon: 28.2435,
        },
        SFO: {
          name: "San Francisco Intl",
          city: "San Francisco",
          lat: 37.6213,
          lon: -122.379,
        },
      };

      // =================================================================
      // AUTH & APP INITIALIZATION FUNCTIONS
      // =================================================================

      async function initializeApp() {
        if (isAppInitialized) return;
        isAppInitialized = true;

        document.getElementById("auth-container").classList.add("hidden");
        document.getElementById("app-container").classList.remove("hidden");

        try {
          const {
            data: { user },
          } = await supabaseClient.auth.getUser();
          if (user) {
            const userDisplay = document.getElementById("user-display");
            if (userDisplay) {
              userDisplay.textContent = user.email;
            }
          }
        } catch (e) {
          console.error("Fehler beim Abrufen des Benutzers:", e);
        }

        await migrateAndLoadAirports();

        if (!map) {
          map = L.map("flight-map-container").setView([20, 0], 2);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution:
              '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          }).addTo(map);
          routeLayer = L.layerGroup().addTo(map);
        }

        // --- KORRIGIERTER BEREICH: Event-Listener ---

		// Listener f√ºr Flight-Number:
        document.getElementById('autofill-btn').addEventListener('click', autofillFlightData);

        // Listener f√ºr das neue Burger-Men√º
        document
          .getElementById("burger-menu-btn")
          .addEventListener("click", toggleBurgerMenu);
        document
          .getElementById("menu-logout-btn")
          .addEventListener("click", logout);
        document
          .getElementById("menu-theme-toggle")
          .addEventListener("click", toggleDarkMode);

        // Listener, um das Men√º zu schlie√üen, wenn man daneben klickt
        document.addEventListener("click", function (event) {
          const menu = document.getElementById("burger-menu");
          const menuBtn = document.getElementById("burger-menu-btn");
          // Pr√ºfe, ob das Men√º offen ist UND der Klick au√üerhalb des Men√ºs und des Buttons war
          if (
            !menu.classList.contains("hidden") &&
            !menu.contains(event.target) &&
            !menuBtn.contains(event.target)
          ) {
            toggleBurgerMenu();
          }
        });

        // Alle anderen, weiterhin g√ºltigen Listener
        document
          .getElementById("chart-view-year")
          .addEventListener("click", () => setChartTimeframe("year"));
        document
          .getElementById("chart-view-month")
          .addEventListener("click", () => setChartTimeframe("month"));
        document
          .getElementById("password-change-form")
          .addEventListener("submit", changePassword);
        document
          .getElementById("flightPhoto")
          .addEventListener("change", (event) => {
            const files = event.target.files;
            const previewText = document.getElementById("photo-preview-text");
            const previewContainer = document.getElementById(
              "photo-preview-container"
            );
            if (files && files.length > 0) {
              previewText.textContent = `${files.length} Foto(s) ausgew√§hlt.`;
              previewContainer.classList.remove("hidden");
            } else {
              previewContainer.classList.add("hidden");
            }
          });
        document.getElementById("departure").addEventListener("input", () => {
          updateAutocompleteList("departure", "departure-list");
          updateFlightDetails();
        });
        document.getElementById("arrival").addEventListener("input", () => {
          updateAutocompleteList("arrival", "arrival-list");
          updateFlightDetails();
        });
        document
          .getElementById("logbook-view-aircraft")
          .addEventListener("click", () => renderLogbookView("aircraftType"));
        document
          .getElementById("logbook-view-airline")
          .addEventListener("click", () => renderLogbookView("airline"));
        document
          .getElementById("logbook-view-airport")
          .addEventListener("click", () => renderLogbookView("airport"));

        // --- ENDE KORRIGIERTER BEREICH ---

        // Initiales Rendern der App
        showTab("neue-fluege");
        renderFlights();
        displayAppVersion();
      }

      function showAuth() {
        document.getElementById("auth-container").classList.remove("hidden");
        document.getElementById("app-container").classList.add("hidden");
      }

      function switchAuthTab(tab) {
        const loginTab = document.getElementById("login-tab");
        const registerTab = document.getElementById("register-tab");
        const loginForm = document.getElementById("login-form");
        const registerForm = document.getElementById("register-form");
        document.getElementById("auth-error").textContent = "";

        if (tab === "login") {
          loginTab.classList.add("active-tab");
          registerTab.classList.remove("active-tab");
          loginForm.classList.remove("hidden");
          registerForm.classList.add("hidden");
        } else {
          loginTab.classList.remove("active-tab");
          registerTab.classList.add("active-tab");
          loginForm.classList.add("hidden");
          registerForm.classList.remove("hidden");
        }
      }

      async function logout() {
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
          console.error("Error logging out:", error);
          showMessage("Logout-Fehler", error.message, "error");
        } else {
          window.location.reload();
        }
      }

      function showPasswordChangeModal() {
        document.getElementById("new-password").value = "";
        document
          .getElementById("password-change-modal")
          .classList.remove("hidden");
        document.getElementById("password-change-modal").classList.add("flex");
      }

      function closePasswordChangeModal(event) {
        if (event) {
          event.preventDefault(); // Verhindert jegliche Standard-Button-Aktion
        }
        document
          .getElementById("password-change-modal")
          .classList.add("hidden");
        document
          .getElementById("password-change-modal")
          .classList.remove("flex");
      }

      async function changePassword(event) {
        event.preventDefault();
        const newPassword = document.getElementById("new-password").value;

        if (newPassword.length < 6) {
          showMessage(
            "Fehler",
            "Das Passwort muss mindestens 6 Zeichen lang sein.",
            "error"
          );
          return;
        }

        try {
          const { error } = await supabaseClient.auth.updateUser({
            password: newPassword,
          });

          if (error) {
            // F√§ngt "normale" Supabase-Fehler ab (z.B. "Passwort zu schwach")
            throw error;
          }

          // Dieser Teil wird jetzt wieder erreicht werden
          showMessage(
            "Erfolg!",
            "Dein Passwort wurde erfolgreich ge√§ndert.",
            "success"
          );
          closePasswordChangeModal();
        } catch (error) {
          // F√§ngt JEDEN denkbaren Fehler ab, auch Netzwerkprobleme oder unerwartetes Verhalten
          showMessage(
            "Fehler",
            "Das Passwort konnte nicht ge√§ndert werden.",
            "error"
          );
          console.error(
            "Ein unerwarteter Fehler ist beim Passwort-Update aufgetreten:",
            error
          );
        }
      }

      function showPasswordResetForm() {
        document.getElementById("auth-tabs").classList.add("hidden");
        document.getElementById("login-form").classList.add("hidden");
        document.getElementById("register-form").classList.add("hidden");
        document
          .getElementById("password-reset-container")
          .classList.remove("hidden");
        document
          .getElementById("request-reset-form")
          .classList.remove("hidden");
        document.getElementById("update-password-form").classList.add("hidden");
        document.getElementById("auth-error").textContent = "";
      }

      function backToLogin() {
        document.getElementById("auth-tabs").classList.remove("hidden");
        document
          .getElementById("password-reset-container")
          .classList.add("hidden");
        switchAuthTab("login");
      }

      // =================================================================
      // DATA MIGRATION & LOADING FUNCTIONS
      // =================================================================

      async function migrateDataToSupabase() {
        if (localStorage.getItem("supabase_migrated") === "true") {
          return;
        }
        console.log(
          "Starte einmalige Datenmigration von localStorage nach Supabase..."
        );
        const oldFlightsJson = localStorage.getItem("flightLog");
        const oldFlights = oldFlightsJson ? JSON.parse(oldFlightsJson) : [];
        if (oldFlights.length > 0) {
          const flightsToInsert = oldFlights.map((flight) => {
            return {
              flight_id: flight.id,
              date: flight.date,
              departure: flight.departure,
              arrival: flight.arrival,
              distance: flight.distance,
              time: flight.time,
              class: flight.class,
              flightNumber: flight.flightNumber,
              aircraftType: flight.aircraftType,
              notes: flight.notes,
              depLat: flight.depLat,
              depLon: flight.depLon,
              arrLat: flight.arrLat,
              arrLon: flight.arrLon,
              depName: flight.depName,
              arrName: flight.arrName,
              flightLogNumber: flight.flightLogNumber,
            };
          });
          const { error } = await supabaseClient
            .from("flights")
            .insert(flightsToInsert);
          if (error) {
            console.error("Fehler bei der Migration:", error);
            showMessage(
              "Migrations-Fehler",
              "Daten konnten nicht zu Supabase migriert werden.",
              "error"
            );
          } else {
            console.log("Migration erfolgreich!");
            localStorage.setItem("supabase_migrated", "true");
          }
        } else {
          localStorage.setItem("supabase_migrated", "true");
        }
      }

      async function migrateAndLoadAirports() {
        if (localStorage.getItem("airports_migrated") !== "true") {
          console.log(
            "Starte einmalige Migration der Flugh√§fen von localStorage nach Supabase..."
          );
          const cachedAirportsJSON = localStorage.getItem("cachedAirports");
          const cachedAirports = cachedAirportsJSON
            ? JSON.parse(cachedAirportsJSON)
            : {};
          const airportsToInsert = Object.keys(cachedAirports).map((iata) => ({
            iata: iata,
            name: cachedAirports[iata].name,
            lat: cachedAirports[iata].lat,
            lon: cachedAirports[iata].lon,
          }));
          if (airportsToInsert.length > 0) {
            const { error } = await supabaseClient
              .from("airports")
              .insert(airportsToInsert);
            if (error) {
              console.error("Fehler bei der Flughafen-Migration:", error);
            } else {
              console.log("Flughafen-Migration erfolgreich!");
              localStorage.setItem("airports_migrated", "true");
              localStorage.removeItem("cachedAirports");
            }
          } else {
            localStorage.setItem("airports_migrated", "true");
          }
        }
        const { data, error } = await supabaseClient
          .from("airports")
          .select("*");
        if (error) {
          console.error("Fehler beim Laden der Flugh√§fen aus Supabase:", error);
          return;
        }
        // Wandle die geladenen Daten in das Format um, das 'airportData' erwartet
        data.forEach((airport) => {
          airportData[airport.iata] = {
            name: airport.name,
            lat: airport.lat,
            lon: airport.lon,
            city: airport.city, // KORREKTUR: Stadtinformation hinzuf√ºgen
          };
        });
        console.log(`${data.length} Flugh√§fen aus der Datenbank geladen.`);
      }

      async function claimExistingFlights() {
        if (localStorage.getItem("flights_claimed") === "true") {
          return;
        }
        const {
          data: { user },
        } = await supabaseClient.auth.getUser();
        if (user) {
          console.log(
            `Beanspruche bestehende Fl√ºge f√ºr Benutzer ${user.id}...`
          );
          const { error } = await supabaseClient
            .from("flights")
            .update({ user_id: user.id })
            .is("user_id", null);
          if (error) {
            console.error("Fehler beim Beanspruchen der Fl√ºge:", error);
          } else {
            console.log("Fl√ºge erfolgreich beansprucht!");
            localStorage.setItem("flights_claimed", "true");
          }
        }
      }

      async function getFlights() {
        const { data, error } = await supabaseClient
          .from("flights")
          .select("*");
        if (error) {
          console.error("Fehler beim Laden der Fl√ºge:", error);
          return [];
        }
        return data.map((flight) => ({ ...flight, id: flight.flight_id }));
      }

      // =================================================================
      // CORE APP & HELPER FUNCTIONS
      // =================================================================

      function toggleDarkMode() {
        document.documentElement.classList.toggle("dark");
        if (document.documentElement.classList.contains("dark")) {
          localStorage.setItem("theme", "dark");
        } else {
          localStorage.setItem("theme", "light");
        }
      }

      function showTab(tabName) {
        // Alle Inhalte verstecken
        document.getElementById("tab-content-stats").classList.add("hidden");
        document.getElementById("tab-content-charts").classList.add("hidden");
        document.getElementById("tab-content-logbook").classList.add("hidden");
        document
          .getElementById("tab-content-achievements")
          .classList.add("hidden");
        document.getElementById("tab-content-fluege").classList.add("hidden");
        document
          .getElementById("tab-content-neue-fluege")
          .classList.add("hidden");

        // Alle Buttons als inaktiv markieren
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("border-indigo-500", "text-indigo-600");
          btn.classList.add(
            "border-transparent",
            "text-gray-500",
            "hover:text-gray-700",
            "hover:border-gray-300"
          );
        });

        // Den ausgew√§hlten Tab und Button aktivieren
        const activeBtn = document.getElementById(`tab-btn-${tabName}`);
        const activeContent = document.getElementById(`tab-content-${tabName}`);
        if (activeBtn && activeContent) {
          activeContent.classList.remove("hidden");
          activeBtn.classList.add("border-indigo-500", "text-indigo-600");
          activeBtn.classList.remove(
            "border-transparent",
            "text-gray-500",
            "hover:text-gray-700",
            "hover:border-gray-300"
          );
        }

        // Wenn der Logbuch-Tab aktiviert wird, lade die Standardansicht
        if (tabName === "logbook") {
          renderLogbookView("aircraftType");
        }

        // Wenn der Errungenschaften-Tab aktiviert wird, lade die Ansicht
        if (tabName === "achievements") {
          updateAchievements();
        }
      }

      var findAirport = function (input) {
        const normalizedInput = input.trim().toUpperCase();
        if (normalizedInput.length === 3 && airportData[normalizedInput]) {
          return { code: normalizedInput, ...airportData[normalizedInput] };
        }
        for (const code in airportData) {
          if (airportData[code].name.toUpperCase().includes(normalizedInput)) {
            return { code: code, ...airportData[code] };
          }
        }
        return null;
      };

      var calculateDistance = function (lat1, lon1, lat2, lon2) {
        var R = 6371;
        var toRad = (d) => d * (Math.PI / 180);
        var dLat = toRad(lat2 - lat1);
        var dLon = toRad(lon2 - lon1);
        var a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      };

      var estimateFlightTime = function (distanceKm) {
        var hours = Math.floor(distanceKm / 850 + 0.5);
        var minutes = Math.round((distanceKm / 850 + 0.5 - hours) * 60);
        return `${hours} Std. ${minutes} Min.`;
      };

      async function uploadFlightPhotos(files) {
        if (!files || files.length === 0) {
          return [];
        }
        const photoUrls = [];
        for (const file of files) {
          const filePath = `public/${Date.now()}-${file.name}`;
          const { error: uploadError } = await supabaseClient.storage
            .from("flight-photos")
            .upload(filePath, file);
          if (uploadError) {
            console.error("Fehler beim Hochladen der Datei:", uploadError);
            showMessage(
              "Upload-Fehler",
              `Foto ${file.name} konnte nicht hochgeladen werden.`,
              "error"
            );
            continue;
          }
          const { data } = supabaseClient.storage
            .from("flight-photos")
            .getPublicUrl(filePath);
          if (data.publicUrl) {
            photoUrls.push(data.publicUrl);
          }
        }
        return photoUrls;
      }

      const cacheAndSaveAirport = async (airport) => {
        if (airport && !airportData[airport.code]) {
          airportData[airport.code] = {
            name: airport.name,
            lat: airport.lat,
            lon: airport.lon,
            city: airport.city,
          };
          const { error } = await supabaseClient.from("airports").upsert({
            iata: airport.code,
            name: airport.name,
            lat: airport.lat,
            lon: airport.lon,
            city: airport.city,
          });
          if (error) {
            console.error(
              "Fehler beim Speichern des neuen Flughafens in Supabase:",
              error
            );
          }
        }
      };

      var showMessage = function (title, message, type = "info") {
        const container = document.getElementById("toast-container");
        if (!container) return;
        const toast = document.createElement("div");
        let typeClass = "toast-info";
        if (type === "success") typeClass = "toast-success";
        if (type === "error") typeClass = "toast-error";
        toast.className = `toast ${typeClass}`;
        toast.innerHTML = `<strong class="block">${title}</strong> ${message}`;
        container.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 5000);
      };

      /**
       * Formatiert Wetterdaten f√ºr die Anzeige in einem Leaflet-Popup.
       * @param {object} weather - Das Wetter-Objekt von der API.
       * @returns {string} Ein formatierter HTML-String oder ein leerer String.
       */
      function formatWeatherForPopup(weather) {
        if (weather && typeof weather.temp !== "undefined") {
          return `<br><hr class="my-1">üå°Ô∏è ${weather.temp}¬∞C | üí® ${weather.wind_speed} km/h`;
        }
        return ""; // Gibt nichts zur√ºck, wenn keine Wetterdaten vorhanden sind
      }

      // =================================================================
      // Hier sind alle weiteren, vollst√§ndigen Funktionen
      // =================================================================

      /**
       * L√§dt die Version aus der package.json und zeigt sie in der App an.
       */
      async function displayAppVersion() {
        try {
          const response = await fetch("package.json");
          const data = await response.json();
          const versionElement = document.getElementById("app-version");
          if (versionElement && data.version) {
            versionElement.textContent = `v${data.version}`;
          }
        } catch (error) {
          console.error("Fehler beim Laden der Versionsnummer:", error);
        }
      }

      /**
       * Schaltet die Sichtbarkeit des Burger-Men√ºs um.
       */
      function toggleBurgerMenu() {
        const menu = document.getElementById("burger-menu");
        menu.classList.toggle("hidden");
      }

      /**
       * Berechnet und zeigt die Errungenschaften des Nutzers an.
       */
      async function updateAchievements() {
        const container = document.getElementById("achievements-container");
        container.innerHTML =
          '<p class="text-gray-500">Berechne Errungenschaften...</p>';

        const allFlights = await getFlights();
        if (allFlights.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500">Logge deinen ersten Flug, um Errungenschaften freizuschalten!</p>';
          return;
        }

        // 1. Aktuelle Statistiken berechnen
        const totalFlights = allFlights.length;
        const totalDistance = allFlights.reduce(
          (sum, flight) => sum + flight.distance,
          0
        );
        const totalMinutes = allFlights.reduce(
          (sum, flight) => sum + parseFlightTimeToMinutes(flight.time),
          0
        );
        const totalHours = totalMinutes / 60;

        // Einzigartige Flugh√§fen und l√§ngsten Flug berechnen
        const uniqueAirports = new Set(
          allFlights.flatMap((f) => [f.departure, f.arrival])
        );
        const longestFlightDistance = Math.max(
          ...allFlights.map((f) => f.distance)
        );

        let html = "";

        // 2. Alle definierten Errungenschaften durchgehen
        const allAchievementTypes = [
          { category: "flights", value: totalFlights, unit: "Fl√ºge" },
          { category: "distance", value: totalDistance, unit: "km" },
          { category: "time", value: totalHours, unit: "Std." },
          {
            category: "uniqueAirports",
            value: uniqueAirports.size,
            unit: "Flugh√§fen",
          },
          {
            category: "longestFlight",
            value: longestFlightDistance,
            unit: "km",
          },
        ];

        allAchievementTypes.forEach((type) => {
          achievements[type.category].forEach((achievement) => {
            const isUnlocked = type.value >= achievement.milestone;
            const progressPercent = Math.min(
              (type.value / achievement.milestone) * 100,
              100
            );

            html += `
                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg flex items-center gap-4 ${
                          isUnlocked ? "" : "opacity-40"
                        }">
                            <span class="text-3xl">${achievement.emoji}</span>
                            <div>
                                <h3 class="font-bold text-gray-800 dark:text-white">${
                                  achievement.title
                                }</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${
                                  achievement.description
                                }</p>
                                <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-2 mt-2">
                                    <div class="bg-indigo-500 h-2 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                                <p class="text-xs text-right text-gray-500 dark:text-gray-400 mt-1">${Math.round(
                                  type.value
                                ).toLocaleString(
                                  "de-DE"
                                )} / ${achievement.milestone.toLocaleString(
              "de-DE"
            )} ${type.unit}</p>
                            </div>
                        </div>
                    `;
          });
        });

        container.innerHTML = html;
      }

      /**
       * Ermittelt eine CSS-Farbklasse basierend auf der Flugnummer und den Errungenschaften.
       * @param {number} flightNumber - Die sequenzielle Flugnummer.
       * @returns {string} Die Tailwind-CSS-Klasse f√ºr die Hintergrundfarbe.
       */
      function getMilestoneColor(flightNumber) {
        // Wir durchsuchen die Errungenschaften von der h√∂chsten zur niedrigsten Stufe.
        const flightAchievements = [...achievements.flights].reverse();

        for (const achievement of flightAchievements) {
          if (flightNumber >= achievement.milestone) {
            // Weise Farben basierend auf dem Titel oder der Stufe zu
            switch (achievement.milestone) {
              case 1000:
                return "bg-purple-600"; // Meister
              case 750:
                return "bg-cyan-500"; // Diamant
              case 500:
                return "bg-amber-500"; // Legende
              case 250:
                return "bg-yellow-400"; // Gold
              case 150:
                return "bg-slate-400"; // Silber
              case 100:
                return "bg-rose-600";
              case 50:
                return "bg-orange-400"; // Globetrotter
              case 25:
                return "bg-amber-600"; // Bronze
              case 10:
                return "bg-teal-500";
              default:
                continue; // Pr√ºfe die n√§chste Stufe
            }
          }
        }
        // Standardfarbe, wenn kein besonderer Meilenstein erreicht wurde
        return "bg-indigo-600";
      }

      var calculateStatistics = function (flights) {
        var stats = {
          totalCount: flights.length,
          totalDistance: 0,
          airportUsage: {},
          frequentAirport: "-",
          // Neue Statistik-Properties
          longestFlight: null,
          shortestFlight: null,
          averageDistance: 0,
          aircraftUsage: {},
          frequentAircraft: "-",
          yearlyData: {},
          totalSpending: {}, // Objekt, um mehrere W√§hrungen zu speichern
          mostExpensiveFlight: null,
          leastExpensiveFlight: null,
        };

        if (flights.length === 0) return stats;

        flights.forEach(function (flight) {
          stats.totalDistance += flight.distance;

          // 1. L√§ngsten/k√ºrzesten Flug finden
          if (
            !stats.longestFlight ||
            flight.distance > stats.longestFlight.distance
          ) {
            stats.longestFlight = flight;
          }
          if (
            !stats.shortestFlight ||
            flight.distance < stats.shortestFlight.distance
          ) {
            stats.shortestFlight = flight;
          }

          // 2. Flugzeugtyp-Nutzung z√§hlen
          if (flight.aircraftType && flight.aircraftType.trim() !== "") {
            const type = flight.aircraftType.trim().toUpperCase();
            stats.aircraftUsage[type] = (stats.aircraftUsage[type] || 0) + 1;
          }

          // 3. Jahresdaten sammeln
          const year = flight.date.substring(0, 4);
          if (!stats.yearlyData[year]) {
            stats.yearlyData[year] = { count: 0, distance: 0 };
          }
          stats.yearlyData[year].count++;
          stats.yearlyData[year].distance += flight.distance;

          // Bestehende Logik
          stats.airportUsage[flight.departure] =
            (stats.airportUsage[flight.departure] || 0) + 1;
          stats.airportUsage[flight.arrival] =
            (stats.airportUsage[flight.arrival] || 0) + 1;

          // NEU: Kosten berechnen
          // Pr√ºfe, ob der Preis eine Zahl ist (inklusive 0)
          if (typeof flight.price === "number" && flight.currency) {
            //          if (flight.price > 0 && flight.currency) {
            const currency = flight.currency;
            // Gesamtausgaben pro W√§hrung summieren
            stats.totalSpending[currency] =
              (stats.totalSpending[currency] || 0) + flight.price;

            // Teuersten/g√ºnstigsten Flug finden (vereinfacht, vergleicht nur Preise ohne W√§hrungsumrechnung)
            if (
              !stats.mostExpensiveFlight ||
              flight.price > stats.mostExpensiveFlight.price
            ) {
              stats.mostExpensiveFlight = flight;
            }
            if (
              !stats.leastExpensiveFlight ||
              flight.price < stats.leastExpensiveFlight.price
            ) {
              stats.leastExpensiveFlight = flight;
            }
          }
        });

        // Berechnungen nach der Schleife
        stats.averageDistance = Math.round(
          stats.totalDistance / stats.totalCount
        );

        // H√§ufigsten Flughafen finden
        let maxCount = 0;
        for (var code in stats.airportUsage) {
          if (stats.airportUsage[code] > maxCount) {
            maxCount = stats.airportUsage[code];
            stats.frequentAirport = airportData[code]
              ? `${airportData[code].name} (${code})`
              : code;
          }
        }

        // H√§ufigsten Flugzeugtyp finden
        let maxAircraftCount = 0;
        for (var type in stats.aircraftUsage) {
          if (stats.aircraftUsage[type] > maxAircraftCount) {
            maxAircraftCount = stats.aircraftUsage[type];
            stats.frequentAircraft = `${type} (${maxAircraftCount}x)`;
          }
        }

        return stats;
      };

      var updateStatisticsDisplay = function (flights) {
        var stats = calculateStatistics(flights);

        // Bestehende Statistiken
        document.getElementById("stat-count").textContent =
          stats.totalCount.toLocaleString("de-DE");
        document.getElementById(
          "stat-distance"
        ).textContent = `${stats.totalDistance.toLocaleString("de-DE")} km`;
        document.getElementById("stat-frequent").textContent =
          stats.frequentAirport;

        // Neue Statistiken
        document.getElementById(
          "stat-avg-distance"
        ).textContent = `${stats.averageDistance.toLocaleString("de-DE")} km`;
        document.getElementById("stat-frequent-aircraft").textContent =
          stats.frequentAircraft;

        if (stats.longestFlight) {
          document.getElementById("stat-longest-flight").textContent = `${
            stats.longestFlight.departure
          } ‚Üí ${
            stats.longestFlight.arrival
          } (${stats.longestFlight.distance.toLocaleString("de-DE")} km)`;
        } else {
          document.getElementById("stat-longest-flight").textContent = "-";
        }

        if (stats.shortestFlight) {
          document.getElementById("stat-shortest-flight").textContent = `${
            stats.shortestFlight.departure
          } ‚Üí ${
            stats.shortestFlight.arrival
          } (${stats.shortestFlight.distance.toLocaleString("de-DE")} km)`;
        } else {
          document.getElementById("stat-shortest-flight").textContent = "-";
        }

        // NEU: Kosten-Statistiken anzeigen
        const spendingText =
          Object.keys(stats.totalSpending)
            .map(
              (currency) =>
                `${stats.totalSpending[currency].toLocaleString("de-DE", {
                  style: "currency",
                  currency: currency,
                  minimumFractionDigits: 0,
                  maximumFractionDigits: 0,
                })}`
            )
            .join(" | ") || "-";
        document.getElementById("stat-total-spending").textContent =
          spendingText;

        if (stats.mostExpensiveFlight) {
          document.getElementById("stat-most-expensive").textContent = `${
            stats.mostExpensiveFlight.departure
          } ‚Üí ${
            stats.mostExpensiveFlight.arrival
          } (${stats.mostExpensiveFlight.price.toLocaleString("de-DE")} ${
            stats.mostExpensiveFlight.currency
          })`;
        } else {
          document.getElementById("stat-most-expensive").textContent = "-";
        }

        if (stats.leastExpensiveFlight) {
          document.getElementById("stat-least-expensive").textContent = `${
            stats.leastExpensiveFlight.departure
          } ‚Üí ${
            stats.leastExpensiveFlight.arrival
          } (${stats.leastExpensiveFlight.price.toLocaleString("de-DE")} ${
            stats.leastExpensiveFlight.currency
          })`;
        } else {
          document.getElementById("stat-least-expensive").textContent = "-";
        }

        // Logik f√ºr die Jahreszusammenfassung
        const yearSelect = document.getElementById("stat-year-select");
        const yearlySummary = document.getElementById("stat-yearly-summary");
        yearSelect.innerHTML = ""; // Dropdown leeren

        const years = Object.keys(stats.yearlyData).sort((a, b) => b - a); // Jahre absteigend sortieren

        if (years.length > 0) {
          years.forEach((year) => {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
          });

          const updateYearlyDisplay = (year) => {
            const data = stats.yearlyData[year];
            yearlySummary.textContent = `${
              data.count
            } Fl√ºge | ${data.distance.toLocaleString("de-DE")} km`;
          };

          yearSelect.onchange = (event) => {
            updateYearlyDisplay(event.target.value);
          };

          // Initialen Wert f√ºr das aktuellste Jahr anzeigen
          updateYearlyDisplay(years[0]);
          yearSelect.style.display = "inline-block";
        } else {
          yearlySummary.textContent = "Keine Jahresdaten verf√ºgbar.";
          yearSelect.style.display = "none";
        }
      };

      /**
         * Ruft Flugdaten per Flugnummer und Datum ab und f√ºllt das Formular aus.
         */
        async function autofillFlightData() {
            const flightNumber = document.getElementById('auto-flight-number').value.replace(/\s/g, '').trim().toUpperCase();
            const flightDate = document.getElementById('auto-flight-date').value;

            if (!flightNumber || !flightDate) {
                showMessage('Fehler', 'Bitte Flugnummer UND Datum eingeben.', 'error');
                return;
            }

            const btn = document.getElementById('autofill-btn');
            btn.textContent = 'Suche...';
            btn.disabled = true;

            try {
                const response = await fetch(`https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-flight-by-number?flight_iata=${flightNumber}&date=${flightDate}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }

                const result = await response.json();

                // NEUE LOGIK: Pr√ºft beide m√∂glichen Antwort-Strukturen
                // 'result.data' f√ºr Standard- und Zukunftsfl√ºge
                // 'result.response.data' f√ºr Vergangenheitsfl√ºge
                const flightData = result.data || (result.response ? result.response.data : null);

                if (flightData && flightData.length > 0) {
                    const flight = flightData[0]; 
                    
                    document.getElementById('departure').value = flight.departure.iata_code;
                    document.getElementById('arrival').value = flight.arrival.iata_code;
                    document.getElementById('aircraftType').value = flight.aircraft.icao_code || '';
                    document.getElementById('flightNumber').value = flight.flight.iata_number;
                    document.getElementById('flightDate').value = flightDate; 

                    updateFlightDetails();
                    showMessage('Erfolg!', 'Flugdaten wurden erfolgreich geladen.', 'success');
                } else {
                    showMessage('Fehler', 'Keine Flugdaten f√ºr diese Kombination gefunden.', 'error');
                }
            } catch (error) {
                console.error("Fehler beim Abrufen der Flugdaten:", error);
                showMessage('Fehler', `Suche fehlgeschlagen: ${error.message}`, 'error');
            } finally {
                btn.textContent = 'Daten abrufen';
                btn.disabled = false;
            }
        }
		
	  
	  /**
       * Eine Hilfsfunktion, die einen Flugzeit-String (z.B. "3 Std. 45 Min.") in Minuten umwandelt.
       * @param {string} timeString - Der Flugzeit-String.
       * @returns {number} Die Gesamtflugzeit in Minuten.
       */
      function parseFlightTimeToMinutes(timeString) {
        if (!timeString || !timeString.includes("Std.")) return 0;
        const parts = timeString.match(/(\d+)\s*Std\.\s*(\d+)\s*Min\./);
        if (parts && parts.length === 3) {
          return parseInt(parts[1]) * 60 + parseInt(parts[2]);
        }
        return 0;
      }

      /**
       * Gruppiert Fl√ºge nach einem bestimmten Kriterium und zeigt sie im Logbuch-Tab an.
       * @param {'aircraftType' | 'airline' | 'airport'} groupBy - Das Kriterium f√ºr die Gruppierung.
       */
      async function renderLogbookView(groupBy) {
        const contentContainer = document.getElementById("logbook-content");
        contentContainer.innerHTML =
          '<p class="text-gray-500">Lade Logbuch-Daten...</p>';

        const allFlights = await getFlights();
        const grouped = {};

        // 1. Fl√ºge nach dem gew√§hlten Kriterium gruppieren
        allFlights.forEach((flight) => {
          let keys = [];

          if (groupBy === "aircraftType") {
            const type = (flight.aircraftType || "Unbekannt")
              .trim()
              .toUpperCase();
            keys.push(type === "" ? "Unbekannt" : type);
          } else if (groupBy === "airline") {
            // Extrahiert den Airline-Code aus der Flugnummer (z.B. "LH" aus "LH404")
            const match = flight.flightNumber
              ? flight.flightNumber.match(/^[A-Z0-9]{2,3}/)
              : null;
            const airline = match ? match[0].toUpperCase() : "Unbekannt";
            keys.push(airline);
          } else if (groupBy === "airport") {
            // F√ºgt den Flug sowohl zur Start- als auch zur Zielflughafen-Gruppe hinzu
            if (flight.departure) keys.push(flight.departure.toUpperCase());
            if (flight.arrival) keys.push(flight.arrival.toUpperCase());
          }

          keys.forEach((key) => {
            if (!grouped[key]) {
              grouped[key] = { flights: [], totalDistance: 0, count: 0 };
            }
            grouped[key].flights.push(flight);
            grouped[key].totalDistance += flight.distance;
            grouped[key].count++;
          });
        });

        // 2. HTML generieren und anzeigen
        contentContainer.innerHTML = "";
        const sortedKeys = Object.keys(grouped).sort();

        if (sortedKeys.length === 0) {
          contentContainer.innerHTML =
            '<p class="text-gray-500">Keine Daten f√ºr diese Ansicht verf√ºgbar.</p>';
          return;
        }

        sortedKeys.forEach((key) => {
          const group = grouped[key];
          const detailsElement = document.createElement("details");
          detailsElement.className =
            "bg-gray-50 dark:bg-gray-700 p-4 rounded-lg";

          const summaryElement = document.createElement("summary");
          summaryElement.className =
            "font-semibold text-lg cursor-pointer text-indigo-700 dark:text-indigo-400";
          summaryElement.innerHTML = `
                    ${key} 
                    <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-2">
                        (${
                          group.count
                        } Fl√ºge / ${group.totalDistance.toLocaleString(
            "de-DE"
          )} km)
                    </span>
                `;

          const flightListDiv = document.createElement("div");
          flightListDiv.className =
            "mt-4 space-y-2 border-t border-gray-200 dark:border-gray-600 pt-4";

          group.flights
            .sort((a, b) => new Date(a.date) - new Date(b.date))
            .forEach((flight) => {
              flightListDiv.innerHTML += `
                        <div class="text-sm text-gray-700 dark:text-gray-300">
                            <span class="font-semibold">${flight.date}:</span> 
                            ${flight.departure} ‚Üí ${flight.arrival} 
                            <span class="text-xs text-gray-500">(${flight.distance.toLocaleString(
                              "de-DE"
                            )} km)</span>
                        </div>
                    `;
            });

          detailsElement.appendChild(summaryElement);
          detailsElement.appendChild(flightListDiv);
          contentContainer.appendChild(detailsElement);
        });

        // 3. UI f√ºr die Buttons aktualisieren (KORRIGIERTE LOGIK)
        document
          .querySelectorAll(".logbook-view-btn")
          .forEach((btn) => btn.classList.remove("active"));
        let buttonIdFragment = groupBy;
        if (groupBy === "aircraftType") {
          buttonIdFragment = "aircraft"; // Spezifische Anpassung f√ºr den Button
        }
        const activeButton = document.getElementById(
          `logbook-view-${buttonIdFragment}`
        );
        if (activeButton) {
          activeButton.classList.add("active");
        }
      }

      /**
       * Setzt den Zeitraum f√ºr die Charts und l√∂st eine Aktualisierung aus.
       * @param {'year' | 'month'} timeframe
       */
      async function setChartTimeframe(timeframe) {
        currentChartTimeframe = timeframe; // Neuen Zeitraum speichern
        const flights = await getFlights(); // Immer die kompletten, aktuellen Daten laden
        updateCharts(flights, currentChartTimeframe); // Charts mit den neuen Daten und dem neuen Zeitraum aktualisieren
      }

      /**
       * Zeichnet alle Diagramme basierend auf den aufbereiteten Daten.
       * Zerst√∂rt alte Diagramme, bevor neue gezeichnet werden.
       * @param {Array<string>} labels - Die Labels f√ºr die X-Achse (z.B. ['2024', '2025']).
       * @param {Array<number>} flightsData - Die Daten f√ºr die Anzahl der Fl√ºge.
       * @param {Array<number>} distanceData - Die Daten f√ºr die Distanz.
       * @param {Array<number>} timeData - Die Daten f√ºr die Flugzeit in Minuten.
       */
      function renderAllCharts(labels, flightsData, distanceData, timeData) {
        // Alte Chart-Instanzen zerst√∂ren, falls vorhanden
        if (flightsChartInstance) flightsChartInstance.destroy();
        if (distanceChartInstance) distanceChartInstance.destroy();
        if (timeChartInstance) timeChartInstance.destroy();

        const isDarkMode = document.documentElement.classList.contains("dark");
        const gridColor = isDarkMode
          ? "rgba(255, 255, 255, 0.1)"
          : "rgba(0, 0, 0, 0.1)";
        const labelColor = isDarkMode ? "#d1d5db" : "#374151";

        // 1. Fl√ºge pro Zeitraum (Balkendiagramm)
        flightsChartInstance = new Chart(
          document.getElementById("flightsChart"),
          {
            type: "bar",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Anzahl der Fl√ºge",
                  data: flightsData,
                  backgroundColor: "rgba(79, 70, 229, 0.8)",
                  borderColor: "rgba(79, 70, 229, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: labelColor },
                  grid: { color: gridColor },
                },
                x: { ticks: { color: labelColor }, grid: { color: gridColor } },
              },
            },
          }
        );

        // 2. Distanz pro Zeitraum (Liniendiagramm)
        distanceChartInstance = new Chart(
          document.getElementById("distanceChart"),
          {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Gesamtdistanz (km)",
                  data: distanceData,
                  fill: false,
                  borderColor: "rgba(22, 163, 74, 1)",
                  tension: 0.1,
                },
              ],
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: labelColor },
                  grid: { color: gridColor },
                },
                x: { ticks: { color: labelColor }, grid: { color: gridColor } },
              },
            },
          }
        );

        // 3. Flugzeit pro Zeitraum (Liniendiagramm)
        timeChartInstance = new Chart(document.getElementById("timeChart"), {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Gesamtflugzeit",
                data: timeData,
                fill: false,
                borderColor: "rgba(219, 39, 119, 1)",
                tension: 0.1,
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: labelColor },
                grid: { color: gridColor },
              },
              x: { ticks: { color: labelColor }, grid: { color: gridColor } },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || "";
                    if (label) label += ": ";
                    const totalMinutes = context.parsed.y;
                    const hours = Math.floor(totalMinutes / 60);
                    const minutes = totalMinutes % 60;
                    return `${label}${hours} Std. ${minutes} Min.`;
                  },
                },
              },
            },
          },
        });
      }

      /**
       * Hauptfunktion zum Aufbereiten der Flugdaten und Aktualisieren der Charts.
       * @param {Array<Object>} allFlights - Das Array mit allen Flug-Objekten.
       * @param {string} timeframe - Entweder 'year' oder 'month'.
       */
      function updateCharts(allFlights, timeframe = "year") {
        // Zeile entfernt: const allFlights = getFlights();

        if (!allFlights || allFlights.length === 0) {
          // Optional: Verstecke oder leere die Charts, wenn keine Daten da sind
          if (flightsChartInstance) flightsChartInstance.destroy();
          if (distanceChartInstance) distanceChartInstance.destroy();
          if (timeChartInstance) timeChartInstance.destroy();
          return;
        }

        const aggregatedData = {};

        allFlights.forEach((flight) => {
          const key =
            timeframe === "year"
              ? flight.date.substring(0, 4)
              : flight.date.substring(0, 7);
          if (!aggregatedData[key]) {
            aggregatedData[key] = { count: 0, distance: 0, time: 0 };
          }
          aggregatedData[key].count++;
          aggregatedData[key].distance += flight.distance;
          aggregatedData[key].time += parseFlightTimeToMinutes(flight.time);
        });

        const sortedLabels = Object.keys(aggregatedData).sort();

        const flightsData = sortedLabels.map(
          (label) => aggregatedData[label].count
        );
        const distanceData = sortedLabels.map(
          (label) => aggregatedData[label].distance
        );
        const timeData = sortedLabels.map(
          (label) => aggregatedData[label].time
        );

        renderAllCharts(sortedLabels, flightsData, distanceData, timeData);

        document
          .getElementById("chart-view-year")
          .classList.toggle("active", timeframe === "year");
        document
          .getElementById("chart-view-month")
          .classList.toggle("active", timeframe === "month");
      }

      window.exportData = async function (format) {
        // 'async' hinzugef√ºgt
        var flights = await getFlights(); // 'await' hinzugef√ºgt
        var stats = calculateStatistics(flights);
        var filename = `flugbuch_export_${new Date()
          .toISOString()
          .slice(0, 10)}`;
        var data, mimeType;
        if (flights.length === 0) {
          showMessage(
            "Export Fehler",
            "Keine Daten zum Exportieren vorhanden.",
            "error"
          );
          return;
        }
        if (format === "json") {
          var exportObj = {
            metadata: {
              totalFlights: stats.totalCount,
              totalDistanceKm: stats.totalDistance,
              totalFlightTime: stats.totalTimeString,
              frequentAirport: stats.frequentAirport,
            },
            flights: flights,
          };
          data = JSON.stringify(exportObj, null, 2);
          mimeType = "application/json";
          filename += ".json";
        } else if (format === "csv") {
          var separator = ";";
          var statsRows = [
            ["Statistik", "Wert"],
            ["Gesamte Fl√ºge", stats.totalCount],
            ["Gesamtdistanz (km)", stats.totalDistance],
            ["Gesch. Gesamtflugzeit", stats.totalTimeString],
            ["H√§ufigster Flughafen", stats.frequentAirport],
          ]
            .map(function (row) {
              return row.join(separator);
            })
            .join("\n");
          statsRows += "\n\n";
          var flightKeys = [
            "id",
            "date",
            "departure",
            "arrival",
            "distance",
            "time",
            "class",
            "flightNumber",
            "aircraftType",
            "notes",
          ];
          var headers = flightKeys.join(separator);
          var csvRows = flights
            .map(function (flight) {
              return flightKeys
                .map(function (key) {
                  var value =
                    flight[key] !== undefined && flight[key] !== null
                      ? "" + flight[key]
                      : "";
                  if (key === "id") {
                    value = "'" + value.replace(/\..*/, "");
                  }
                  return '"' + value.replace(/"/g, '""') + '"';
                })
                .join(separator);
            })
            .join("\n");
          data = "\uFEFF" + statsRows + headers + "\n" + csvRows;
          mimeType = "text/csv;charset=utf-8;";
          filename += ".csv";
        } else {
          return;
        }

        var blob = new Blob([data], { type: mimeType });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showMessage(
          "Export erfolgreich",
          `Daten wurden als "${filename}" exportiert.`,
          "success"
        );
      };

      // *** Autocomplete-Logik ***
      async function updateAutocompleteList(inputId, listId) {
        const input = document.getElementById(inputId);
        const list = document.getElementById(listId);
        const value = input.value.trim();
        list.innerHTML = "";

        if (value.length < 3) {
          list.classList.add("hidden");
          return;
        }

        const upperCaseValue = value.toUpperCase();
        let matches = [];

        // 1. Lokale Suche (schnell)
        for (const code in airportData) {
          const airport = airportData[code];
          if (
            code.includes(upperCaseValue) ||
            airport.name.toUpperCase().includes(upperCaseValue)
          ) {
            matches.push({ code, ...airport });
          }
        }

        // 2. Externe API-Suche (langsamer)
        const apiResults = await window.fetchExternalAirport(value);

        // 3. Ergebnisse zusammenf√ºhren und Duplikate entfernen
        if (apiResults && apiResults.length > 0) {
          const existingCodes = new Set(matches.map((m) => m.code));
          apiResults.forEach((result) => {
            if (!existingCodes.has(result.code)) {
              matches.push(result);
            }
          });
        }

        // 4. Ergebnisse alphabetisch sortieren
        matches.sort((a, b) => a.name.localeCompare(b.name));

        // 5. Ergebnisse anzeigen
        if (matches.length > 0) {
          matches.slice(0, 10).forEach((match) => {
            // Begrenze auf 10 Ergebnisse zur √úbersicht
            const item = document.createElement("div");
            item.className =
              "p-2 cursor-pointer text-gray-700 dark:text-gray-300 autocomplete-item";
            item.textContent = `${match.name} (${match.code})`;
            item.addEventListener("click", () => {
              selectAutocompleteItem(input, list, match); // √úbergib das komplette Objekt
            });
            list.appendChild(item);
          });
          list.classList.remove("hidden");
        } else {
          list.classList.add("hidden");
        }
      }

      var hideAllAutocompleteLists = function () {
        document.getElementById("departure-list").classList.add("hidden");
        document.getElementById("arrival-list").classList.add("hidden");
      };

      function selectAutocompleteItem(input, list, selectedAirport) {
        // Stelle sicher, dass die Stadtinformation an die Speicherfunktion √ºbergeben wird
        cacheAndSaveAirport({
          code: selectedAirport.code,
          name: selectedAirport.name,
          lat: selectedAirport.lat,
          lon: selectedAirport.lon,
          city: selectedAirport.city, // KORREKTUR: Stadtinformation hinzuf√ºgen
        });

        input.value = selectedAirport.code;
        list.classList.add("hidden");
        updateFlightDetails();
        input.focus();
      }

      var updateFlightDetails = function () {
        var departureInput = document.getElementById("departure").value;
        var arrivalInput = document.getElementById("arrival").value;
        var departureAirport = findAirport(departureInput);
        var arrivalAirport = findAirport(arrivalInput);
        var distanceDisplay = document.getElementById("distance-display");
        var timeDisplay = document.getElementById("time-display");
        var logButton = document.getElementById("log-button");
        distanceDisplay.textContent = "-";
        timeDisplay.textContent = "-";
        logButton.disabled = true;
        if (departureAirport && arrivalAirport) {
          var distance = calculateDistance(
            departureAirport.lat,
            departureAirport.lon,
            arrivalAirport.lat,
            arrivalAirport.lon
          );
          var formattedDistance = `${Math.round(distance).toLocaleString(
            "de-DE"
          )} km`;
          var estimatedTime = estimateFlightTime(distance);
          distanceDisplay.textContent = formattedDistance;
          timeDisplay.textContent = estimatedTime;
          logButton.disabled = false;
        } else {
          // Erm√∂glicht das Loggen, wenn es sich um einen 3-stelligen Code handelt (f√ºr API-Fallback)
          if (
            departureInput.trim().length === 3 &&
            arrivalInput.trim().length === 3
          ) {
            logButton.disabled = false;
            distanceDisplay.textContent = "Berechnung nach API-Abruf";
            timeDisplay.textContent = "Beim Loggen...";
          }
        }
      };

      /**
       * Setzt das Formular zur√ºck und beendet den Bearbeitungsmodus.
       */
      window.resetForm = function () {
        // Formularfelder leeren
        document.getElementById("departure").value = "";
        document.getElementById("arrival").value = "";
        document.getElementById("flightDate").value = "";
        document.getElementById("flightNumber").value = "";
        document.getElementById("aircraftType").value = "";
        document.getElementById("notes").value = "";
        document.getElementById("price").value = "";
        document.getElementById("currency").value = "";

        // Foto-Feld und Vorschau zur√ºcksetzen
        document.getElementById("flightPhoto").value = null;
        document
          .getElementById("photo-preview-container")
          .classList.add("hidden");
        document.getElementById("photo-preview-text").textContent = "";

        // Zustand zur√ºcksetzen
        currentlyEditingFlightData = null;

        // UI zur√ºcksetzen
        const logButton = document.getElementById("log-button");
        logButton.textContent = "Flug loggen und speichern";
        document.getElementById("cancel-edit-button").classList.add("hidden");

        updateFlightDetails(); // Setzt Distanz etc. zur√ºck und deaktiviert den Button
      };

      /**
       * Startet den Bearbeitungsmodus f√ºr einen bestimmten Flug.
       * @param {number} id - Die ID des zu bearbeitenden Flugs.
       */
      window.editFlight = async function (id) {
        showTab("neue-fluege"); // Wechsle zum Formular-Tab
        // Wenn die Gesamtansicht aktiv ist, schalte sie zuerst aus
        if (isAllRoutesViewActive) {
          toggleAllRoutesView();
        }
        const flights = await getFlights();
        const flightToEdit = flights.find((flight) => flight.id === id);

        if (!flightToEdit) {
          showMessage(
            "Fehler",
            "Der zu bearbeitende Flug wurde nicht gefunden.",
            "error"
          );
          return;
        }

        const previewContainer = document.getElementById(
          "photo-preview-container"
        );
        const previewText = document.getElementById("photo-preview-text");
        if (flightToEdit.photo_url && flightToEdit.photo_url.length > 0) {
          previewText.textContent = `Bereits ${flightToEdit.photo_url.length} Foto(s) zu diesem Flug gespeichert.`;
          previewContainer.classList.remove("hidden");
        } else {
          previewContainer.classList.add("hidden");
        }

        // Zeichne die Route des aktuell ausgew√§hlten Flugs auf der Karte
        window.drawRouteOnMap(
          flightToEdit.depLat,
          flightToEdit.depLon,
          flightToEdit.arrLat,
          flightToEdit.arrLon,
          flightToEdit.departure,
          flightToEdit.arrival,
          flightToEdit.depName,
          flightToEdit.arrName
        );

        // Formular mit den Flugdaten f√ºllen
        document.getElementById("departure").value = flightToEdit.departure;
        document.getElementById("arrival").value = flightToEdit.arrival;
        document.getElementById("flightDate").value = flightToEdit.date;
        document.getElementById("flightClass").value = flightToEdit.class;
        document.getElementById("flightNumber").value =
          flightToEdit.flightNumber;
        document.getElementById("aircraftType").value =
          flightToEdit.aircraftType;
        document.getElementById("notes").value = flightToEdit.notes;
        document.getElementById("price").value =
          typeof flightToEdit.price === "number" ? flightToEdit.price : "";
        document.getElementById("currency").value = flightToEdit.currency || "";

        // Bearbeitungszustand setzen
        currentlyEditingFlightData = flightToEdit;

        // UI f√ºr den Bearbeitungsmodus anpassen
        const logButton = document.getElementById("log-button");
        logButton.textContent = "√Ñnderungen speichern";
        document
          .getElementById("cancel-edit-button")
          .classList.remove("hidden");

        updateFlightDetails(); // Berechnet Distanz/Zeit f√ºr die geladenen Flugh√§fen

        // Zum Formular scrollen f√ºr eine bessere User Experience
        document
          .getElementById("log-button")
          .scrollIntoView({ behavior: "smooth", block: "center" });
      };

      /**
       * Schaltet die Kartenansicht zwischen dem letzten Flug und allen Fl√ºgen um.
       */
      window.toggleAllRoutesView = async function () {
        isAllRoutesViewActive = !isAllRoutesViewActive; // Zustand umkehren
        const btn = document.getElementById("toggle-map-view-btn");

        if (isAllRoutesViewActive) {
          // Zur Gesamtansicht wechseln
          let allFlights = await getFlights();
          allFlights = resequenceAndAssignNumbers(allFlights);

          drawAllRoutesOnMap(allFlights);
          btn.textContent = "Einzelansicht zeigen";
        } else {
          // Zur√ºck zur Einzelansicht wechseln
          renderFlights(); // Stellt den Standardzustand wieder her
          btn.textContent = "Alle Routen zeigen";
        }
      };

      /**
       * Zeichnet alle Flugrouten UND Flughafen-Marker auf die Karte,
       * und gruppiert dabei identische Routen.
       * @param {Array<Object>} flights - Ein Array mit allen Flug-Objekten.
       */
      window.drawAllRoutesOnMap = function (flights) {
        const mapInfo = document.getElementById("map-info");
        routeLayer.clearLayers();

        if (!flights || flights.length === 0) {
          mapInfo.textContent =
            "Keine Fl√ºge vorhanden, um eine Gesamt√ºbersicht zu zeigen.";
          map.setView([20, 0], 2);
          return;
        }

        const routeGroups = {};
        // Ein Objekt, um alle einzigartigen Flugh√§fen zu sammeln
        const uniqueAirports = {};

        // Alle Fl√ºge durchgehen, um Routen zu gruppieren UND Flugh√§fen zu sammeln
        flights.forEach((flight) => {
          if (flight.depLat && flight.arrLat) {
            // --- Routen gruppieren (wie bisher) ---
            const routeKey = [flight.departure, flight.arrival]
              .sort()
              .join("-");
            if (!routeGroups[routeKey]) {
              routeGroups[routeKey] = {
                latLngs: [
                  [flight.depLat, flight.depLon],
                  [flight.arrLat, flight.arrLon],
                ],
                flightNumbers: [],
              };
            }
            routeGroups[routeKey].flightNumbers.push(flight.flightLogNumber);

            // --- Einzigartige Flugh√§fen sammeln ---
            if (!uniqueAirports[flight.departure]) {
              uniqueAirports[flight.departure] = {
                name: flight.depName,
                lat: flight.depLat,
                lon: flight.depLon,
              };
            }
            if (!uniqueAirports[flight.arrival]) {
              uniqueAirports[flight.arrival] = {
                name: flight.arrName,
                lat: flight.arrLat,
                lon: flight.arrLon,
              };
            }
          }
        });

        const bounds = [];

        // 1. Linien f√ºr die gruppierten Routen zeichnen
        Object.values(routeGroups).forEach((group) => {
          const flightCount = group.flightNumbers.length;

          // Wir berechnen die Linienst√§rke. Basis = 1.5, +0.5 f√ºr jeden weiteren Flug auf der Route.
          // Mit Math.min begrenzen wir die maximale Dicke auf einen sinnvollen Wert (z.B. 8).
          const weight = Math.min(1.5 + (flightCount - 1) * 0.5, 8);
          const opacity = 0.6 + flightCount * 0.05; // Linien werden auch etwas deckender

          const flightPath = L.polyline(group.latLngs, {
            color: "#312E81",
            weight: weight, // Dynamische St√§rke
            opacity: opacity, // Dynamische Deckkraft
          });
          const labelText = group.flightNumbers
            .sort((a, b) => a - b)
            .map((n) => `#${n}`)
            .join(", ");
          flightPath.bindTooltip(labelText, {
            permanent: true,
            direction: "center",
            className: "flight-number-label",
          });
          flightPath.addTo(routeLayer);
          bounds.push(group.latLngs[0]);
          bounds.push(group.latLngs[1]);
        });

        // 2. Marker f√ºr alle einzigartigen Flugh√§fen zeichnen
        Object.keys(uniqueAirports).forEach((iataCode) => {
          const airport = uniqueAirports[iataCode];
          const marker = L.marker([airport.lat, airport.lon]);
          marker.bindPopup(`<b>${airport.name}</b> (${iataCode})`);
          marker.addTo(routeLayer);
        });

        if (bounds.length > 0) {
          map.fitBounds(bounds, { padding: [40, 40] });
        }

        mapInfo.textContent = `Gesamt√ºbersicht: ${
          Object.keys(routeGroups).length
        } einzigartige Routen werden angezeigt.`;
      };

      // *** Hauptfunktion (jetzt f√ºr Loggen & Aktualisieren) ***
      window.logFlight = async function () {
        if (currentlyEditingFlightData !== null) {
          await updateFlight();
          return;
        }

        const logButton = document.getElementById("log-button");
        logButton.textContent = "Speichere...";
        logButton.disabled = true;

        const {
          data: { user },
        } = await supabaseClient.auth.getUser();
        if (!user) {
          showMessage("Fehler", "Nicht eingeloggt. Bitte neu laden.", "error");
          logButton.disabled = false;
          return;
        }

        const photoFiles = document.getElementById("flightPhoto").files;
        const photoUrls = await uploadFlightPhotos(photoFiles);

        const depCodeInput = document
          .getElementById("departure")
          .value.trim()
          .toUpperCase();
        const arrCodeInput = document
          .getElementById("arrival")
          .value.trim()
          .toUpperCase();
        let departureAirport =
          findAirport(depCodeInput) ||
          (await window.fetchExternalAirport(depCodeInput));
        let arrivalAirport =
          findAirport(arrCodeInput) ||
          (await window.fetchExternalAirport(arrCodeInput));

        if (!departureAirport || !arrivalAirport) {
          showMessage(
            "Fehler",
            "Mindestens ein Flughafen-Code wurde nicht gefunden.",
            "error"
          );
          logButton.textContent = "Flug loggen und speichern";
          logButton.disabled = false;
          return;
        }

        await cacheAndSaveAirport(departureAirport);
        await cacheAndSaveAirport(arrivalAirport);

        const distance = calculateDistance(
          departureAirport.lat,
          departureAirport.lon,
          arrivalAirport.lat,
          arrivalAirport.lon
        );
        const newFlightId = new Date().getTime();

        // KORREKTE LOGIK F√úR PREIS
        const priceInput = document.getElementById("price").value;

        const newFlightForSupabase = {
          flight_id: newFlightId,
          user_id: user.id,
          date:
            document.getElementById("flightDate").value ||
            new Date().toISOString().slice(0, 10),
          departure: departureAirport.code,
          arrival: arrivalAirport.code,
          distance: Math.round(distance),
          time: estimateFlightTime(distance),
          class: document.getElementById("flightClass").value,
          flightNumber: document.getElementById("flightNumber").value.trim(),
          aircraftType: document.getElementById("aircraftType").value.trim(),
          notes: document.getElementById("notes").value.trim(),
          depLat: departureAirport.lat,
          depLon: departureAirport.lon,
          arrLat: arrivalAirport.lat,
          arrLon: arrivalAirport.lon,
          depName: departureAirport.name,
          arrName: arrivalAirport.name,
          photo_url: photoUrls,
          price:
            priceInput !== "" && !isNaN(parseFloat(priceInput))
              ? parseFloat(priceInput)
              : null,
          currency:
            document.getElementById("currency").value.trim().toUpperCase() ||
            null,
        };

        const { error } = await supabaseClient
          .from("flights")
          .insert(newFlightForSupabase);

        if (error) {
          showMessage(
            "Speicherfehler",
            "Der Flug konnte nicht in der Datenbank gespeichert werden.",
            "error"
          );
          console.error("Supabase Insert Error:", error);
        } else {
          showMessage(
            "Erfolg!",
            `Flug von ${departureAirport.name} nach ${arrivalAirport.name} erfolgreich geloggt.`,
            "success"
          );
          resetForm();
          renderFlights(null, newFlightId);
        }
        logButton.textContent = "Flug loggen und speichern";
        logButton.disabled = true;
      };

      /**
       * Aktualisiert die Paginierungs-UI (Button-Zust√§nde, Seitenzahlanzeige).
       * @param {Array<Object>} allFlights - Das komplette, ungefilterte Array aller Fl√ºge.
       */
      function updatePaginationUI(allFlights) {
        const pageInfo = document.getElementById("page-info");
        const prevBtn = document.getElementById("prev-page-btn");
        const nextBtn = document.getElementById("next-page-btn");
        const paginationControls = document.getElementById(
          "pagination-controls"
        );

        const totalPages = Math.ceil(allFlights.length / ITEMS_PER_PAGE);

        if (totalPages <= 1) {
          paginationControls.style.display = "none"; // Verstecke Steuerung, wenn nicht ben√∂tigt
          return;
        }

        paginationControls.style.display = "flex";
        pageInfo.textContent = `Seite ${currentPage} von ${totalPages}`;
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
      }

      /**
       * Wechselt zur n√§chsten Seite.
       */
      function nextPage() {
        renderFlights(null, null, currentPage + 1);
      }

      /**
       * Wechselt zur vorherigen Seite.
       */
      function prevPage() {
        renderFlights(null, null, currentPage - 1);
      }

      /**
       * Speichert die √Ñnderungen eines bestehenden Fluges in Supabase.
       */
      async function updateFlight() {
        const logButton = document.getElementById("log-button");
        logButton.textContent = "Aktualisiere...";
        logButton.disabled = true;

        let photoUrls = currentlyEditingFlightData.photo_url || [];
        const newPhotoFiles = document.getElementById("flightPhoto").files;

        if (newPhotoFiles.length > 0) {
          if (photoUrls && photoUrls.length > 0) {
            const oldFilePaths = photoUrls.map((url) =>
              url.substring(url.lastIndexOf("public/") + 7)
            );
            await supabaseClient.storage
              .from("flight-photos")
              .remove(oldFilePaths);
          }
          photoUrls = await uploadFlightPhotos(newPhotoFiles);
        }

        const depCodeInput = document
          .getElementById("departure")
          .value.trim()
          .toUpperCase();
        const arrCodeInput = document
          .getElementById("arrival")
          .value.trim()
          .toUpperCase();
        let departureAirport =
          findAirport(depCodeInput) ||
          (await window.fetchExternalAirport(depCodeInput));
        let arrivalAirport =
          findAirport(arrCodeInput) ||
          (await window.fetchExternalAirport(arrCodeInput));

        if (!departureAirport || !arrivalAirport) {
          showMessage(
            "Flug nicht speicherbar",
            "Mindestens ein Flughafen-Code wurde nicht gefunden.",
            "error"
          );
          resetForm();
          return;
        }

        await cacheAndSaveAirport(departureAirport);
        await cacheAndSaveAirport(arrivalAirport);

        const distance = calculateDistance(
          departureAirport.lat,
          departureAirport.lon,
          arrivalAirport.lat,
          arrivalAirport.lon
        );

        // KORREKTE LOGIK F√úR PREIS
        const priceInput = document.getElementById("price").value;

        const updatedFlightForSupabase = {
          date: document.getElementById("flightDate").value,
          departure: departureAirport.code,
          arrival: arrivalAirport.code,
          distance: Math.round(distance),
          time: estimateFlightTime(distance),
          class: document.getElementById("flightClass").value,
          flightNumber: document.getElementById("flightNumber").value.trim(),
          aircraftType: document.getElementById("aircraftType").value.trim(),
          notes: document.getElementById("notes").value.trim(),
          depLat: departureAirport.lat,
          depLon: departureAirport.lon,
          arrLat: arrivalAirport.lat,
          arrLon: arrivalAirport.lon,
          depName: departureAirport.name,
          arrName: arrivalAirport.name,
          photo_url: photoUrls,
          price:
            priceInput !== "" && !isNaN(parseFloat(priceInput))
              ? parseFloat(priceInput)
              : null,
          currency:
            document.getElementById("currency").value.trim().toUpperCase() ||
            null,
        };

        const { error } = await supabaseClient
          .from("flights")
          .update(updatedFlightForSupabase)
          .eq("flight_id", currentlyEditingFlightData.id);

        if (error) {
          showMessage(
            "Update-Fehler",
            "Die √Ñnderungen konnten nicht gespeichert werden.",
            "error"
          );
          console.error("Supabase Update Error:", error);
        } else {
          showMessage(
            "Erfolg!",
            "Die Flugdaten wurden erfolgreich aktualisiert.",
            "success"
          );
        }
        const flightIdToFocus = currentlyEditingFlightData.id;
        resetForm();
        renderFlights(null, flightIdToFocus);
      }

      // *** Rendern und L√∂schen ***
      window.deleteFlight = async function (id) {
        // Eine Best√§tigung ist bei L√∂schaktionen immer eine gute Idee
        if (
          !confirm(
            "Sind Sie sicher, dass Sie diesen Flug endg√ºltig l√∂schen m√∂chten?"
          )
        ) {
          return;
        }

        const { error } = await supabaseClient
          .from("flights")
          .delete()
          .eq("flight_id", id);

        if (error) {
          showMessage(
            "L√∂schfehler",
            "Der Flug konnte nicht gel√∂scht werden.",
            "error"
          );
          console.error("Supabase Delete Error:", error);
        } else {
          showMessage("Erfolg!", "Der Flug wurde gel√∂scht.", "success");
          renderFlights(); // Lade die Liste einfach neu
        }
      };

      window.renderFlights = async function (
        flightsToRender,
        flightIdToFocus,
        page = 1
      ) {
        currentPage = page;

        isAllRoutesViewActive = false;
        document.getElementById("toggle-map-view-btn").textContent =
          "Alle Routen zeigen";

        let allFlights = flightsToRender || (await getFlights());

        // NEU: Nummerierung nach dem Laden der Daten anwenden
        allFlights = resequenceAndAssignNumbers(allFlights);

        if (allFlights.length > 0) {
          const sortKey = currentSort.key;
          const direction = currentSort.direction === "asc" ? 1 : -1;

          allFlights.sort((a, b) => {
            const valA = a[sortKey];
            const valB = b[sortKey];
            let comparison = 0;

            if (typeof valA === "number") {
              comparison = valA - valB;
            } else if (sortKey === "date") {
              // KORREKTUR: Hier stand f√§lschlicherweise b[sortKey]
              comparison = new Date(valA) - new Date(valB);
            } else {
              comparison = (valA || "").localeCompare(valB || "");
            }
            return comparison * direction;
          });
        }
        updateCharts(allFlights); // Ruft die Charts mit der Standard-Jahresansicht auf
        updatePaginationUI(allFlights);
        updateStatisticsDisplay(allFlights);

        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const paginatedFlights = allFlights.slice(startIndex, endIndex);

        let flightForMap = null;
        if (flightIdToFocus) {
          flightForMap = allFlights.find((f) => f.id === flightIdToFocus);
        }
        if (!flightForMap && allFlights.length > 0) {
          flightForMap = paginatedFlights[0] || allFlights[0]; // Nimm den ersten der aktuellen Seite
        }

        if (flightForMap) {
          window.drawRouteOnMap(
            flightForMap.depLat,
            flightForMap.depLon,
            flightForMap.arrLat,
            flightForMap.arrLon,
            flightForMap.departure,
            flightForMap.arrival,
            flightForMap.depName,
            flightForMap.arrName
          );
        } else {
          window.drawRouteOnMap();
        }

        const flightList = document.getElementById("flight-log-list");
        flightList.innerHTML = "";

        if (paginatedFlights.length === 0 && currentPage === 1) {
          flightList.innerHTML =
            '<p id="no-flights-message" class="log-placeholder text-gray-500 italic text-center py-4">Noch keine Fl√ºge geloggt.</p>';
        } else {
          paginatedFlights.forEach((flight) => {
            const depName =
              airportData[flight.departure]?.name || flight.departure;
            const arrName = airportData[flight.arrival]?.name || flight.arrival;

            // Rufe die Hilfsfunktion auf, um die Farbe zu bestimmen
            const milestoneColor = getMilestoneColor(flight.flightLogNumber);

            const flightElement = document.createElement("div");
            flightElement.className =
              "bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 hover:shadow-lg transition flex justify-between items-start";

            // KORRIGIERTER innerHTML Block
            flightElement.innerHTML = `
                <div class="flex items-start gap-4 flex-grow">
                    <div class="flex-shrink-0 ${milestoneColor} text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm" title="Flugbuch-Nummer">
                        #${flight.flightLogNumber || "-"}
                    </div>
                    <div class="flex-grow">
                        <p class="text-base md:text-lg font-bold text-indigo-700 dark:text-indigo-400">
                            ${depName} (${flight.departure}) ‚ûî ${arrName} (${
              flight.arrival
            })
                        </p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                            üìÖ ${flight.date} | ‚è±Ô∏è ${
              flight.time
            } | üìè ${flight.distance.toLocaleString("de-DE")} km
                        </p>
                        ${
                          flight.flightNumber ||
                          flight.aircraftType ||
                          flight.class
                            ? `<p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                  Flug: ${flight.flightNumber || "-"} | Typ: ${
                                flight.aircraftType || "-"
                              } | Klasse: ${flight.class}
                              </p>`
                            : ""
                        }
                        ${
                          flight.photo_url && flight.photo_url.length > 0
                            ? `<div class="mt-2 flex gap-2">${flight.photo_url
                                .map(
                                  (url) => `
                                <a href="${url}" target="_blank">
                                    <img src="${url}" alt="Flugfoto" class="h-12 w-12 rounded-md object-cover shadow-sm hover:scale-110 transition">
                                </a>`
                                )
                                .join("")}
                               </div>`
                            : ""
                        }
                        ${
                          flight.notes
                            ? `<p class="text-xs text-gray-700 dark:text-gray-300 italic mt-2 border-l-2 border-indigo-400 pl-2">
                                  ${flight.notes}
                              </p>`
                            : ""
                        }
                    </div>
                </div>
                <div class="flex flex-col md:flex-row items-center ml-2">
                    <button onclick="editFlight(${
                      flight.id
                    })" class="p-2 text-blue-500 hover:text-blue-700 transition" title="Flug bearbeiten">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button onclick="deleteFlight(${
                      flight.id
                    })" class="p-2 text-red-500 hover:text-red-700 transition" title="Flug l√∂schen">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `;
            flightList.appendChild(flightElement);
          });
        }

        updateSortButtonUI();
      };

      /**
       * Sortiert Fl√ºge chronologisch nach Datum und weist sequenzielle Flugbuch-Nummern zu.
       * @param {Array<Object>} flights - Das Array der Flug-Objekte.
       * @returns {Array<Object>} Das sortierte und neu nummerierte Array.
       */
      function resequenceAndAssignNumbers(flights) {
        // 1. Sortiere die Fl√ºge. Prim√§res Kriterium ist das Datum (aufsteigend).
        // Als zweites Kriterium dient die technische ID, um eine stabile Reihenfolge
        // bei Fl√ºgen am selben Tag zu gew√§hrleisten.
        const sortedFlights = flights.sort((a, b) => {
          const dateComparison = new Date(a.date) - new Date(b.date);
          if (dateComparison !== 0) {
            return dateComparison;
          }
          return a.id - b.id; // Fallback-Sortierung f√ºr Fl√ºge am gleichen Tag
        });

        // 2. Weise die neuen, sequenziellen Flugbuch-Nummern zu.
        sortedFlights.forEach((flight, index) => {
          flight.flightLogNumber = index + 1;
        });

        return sortedFlights;
      }

      /**
       * Zeichnet die Flugroute mit Markern auf die interaktive Leaflet-Karte.
       */
      window.drawRouteOnMap = async function (
        depLat,
        depLon,
        arrLat,
        arrLon,
        depCode,
        arrCode,
        depName,
        arrName
      ) {
        var mapInfo = document.getElementById("map-info");
        routeLayer.clearLayers();

        if (!depLat || !arrLat) {
          mapInfo.textContent = "Kein Flug geloggt oder Koordinaten fehlen.";
          map.setView([20, 0], 2);
          return;
        }

        // NEU: Wetterdaten f√ºr Start und Ziel gleichzeitig abrufen
        const [depWeather, arrWeather] = await Promise.all([
          window.fetchWeatherByCoords(depLat, depLon),
          window.fetchWeatherByCoords(arrLat, arrLon),
        ]);

        // Popup-Inhalte mit Wetterinformationen erstellen
        const depPopupContent = `<b>Abflug:</b> ${depName} (${depCode})${formatWeatherForPopup(
          depWeather
        )}`;
        const arrPopupContent = `<b>Ankunft:</b> ${arrName} (${arrCode})${formatWeatherForPopup(
          arrWeather
        )}`;

        const depMarker = L.marker([depLat, depLon]).bindPopup(depPopupContent);
        const arrMarker = L.marker([arrLat, arrLon]).bindPopup(arrPopupContent);

        const flightPath = L.polyline(
          [
            [depLat, depLon],
            [arrLat, arrLon],
          ],
          { color: "#10B981", weight: 3 }
        );

        routeLayer.addLayer(depMarker);
        routeLayer.addLayer(arrMarker);
        routeLayer.addLayer(flightPath);

        map.fitBounds(
          [
            [depLat, depLon],
            [arrLat, arrLon],
          ],
          { padding: [50, 50] }
        );
        mapInfo.textContent = `Visualisierung: ${depName} (${depCode}) ‚Üí ${arrName} (${arrCode}).`;
      };

      /**
       * Aktualisiert die UI der Sortier-Buttons, um den aktiven Zustand anzuzeigen.
       */
      function updateSortButtonUI() {
        // Entferne zuerst alle aktiven Zust√§nde und Pfeile
        document.querySelectorAll(".sort-btn").forEach((btn) => {
          btn.classList.remove("active");
          btn.textContent = btn.textContent.replace(/ [‚ñ≤‚ñº]/, "");
        });

        // Setze den aktiven Zustand und Pfeil f√ºr den aktuellen Sortier-Button
        const activeButton = document.getElementById(
          `sort-btn-${currentSort.key}`
        );
        if (activeButton) {
          activeButton.classList.add("active");
          activeButton.textContent +=
            currentSort.direction === "asc" ? " ‚ñ≤" : " ‚ñº";
        }
      }

      /**
       * Wendet die in der Filterleiste eingegebenen Kriterien an und rendert die Ergebnisliste neu.
       */
      window.applyFilters = async function () {
        // 'async' hinzugef√ºgt
        currentPage = 1;
        const allFlights = await getFlights(); // 'await' hinzugef√ºgt

        const depFilter = document
          .getElementById("filter-departure")
          .value.trim()
          .toUpperCase();
        const arrFilter = document
          .getElementById("filter-arrival")
          .value.trim()
          .toUpperCase();
        const dateFrom = document.getElementById("filter-date-from").value;
        const dateTo = document.getElementById("filter-date-to").value;

        let filteredFlights = allFlights;

        if (depFilter) {
          filteredFlights = filteredFlights.filter((flight) =>
            flight.departure.toUpperCase().includes(depFilter)
          );
        }
        if (arrFilter) {
          filteredFlights = filteredFlights.filter((flight) =>
            flight.arrival.toUpperCase().includes(arrFilter)
          );
        }
        if (dateFrom) {
          filteredFlights = filteredFlights.filter(
            (flight) => flight.date >= dateFrom
          );
        }
        if (dateTo) {
          filteredFlights = filteredFlights.filter(
            (flight) => flight.date <= dateTo
          );
        }

        renderFlights(filteredFlights);
      };

      /**
       * Setzt alle Filterfelder zur√ºck und zeigt wieder die vollst√§ndige Flugliste an.
       */
      window.resetFilters = function () {
        currentPage = 1; // Zur√ºck zu Seite 1
        // Setze die Werte der Input-Felder zur√ºck
        document.getElementById("filter-departure").value = "";
        document.getElementById("filter-arrival").value = "";
        document.getElementById("filter-date-from").value = "";
        document.getElementById("filter-date-to").value = "";

        // Rufe renderFlights ohne Argument auf, um alle Fl√ºge anzuzeigen
        renderFlights();
      };

      /**
       * Setzt den Sortierschl√ºssel und die Richtung und rendert die Liste neu.
       * @param {string} sortKey - Die Eigenschaft, nach der sortiert werden soll (z.B. 'date').
       */
      window.setSortOrder = function (sortKey) {
        currentPage = 1; // Zur√ºck zu Seite 1
        if (currentSort.key === sortKey) {
          // Wenn derselbe Button geklickt wird, kehre die Richtung um
          currentSort.direction =
            currentSort.direction === "asc" ? "desc" : "asc";
        } else {
          // Bei einem neuen Button, setze den Schl√ºssel und starte mit aufsteigender Sortierung
          currentSort.key = sortKey;
          currentSort.direction = "asc";
        }
        // Rendere die Flugliste mit der neuen Sortierung neu
        applyFilters();
      };

      /**
       * Ruft Wetterdaten f√ºr gegebene Koordinaten ab.
       * @param {number} lat - Latitude.
       * @param {number} lon - Longitude.
       * @returns {Promise<object|null>} Ein Promise, das mit dem Wetterobjekt oder null aufgel√∂st wird.
       */
      /** window.fetchWeatherByCoords = async function(lat, lon) {
    const { CapacitorHttp } = Capacitor; // Capacitor-Plugin laden

    const url = `https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-weather?lat=${lat}&lon=${lon}`;

    const options = {
        url: url,
        headers: { 'Content-Type': 'application/json' }
    };

    try {
        const response = await CapacitorHttp.get(options);

        if (response.data && typeof response.data.temp !== 'undefined') {
            return response.data; 
        }
        return null;
    } catch (error) {
        console.error("Fehler bei der Capacitor HTTP-Anfrage (Wetter):", error);
        return null;
    }
};
*/

      window.fetchWeatherByCoords = async function (lat, lon) {
        try {
          //          const response = await fetch(`/.netlify/functions/fetch-weather?lat=${lat}&lon=${lon}` );

          const response = await fetch(
            `https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-weather?lat=${lat}&lon=${lon}`
          );

          if (!response.ok) {
            console.error(
              `Fehler beim Abrufen des Wetters f√ºr Koordinaten ${lat},${lon}:`,
              response.statusText
            );
            return null;
          }

          const data = await response.json();

          // Die API gibt direkt ein Objekt zur√ºck, keine Liste, wenn sie erfolgreich ist.
          if (data && typeof data.temp !== "undefined") {
            return data;
          }

          return null;
        } catch (error) {
          console.error(
            "Netzwerkfehler beim Aufruf der Wetter-Funktion:",
            error
          );
          return null;
        }
      };

      // =================================================================
      // DER EINZIGE DOMContentLoaded-LISTENER GANZ AM ENDE
      // =================================================================

      document.addEventListener("DOMContentLoaded", function () {
        // Event-Listener NUR f√ºr die Auth-Formulare
        document
          .getElementById("login-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            const { error } = await supabaseClient.auth.signInWithPassword({
              email,
              password,
            });
            if (error) {
              document.getElementById("auth-error").textContent = error.message;
            }
            // KEIN 'else' Block hier. onAuthStateChange k√ºmmert sich um den Erfolg.
          });

        document
          .getElementById("register-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("register-email").value;
            const password = document.getElementById("register-password").value;
            const { error } = await supabaseClient.auth.signUp({
              email,
              password,
            });
            if (error) {
              document.getElementById("auth-error").textContent = error.message;
            } else {
              showMessage(
                "Registrierung erfolgreich!",
                "Bitte best√§tige deine E-Mail-Adresse, um dich einzuloggen.",
                "success"
              );
            }
          });

        document
          .getElementById("request-reset-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("reset-email").value;
            const { error } = await supabaseClient.auth.resetPasswordForEmail(
              email,
              { redirectTo: window.location.origin }
            );
            if (error) {
              showMessage("Fehler", error.message, "error");
            } else {
              showMessage(
                "E-Mail gesendet",
                "Wenn ein Benutzer mit dieser E-Mail existiert, wurde ein Link zum Zur√ºcksetzen gesendet.",
                "success"
              );
            }
          });

        document
          .getElementById("update-password-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById(
              "update-password-input"
            ).value;
            if (newPassword.length < 6) {
              showMessage(
                "Fehler",
                "Das Passwort muss mindestens 6 Zeichen lang sein.",
                "error"
              );
              return;
            }
            const { error } = await supabaseClient.auth.updateUser({
              password: newPassword,
            });
            if (error) {
              showMessage(
                "Fehler",
                "Passwort konnte nicht aktualisiert werden: " + error.message,
                "error"
              );
            } else {
              showMessage(
                "Erfolg!",
                "Dein Passwort wurde ge√§ndert. Du kannst dich jetzt einloggen.",
                "success"
              );
              backToLogin();
            }
          });

        // Haupt-Logik: Reagiere auf √Ñnderungen des Login-Status
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          if (event === "PASSWORD_RECOVERY") {
            showAuth();
            showPasswordResetForm();
            document
              .getElementById("request-reset-form")
              .classList.add("hidden");
            document
              .getElementById("update-password-form")
              .classList.remove("hidden");
            showMessage(
              "Willkommen zur√ºck!",
              "Bitte gib jetzt dein neues Passwort ein.",
              "info"
            );
          } else if (session) {
            // Dieser Block wird bei INITIAL_SESSION (Seitenaufruf im eingeloggten Zustand)
            // UND bei SIGNED_IN (direkt nach dem Login) ausgef√ºhrt.
            await initializeApp();
          } else {
            // Dieser Block wird bei SIGNED_OUT ausgef√ºhrt.
            showAuth();
          }
        });
      });
    </script>
  </body>
</html>
