<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <script>
      // Initiales Laden des Themes, um Flackern zu verhindern
	  //
      if (
        localStorage.theme === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mein Digitales Flugbuch</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	<script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script src="//unpkg.com/three"></script>
	<script src="//unpkg.com/globe.gl"></script>
	<script src="https://cdn.tailwindcss.com"></script>
    

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .autocomplete-container {
        position: relative;
      }
      .autocomplete-list {
        position: absolute;
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-top: none;
        background: white;
        width: 100%;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
      .autocomplete-item:hover,
      .autocomplete-item.active {
        background-color: #e0e7ff;
      }
      .flight-number-label {
        background-color: transparent;
        border: none;
        box-shadow: none;
        color: #1e293b;
        font-weight: bold;
        font-size: 10px;
        text-shadow: 0 0 2px white, 0 0 3px white;
      }
      .sort-btn.active,
      .chart-view-btn.active {
        background-color: #4338ca;
        color: white;
      }
      .logbook-view-btn.active {
        background-color: #4338ca;
        color: white;
      }
      .toast {
        padding: 1rem;
        border-radius: 0.5rem;
        color: white;
        font-size: 0.875rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateX(100%);
        animation: slideInFadeIn 0.5s forwards,
          slideOutFadeOut 0.5s 4.5s forwards;
      }
      .toast-success {
        background-color: #10b981;
      }
      .toast-error {
        background-color: #ef4444;
      }
      .toast-info {
        background-color: #3b82f6;
      }
      .dark body {
        background-color: #111827;
        color: #d1d5db;
      }
      .dark .bg-white {
        background-color: #1f2937;
        border-color: #374151;
      }
      .dark .bg-gray-100 {
        background-color: #111827;
      }
      .dark .bg-gray-50 {
        background-color: #1f2937;
      }
      .dark .bg-gray-200 {
        background-color: #374151;
      }
      .dark .bg-gray-200:hover {
        background-color: #4b5563;
      }
      .dark .bg-indigo-50 {
        background-color: #1f2937;
      }
      .dark .border-gray-200 {
        border-color: #4b5563;
      }
      .dark .text-gray-500 {
        color: #9ca3af;
      }
      .dark .text-gray-700 {
        color: #e5e7eb;
      }
      .dark .text-gray-800 {
        color: #f9fafb;
      }
      .dark .text-indigo-600 {
        color: #818cf8;
      }
      .dark .text-indigo-700 {
        color: #a5b4fc;
      }
      .dark input,
      .dark select,
      .dark textarea {
        background-color: #374151;
        border-color: #4b5563;
        color: #f9fafb;
      }
      .dark .autocomplete-list {
        background: #1f2937;
        border-color: #4b5563;
      }
      .dark .autocomplete-item:hover,
      .dark .autocomplete-item.active {
        background-color: #312e81;
      }
      .auth-tab {
        color: #6b7280;
      }
      .dark .auth-tab {
        color: #9ca3af;
      }
      .auth-tab.active-tab {
        color: #4f46e5;
        border-bottom: 2px solid #4f46e5;
      }
      .dark .auth-tab.active-tab {
        color: #818cf8;
        border-color: #818cf8;
      }
      @keyframes slideInFadeIn {
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes slideOutFadeOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(100%);
        }
      }
	  .animated-flight-marker {
            background: transparent;
            border: none;
            text-shadow: 0 0 2px white, 0 0 3px white, 0 0 4px white; /* St√§rkerer Schatten f√ºr bessere Lesbarkeit */
            font-weight: bold;
            font-size: 14px; /* Etwas gr√∂√üer als die 10px vorher */
            text-align: center;
            /* Wichtig, damit Leaflet die Position korrekt berechnet */
            width: 30px !important;
            height: 20px !important;
            margin-left: -15px; /* Manuelle Zentrierung */
            margin-top: -10px;  /* Manuelle Zentrierung */
        }
    </style>
  </head>

  <body class="bg-gray-100 dark:bg-gray-900">
    <div
      id="auth-container"
      class="min-h-screen flex items-center justify-center p-4"
    >
      <div
        class="w-full max-w-md bg-white dark:bg-gray-800 shadow-2xl rounded-xl p-8"
      >
        <h1
          data-i18n="appName" class="text-3xl font-extrabold text-indigo-700 dark:text-indigo-400 mb-6 text-center"
        >
          ‚úàÔ∏è Digitales Flugbuch
        </h1>
        <div id="auth-tabs" class="flex justify-center border-b mb-6">
          <button
            onclick="switchAuthTab('login')" data-i18n="login"
            id="login-tab"
            class="auth-tab active-tab px-4 py-2 font-semibold"
          >
            Login
          </button>
          <button
            onclick="switchAuthTab('register')" data-i18n="register"
            id="register-tab" data-i18n="register"
            class="auth-tab px-4 py-2 font-semibold"
          >
            Registrieren
          </button>
        </div>
        <form id="login-form" class="space-y-4">
          <input
            type="email"
            id="login-email"
            placeholder="E-Mail"
			data-i18n="placeholder.email"
            required
            class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
          />
          <input
            type="password"
            id="login-password"
            placeholder="Passwort"
			data-i18n="placeholder.password"
            required
            class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
          />
          <div class="text-right">
            <a
              href="#"
              onclick="event.preventDefault(); showPasswordResetForm();" data-i18n="forgotPWD"
              class="text-sm font-medium text-indigo-600 hover:underline dark:text-indigo-400"
              >Passwort vergessen?</a
            >
          </div>
          <button
            type="submit" data-i18n="login"
            class="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
          >
            Einloggen
          </button>
        </form>
        <form id="register-form" class="space-y-4 hidden">
          <input
            type="email"
            id="register-email"
            placeholder="E-Mail"
			data-i18n="placeholder.email"
            required
            class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
          />
          <input
            type="password"
            id="register-password"
            placeholder="Passwort"
			data-i18n="placeholder.password"
            required
            class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
          />
          <button
            type="submit" data-i18n="register"
            class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
          >
            Registrieren
          </button>
        </form>
        <div id="password-reset-container" class="hidden">
          <form id="request-reset-form" class="space-y-4"> 
            <p data-i18n="newMail4Link4PWD"  class="text-sm text-center text-gray-600 dark:text-gray-400">
              Gib deine E-Mail-Adresse ein, um einen Link zum Zur√ºcksetzen
              deines Passworts zu erhalten.
            </p>
            <input
              type="email"
              id="reset-email"
              placeholder="E-Mail"
			  data-i18n="placeholder.email"
              required
              class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
            />
            <button
              type="submit" data-i18n="reset"
              class="w-full py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
            >
              Reset-Link anfordern
            </button>
          </form>
          <form id="update-password-form" class="space-y-4 hidden">
            <p data-i18n="enterNewPWD" class="text-sm text-center text-gray-600 dark:text-gray-400">
              Gib dein neues Passwort ein.
            </p>
            <input
              type="password"
              id="update-password-input"
              placeholder="Neues Passwort (mind. 6 Zeichen)"
			  data-i18n="placeholder.newPassword"
              required
              class="w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
            />
            <button
              type="submit" data-i18n="saveNewPWD"
              class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition"
            >
              Neues Passwort speichern
            </button>
          </form>
          <div class="text-center mt-4">
            <a
              href="#"
              onclick="event.preventDefault(); backToLogin();" data-i18n="backToLogin"
              class="text-sm font-medium text-indigo-600 hover:underline dark:text-indigo-400"
              >Zur√ºck zum Login</a
            >
          </div>
        </div>
        <p id="auth-error" class="text-red-500 text-sm mt-4 text-center"></p>
      </div>
    </div>

    <div
      id="app-container"
      class="hidden min-h-screen p-4 md:p-8 flex items-center justify-center"
    >
      <div
        class="w-full max-w-4xl bg-white dark:bg-gray-800 shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100 dark:border-gray-700"
      >
        <div class="flex justify-between items-center mb-2">
          <h1
            data-i18n="appName" class="text-2xl md:text-4xl font-extrabold text-indigo-700 dark:text-indigo-400"
          >
            ‚úàÔ∏è Digitales Flugbuch
          </h1>
          <div class="relative">
            <button
              id="burger-menu-btn"
              class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16m-7 6h7"
                ></path>
              </svg>
            </button>
            <div
              id="burger-menu"
              class="hidden absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg z-50 border dark:border-gray-700"
            >
              <div class="md:hidden border-b dark:border-gray-700">
                <a
                  href="#"
                  onclick="event.preventDefault(); showTab('neue-fluege'); toggleBurgerMenu();" data-i18n="burgerMenu.newFlight"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Neuer Flug</a
                >
                <a
                  href="#"
                  onclick="event.preventDefault(); showTab('fluege'); toggleBurgerMenu();" data-i18n="burgerMenu.flights"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Fl√ºge</a
                >
                <a
                  href="#"
                  onclick="event.preventDefault(); showTab('stats'); toggleBurgerMenu();" data-i18n="burgerMenu.stats"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Statistiken</a
                >
                <a
                  href="#"
                  onclick="event.preventDefault(); showTab('charts'); toggleBurgerMenu();" data-i18n="burgerMenu.charts"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Charts</a
                >
                <a
                  href="#"
                  onclick="event.preventDefault(); showTab('logbook'); toggleBurgerMenu();" data-i18n="burgerMenu.logbook"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Logbuch</a
                >
				<a href="#" onclick="event.preventDefault(); showTab('achievements'); toggleBurgerMenu();" data-i18n="burgerMenu.achievements" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">Errungenschaften</a>
              </div>
			  
			  <div class="border-b dark:border-gray-700 py-1 flex justify-around">
				<button onclick="setLanguage('de'); toggleBurgerMenu();" class="p-2 text-sm font-medium rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">üá©üá™ DE</button>
				
				<button onclick="setLanguage('en'); toggleBurgerMenu();" class="p-2 text-sm font-medium rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">üá¨üáß EN</button>
			  </div>
			  
			  <div class="border-b dark:border-gray-700 py-1">
				<a href="#" onclick="event.preventDefault(); exportData('json'); toggleBurgerMenu();" data-i18n="burgerMenu.exportJSON" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
					Daten Exportieren (JSON)
				</a>
				<a href="#" onclick="event.preventDefault(); exportData('csv'); toggleBurgerMenu();" data-i18n="burgerMenu.exportCSV" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
					Daten Exportieren (CSV)
				</a>
				<label for="import-file-input" data-i18n="burgerMenu.importJSON" class="block px-4 py-2 text-sm text-red-500 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">
					Daten Importieren (JSON)...
				</label>
			  </div>
			  
              <div class="py-1">
                <a
                  href="#"
                  onclick="event.preventDefault(); showPasswordChangeModal()" data-i18n="burgerMenu.changePassword"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Passwort √§ndern</a
                >
                <a
                  href="#"
                  id="menu-theme-toggle" data-i18n="burgerMenu.toggleMode"
                  class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Modus wechseln</a
                >
                <a
                  href="#"
                  id="menu-logout-btn" data-i18n="burgerMenu.logout"
                  class="block px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700"
                  >Logout</a
                >
              </div>
              <div class="border-t dark:border-gray-700 px-4 py-2">
                <span
                  id="user-display"
                  class="block text-xs text-gray-500"
                ></span>
                <span
                  id="app-version"
                  class="block text-xs text-gray-400"
                ></span>
              </div>
            </div>
          </div>
        </div>

        <h2
          data-i18n="lastFlightMap" class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white mb-4 border-b pb-2 border-gray-200 dark:border-gray-700"
        >
          Zuletzt geloggter/bearbeiteter Flug
        </h2>
        <div class="mb-6">
          <p
            id="map-info" data-i18n="mapVisualization"
            class="text-center text-sm text-gray-700 dark:text-gray-300 mb-2 italic"
          >
            Flugroute wird visualisiert.
          </p>
          <div
            id="flight-map-container"
            class="h-[300px] rounded-lg mb-6 shadow-lg z-0"
          ></div>
        </div>
        <div>
          <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="hidden md:flex -mb-px space-x-6" aria-label="Tabs">
              <button
                onclick="showTab('neue-fluege')"
                id="tab-btn-neue-fluege" data-i18n="tabs.newFlight"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600"
              >
                Neuer Flug
              </button>
              <button
                onclick="showTab('fluege')"
                id="tab-btn-fluege" data-i18n="tabs.flights"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600"
              >
                Fl√ºge
              </button>
              <button
                onclick="showTab('stats')"
                id="tab-btn-stats" data-i18n="tabs.stats"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              >
                Statistiken
              </button>
              <button
                onclick="showTab('charts')"
                id="tab-btn-charts" data-i18n="tabs.charts"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              >
                Charts
              </button>
              <button
                onclick="showTab('logbook')"
                id="tab-btn-logbook" data-i18n="tabs.logbook"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              >
                Logbuch
              </button>
              <button
                onclick="showTab('achievements')"
                id="tab-btn-achievements" data-i18n="tabs.achievements"
                class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              >
                Errungenschaften
              </button>
            </nav>
          </div>
          <div class="py-6">
            <div id="tab-content-neue-fluege">
              <p data-i18n="tagline" class="text-gray-500 dark:text-gray-400 mb-8">
                W√§hlen Sie einen Flughafen aus der Liste oder geben Sie einen
                Code/Namen manuell ein.
              </p>
			  
			  <div class="bg-gray-50 dark:bg-gray-700 p-5 rounded-lg mb-6 shadow-inner border dark:border-gray-600">
					<h3 data-i18n="autoPilot" class="text-lg font-semibold text-indigo-600 dark:text-indigo-400 mb-4 flex items-center gap-2">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
						Autopilot: Flugdaten per Flugnummer laden
					</h3>
					<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
						<div>
							<label for="auto-flight-number" data-i18n="autoFlightNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Flugnummer</label>
							<input type="text" id="auto-flight-number" placeholder="z.B. LH202" data-i18n="placeholder.egFlightNumber" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
						</div>
						<div>
							<label for="auto-flight-date" data-i18n="autoFlightDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Flugdatum</label>
							<input type="date" id="auto-flight-date" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
						</div>
						<button id="autofill-btn" data-i18n="autofillBtn" class="w-full py-3 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">Daten abrufen</button>
					</div>
				</div>
			  
              <div
                class="bg-indigo-50 dark:bg-gray-900 p-5 rounded-lg mb-6 shadow-inner"
              >
                <h2 data-i18n="logNewFlight"
                  class="text-xl font-semibold text-indigo-600 dark:text-indigo-400 mb-4"
                >
                  Neuen Flug loggen
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div class="autocomplete-container">
                    <label
                      for="departure" data-i18n="departureNewFlight"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Abflugort (IATA/Name)</label
                    >
                    <input
                      type="text"
                      id="departure"
                      placeholder="z.B. FRA"
					  data-i18n="placeholder.egDeparture"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                    />
                    <div
                      id="departure-list"
                      class="autocomplete-list hidden rounded-lg"
                    ></div>
                  </div>
                  <div class="autocomplete-container">
                    <label
                      for="arrival" data-i18n="arrivalNewFlight"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Zielort (IATA/Name)</label
                    >
                    <input
                      type="text"
                      id="arrival"
                      placeholder="z.B. JFK"
					  data-i18n="placeholder.egArrival"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                    />
                    <div
                      id="arrival-list"
                      class="autocomplete-list hidden rounded-lg"
                    ></div>
                  </div>
                </div>
                
				
				<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4">
					<div>
                    <label
                      for="flightDate" data-i18n="flightDateNewFlight"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Flugdatum (Optional)</label
                    ><input
                      type="date"
                      id="flightDate"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"
                    />
                  </div>
				  <div>
                    <label
                      for="flightClass" data-i18n="flightClassNewFlight"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Klasse/Zweck (Optional)</label
                    ><select
                      id="flightClass"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 bg-white"
                    >
						<option value="Economy" data-i18n="flightClassEconomy">Economy</option>
						<option value="Business" data-i18n="flightClassBusiness">Business</option>
						<option value="First" data-i18n="flightClassFirst">First</option>
						<option value="Privat" data-i18n="flightClassPrivat">Privat</option>
						<option value="Cargo" data-i18n="flightClassCargo">Cargo</option>
                    </select>
                  </div>
				</div>
				
				<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                  <div>
                    <label for="flightNumber" data-i18n="form.flightNumberOptional" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Flugnummer (Optional)</label>
                    <input type="text" id="flightNumber" placeholder="z.B. LH400" data-i18n="placeholder.egFlightNumber" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                  </div>
                  <div>
					<label for="airline" data-i18n="form.airline" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Airline (Optional)</label>
					<input type="text" id="airline" placeholder="z.B. Lufthansa" data-i18n="placeholder.egAirline" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
				  </div>
                  <div>
                    <label for="aircraftType" data-i18n="form.aircraft" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Flugzeugtyp (Optional)</label>
                    <input type="text" id="aircraftType" placeholder="z.B. A320" data-i18n="placeholder.egAircraft" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                  </div>
                  
                  <div class="md:col-start-1"> <label for="registration" data-i18n="form.registration" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Registrierung (Optional)</label>
                    <input type="text" id="registration" placeholder="z.B. D-AINC" data-i18n="placeholder.egRegistration" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3">
                  </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                  <div>
                    <label
                      for="price" data-i18n="priceNewFlight"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >Ticketpreis (Optional)</label
                    >
                    <input
                      type="number"
                      id="price"
                      placeholder="z.B. 199.99"
					  data-i18n="placeholder.egPrice"
                      step="0.01"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"
                    />
                  </div>
                  <div>
                    <label
                      for="currency" data-i18n="currencyNewFlight"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                      >W√§hrung (Optional)</label
                    >
                    <input
                      type="text"
                      id="currency"
                      placeholder="z.B. EUR"
					  data-i18n="placeholder.egCurrency"
                      maxlength="3"
                      class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3"
                    />
                  </div>
                </div>

                <div class="mb-6">
					<label data-i18n="form.photo" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Foto (Optional)</label>

					<input type="file" id="flightPhoto" accept="image/*" class="hidden" multiple>

					<label for="flightPhoto" data-i18n="form.chooseFile" class="mt-1 inline-block bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 cursor-pointer">
						Datei ausw√§hlen...
					</label>

					<div id="photo-preview-container" class="inline-block ml-4">
						<p id="photo-preview-text" class="text-sm text-gray-600 dark:text-gray-400" data-i18n="form.noFileSelected">
							Keine Datei ausgew√§hlt
						</p>
					</div>
				</div>
                <div class="mb-6">
                  <label
                    for="notes" data-i18n="notesNewFlight"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300"
                    >Bemerkungen (Optional)</label
                  >
                  <textarea
                    id="notes"
                    rows="3"
                    placeholder="Besondere Vorkommnisse oder pers√∂nliche Notizen..."
					data-i18n="form.notesPlaceholder"
                    class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 text-sm"
                  ></textarea>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 bg-indigo-100 dark:bg-indigo-900/50 p-4 rounded-lg border border-indigo-200 dark:border-indigo-800 mb-4">
					<div>
						<p data-i18n="estimatedDistanceNewFlight" class="text-xs font-medium text-indigo-700 dark:text-indigo-300">Gesch√§tzte Entfernung</p>
						<p id="distance-display" class="text-xl font-bold text-indigo-800 dark:text-indigo-400">-</p>
					</div>
					<div>
						<p data-i18n="estimatedFlightTimeNewFlight" class="text-xs font-medium text-indigo-700 dark:text-indigo-300">Gesch√§tzte Flugzeit</p>
						<p id="time-display" class="text-xl font-bold text-indigo-800 dark:text-indigo-400">-</p>
					</div>
					<div class="col-span-2 md:col-span-1">
						<p data-i18n="estimatedCO2Emissions" class="text-xs font-medium text-red-700 dark:text-red-400">Gesch√§tzter CO‚ÇÇ-Aussto√ü</p>
						<p id="co2-display" class="text-xl font-bold text-red-800 dark:text-red-400">-</p>
					</div>
				</div>
                <div
                  class="flex flex-col sm:flex-row items-stretch sm:items-center gap-4"
                >
                  <button
                    onclick="logFlight()"
                    id="log-button"
                    disabled data-i18n="logFlightNewFlight"
                    class="w-full py-3 px-4 ..."
                  >
                    Flug loggen und speichern
                  </button>
                  <button
                    onclick="resetForm()"
                    id="cancel-edit-button"
                    class="hidden w-full sm:w-1/3 py-3 px-4 ..."
                  >
                    Abbrechen
                  </button>
                </div>
              </div>
            </div>

            <div id="tab-content-fluege">
              <div
                class="flex items-center justify-between mb-4 border-b pb-2 border-gray-200 dark:border-gray-700"
              >
                <h2
                  class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white" data-i18n="flights.title"
                >
                  Gespeicherte Fl√ºge
                </h2>
                <div class="flex flex-wrap items-center space-x-4">
                  <button id="play-chronicle-btn" class="text-sm font-medium text-green-600 hover:text-green-800 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition" data-i18n="flights.playChronicle">
					‚ñ∂Ô∏è Chronik abspielen
				  </button>
				  <button
                    id="toggle-map-view-btn"
                    onclick="toggleAllRoutesView()"
                    class="text-sm font-medium text-indigo-600 hover:text-indigo-800 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition" data-i18n="flights.showAllRoutes"
                  >
                    Alle Routen zeigen
                  </button>
				  <button id="show-globe-btn" class="text-sm font-medium text-purple-600 hover:text-purple-800 p-2 rounded-lg bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition" data-i18n="flights.show3DGlobe">
					üåç 3D Globus
				  </button>
                  <button
                    onclick="renderFlights()"
                    class="text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center p-2 rounded-lg bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 transition" data-i18n="flights.refresh"
                  >
                    Aktualisieren
                  </button>
                </div>
              </div>
              <div
                class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg mb-4 border border-gray-200 dark:border-gray-700"
              >
                <h3
                  class="text-lg font-semibold text-gray-800 dark:text-white mb-3" data-i18n="flights.filterTitle"
                >
                  Fl√ºge filtern
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                  <div>
                    <label
                      for="filter-departure"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="flights.filterDeparture"
                      >Abflugort (IATA)</label
                    ><input
                      type="text"
                      id="filter-departure"
                      placeholder="z.B. FRA"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                  </div>
                  <div>
                    <label
                      for="filter-arrival"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="flights.filterArrival"
                      >Zielort (IATA)</label
                    ><input
                      type="text"
                      id="filter-arrival"
                      placeholder="z.B. JFK"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                  </div>
                  <div>
                    <label
                      for="filter-date-from"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="flights.filterDateFrom"
                      >Datum (von)</label
                    ><input
                      type="date"
                      id="filter-date-from"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                  </div>
                  <div>
                    <label
                      for="filter-date-to"
                      class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="flights.filterDateTo"
                      >Datum (bis)</label
                    ><input
                      type="date"
                      id="filter-date-to"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"
                    />
                  </div>
                  <div class="flex space-x-2">
                    <button
                      onclick="applyFilters()"
                      class="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition" data-i18n="flights.filterButton"
                    >
                      Filtern</button
                    ><button
                      onclick="resetFilters()"
                      class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition" data-i18n="flights.resetButton"
                    >
                      Reset
                    </button>
                  </div>
                </div>
              </div>
              <div
                id="sort-bar"
                class="flex flex-wrap items-center gap-2 mb-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-md text-sm font-semibold"
              >
                <span class="text-gray-600 dark:text-gray-300 mr-2" data-i18n="flights.sortBy"
                  >Sortieren nach:</span
                >
                <button
                  id="sort-btn-flightLogNumber"
                  onclick="setSortOrder('flightLogNumber')"
                  class="sort-btn flex-shrink-0 px-3 py-1 rounded-md transition hover:bg-gray-300 dark:hover:bg-gray-500"
                >
                  #
                </button>
                <button
                  id="sort-btn-date"
                  onclick="setSortOrder('date')"
                  class="sort-btn flex-shrink-0 px-3 py-1 rounded-md transition hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="flights.sortDate"
                >
                  Datum
                </button>
                <button
				  id="sort-btn-departure"
                  onclick="setSortOrder('departure')"
                  class="sort-btn flex-grow px-3 py-1 rounded-md transition hover:bg-gray-300 dark:hover:bg-gray-500 text-left" data-i18n="flights.sortRoute"
                >
                  Route
                </button>
				
                <button
                  id="sort-btn-distance"
                  onclick="setSortOrder('distance')"
                  class="sort-btn flex-shrink-0 px-3 py-1 rounded-md transition hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="flights.sortDistance"
                >
                  Distanz
                </button>
              </div>
              <div
                id="flight-log-list"
                class="space-y-3 max-h-96 overflow-y-auto pr-2"
              ></div>
              <div
                id="pagination-controls"
                class="flex justify-between items-center mt-4 text-sm text-gray-600 dark:text-gray-400"
              >
                <button
                  id="prev-page-btn"
                  onclick="prevPage()"
                  class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed" data-i18n="flights.prevButton">
                >
                  ‚Äπ Zur√ºck
                </button>
                <span id="page-info" class="font-semibold"></span>
                <button
                  id="next-page-btn"
                  onclick="nextPage()"
                  class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed" data-i18n="flights.nextButton"
                >
                  Weiter ‚Ä∫
                </button>
              </div>
            </div>

            <div id="tab-content-stats">
              <div
                id="statistics-panel"
                class="grid grid-cols-2 md:grid-cols-4 gap-4 bg-gray-100 dark:bg-gray-900 p-4 rounded-lg text-center"
              >
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.totalFlights"
                  >
                    Gesamte Fl√ºge
                  </p>
                  <p
                    id="stat-count"
                    class="text-xl font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    0
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.totalDistance"
                  >
                    Gesamtdistanz
                  </p>
                  <p
                    id="stat-distance"
                    class="text-xl font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    0 km
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.frequentAirport"
                  >
                    H√§ufigster Flughafen
                  </p>
                  <p
                    id="stat-frequent"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div
                  class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm col-span-2"
                >
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.totalSpending"
                  >
                    Gesamtausgaben
                  </p>
                  <p
                    id="stat-total-spending"
                    class="text-xl font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.mostExpensive"
                  >
                    Teuerster Flug
                  </p>
                  <p
                    id="stat-most-expensive"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.leastExpensive"
                  >
                    G√ºnstigster Flug
                  </p>
                  <p
                    id="stat-least-expensive"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>

                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.longestFlight"
                  >
                    L√§ngster Flug
                  </p>
                  <p
                    id="stat-longest-flight"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.shortestFlight"
                  >
                    K√ºrzester Flug
                  </p>
                  <p
                    id="stat-shortest-flight"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.avgDistance"
                  >
                    √ò Flugdistanz
                  </p>
                  <p
                    id="stat-avg-distance"
                    class="text-xl font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    0 km
                  </p>
                </div>
                <div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
                  <p
                    class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.frequentAircraft"
                  >
                    H√§ufigster Flugzeugtyp
                  </p>
                  <p
                    id="stat-frequent-aircraft"
                    class="text-sm font-bold text-indigo-800 dark:text-indigo-400"
                  >
                    -
                  </p>
                </div>
				
				<div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm">
					<p class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.avgCo2">√ò CO‚ÇÇ pro Flug</p>
					<p id="stat-avg-co2" class="text-xl font-bold text-red-800 dark:text-red-400">0 kg</p>
				</div>
				<div class="p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm col-span-2 md:col-span-1">
					<p class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.totalCo2">Gesamter CO‚ÇÇ-Fu√üabdruck</p>
					<p id="stat-total-co2" class="text-xl font-bold text-red-800 dark:text-red-400">0 kg</p>
				</div>
				
                <div
                  class="col-span-2 md:col-span-4 p-2 bg-white dark:bg-gray-800 rounded-md shadow-sm"
                >
                  <div class="flex items-center justify-between">
                    <p
                      class="text-xs font-medium text-gray-700 dark:text-gray-400" data-i18n="stats.yearlySummary"
                    >
                      Jahreszusammenfassung
                    </p>
                    <select
                      id="stat-year-select"
                      class="text-xs p-1 rounded border-gray-300 dark:bg-gray-700 dark:border-gray-600"
                    ></select>
                  </div>
                  <p
                    id="stat-yearly-summary"
                    class="text-lg font-bold text-indigo-800 dark:text-indigo-400 mt-2"
                  >
                    -
                  </p>
                </div>
              </div>
            </div>
            <div id="tab-content-charts" class="hidden">
              <div
                class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700"
              >
                <div
                  class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-600 pb-2"
                >
                  <h2
                    class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-100" data-i18n="charts.title"
                  >
                    Visuelle Auswertungen
                  </h2>
                  <div class="flex items-center gap-2 text-sm">
                    <button
                      id="chart-view-year"
                      class="chart-view-btn active px-3 py-1 rounded-md transition" data-i18n="charts.perYear"
                    >
                      Pro Jahr
                    </button>
                    <button
                      id="chart-view-month"
                      class="chart-view-btn px-3 py-1 rounded-md transition" data-i18n="charts.perMonth"
                    >
                      Pro Monat
                    </button>
                  </div>
                </div>
                <div class="grid grid-cols-1 gap-8 mt-4">
                  <div>
                    <h3
                      class="font-semibold text-center text-gray-700 dark:text-gray-300 mb-2" data-i18n="charts.flightsOverTime"
                    >
                      Fl√ºge pro Zeitraum
                    </h3>
                    <canvas id="flightsChart"></canvas>
                  </div>
                  <div>
                    <h3
                      class="font-semibold text-center text-gray-700 dark:text-gray-300 mb-2" data-i18n="charts.distanceOverTime"
                    >
                      Distanz pro Zeitraum (km)
                    </h3>
                    <canvas id="distanceChart"></canvas>
                  </div>
                  <div>
                    <h3
                      class="font-semibold text-center text-gray-700 dark:text-gray-300 mb-2" data-i18n="charts.durationOverTime"
                    >
                      Flugzeit pro Zeitraum
                    </h3>
                    <canvas id="timeChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div id="tab-content-logbook" class="hidden">
              <div
                class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700"
              >
                <div
                  class="flex justify-between items-center mb-4 border-b border-gray-200 dark:border-gray-600 pb-2"
                >
                  <h2
                    class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-100" data-i18n="logbook.title"
                  >
                    Logbuch-Ansichten
                  </h2>
                  <div
                    id="logbook-nav"
                    class="flex flex-wrap items-center gap-2 text-sm"
                  >
                    <button
                      id="logbook-view-aircraft"
                      class="logbook-view-btn active px-3 py-1 rounded-md transition" data-i18n="logbook.byAircraft"
                    >
                      Nach Flugzeugtyp
                    </button>
                    <button
                      id="logbook-view-airline"
                      class="logbook-view-btn px-3 py-1 rounded-md transition" data-i18n="logbook.byAirline"
                    >
                      Nach Airline
                    </button>
                    <button
                      id="logbook-view-airport"
                      class="logbook-view-btn px-3 py-1 rounded-md transition" data-i18n="logbook.byAirport"
                    >
                      Nach Flughafen
                    </button>
					<button id="logbook-view-registration" class="logbook-view-btn px-3 py-1 rounded-md transition" data-i18n="logbook.byRegistration">
						Nach Registrierung
					</button>
                  </div>
                </div>
                <div id="logbook-content" class="mt-4 space-y-4"></div>
              </div>
            </div>

            <div id="tab-content-achievements" class="hidden">
              <div
                class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-gray-200 dark:border-gray-700"
              >
                <h2
                  class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4" data-i18n="achievements.title"
                >
                  Deine Errungenschaften
                </h2>
                <div
                  id="achievements-container"
                  class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
				</div>
				<h2 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-gray-100 mt-8 border-t dark:border-gray-700 pt-6 mb-4" data-i18n="achievements.recordsTitle"> 
                  Pers√∂nliche Rekorde & "Firsts"
                </h2>
                <div id="records-container" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="password-change-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-md"
      >
        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">
          Neues Passwort festlegen
        </h3>
        <form id="password-change-form" class="space-y-4">
          <div>
            <label
              for="new-password"
              class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Neues Passwort</label
            >
            <input
              type="password"
              id="new-password"
              placeholder="Mindestens 6 Zeichen"
              class="mt-1 w-full p-3 rounded-lg border-gray-300 dark:bg-gray-700 dark:border-gray-600"
            />
          </div>
          <div class="flex justify-end gap-4">
            <button
              type="button"
              onclick="closePasswordChangeModal(event)"
              class="px-4 py-2 bg-gray-200 dark:bg-gray-600 rounded-md hover:bg-gray-300 dark:hover:bg-gray-500 transition"
            >
              Abbrechen
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition"
            >
              Speichern
            </button>
          </div>
        </form>
      </div>
    </div>
	
	<div id="info-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-40">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center border-b pb-3 mb-4 dark:border-gray-700">
                <h3 id="info-modal-title" class="text-xl font-bold text-gray-800 dark:text-white">Modal-Titel</h3>
                <button onclick="closeInfoModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="info-modal-content" class="text-sm text-gray-700 dark:text-gray-300">
                <p>Lade Details...</p>
            </div>
        </div>
    </div>
	
	<div id="globe-modal" class="hidden fixed inset-0 w-full h-screen bg-black bg-opacity-70 z-40">
		<div id="globe-container" class="w-full h-full"></div>

		<button onclick="closeGlobeModal()" class="absolute top-4 right-4 text-white z-50 p-2 bg-black bg-opacity-30 rounded-full hover:bg-opacity-50 transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
		</button>
	</div>

	<input type="file" id="import-file-input" accept=".json" class="hidden">

    <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <script>
      // (JavaScript content follows)

      // =================================================================
      // INITIALISIERUNG & GLOBALE VARIABLEN
      // =================================================================

      const SUPABASE_URL = "https://sbmjdwktxsnmukbooycu.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNibWpkd2t0eHNubXVrYm9veWN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyOTczNDgsImV4cCI6MjA3NTg3MzM0OH0.NN9EHfS7iyAZvFm_UYs3PxEWj2pMbYmMduUeVA70rpo";
      const { createClient } = supabase;
      const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Objekt zur Zuordnung von ISO-L√§ndercodes zu Kontinenten
        const countryToContinent = {
            "AF": "Asien", "AX": "Europa", "AL": "Europa", "DZ": "Afrika", "AS": "Ozeanien", "AD": "Europa", "AO": "Afrika", "AI": "Nordamerika", "AQ": "Antarktis", "AG": "Nordamerika",
            "AR": "S√ºdamerika", "AM": "Asien", "AW": "Nordamerika", "AU": "Ozeanien", "AT": "Europa", "AZ": "Asien", "BS": "Nordamerika", "BH": "Asien", "BD": "Asien", "BB": "Nordamerika",
            "BY": "Europa", "BE": "Europa", "BZ": "Nordamerika", "BJ": "Afrika", "BM": "Nordamerika", "BT": "Asien", "BO": "S√ºdamerika", "BA": "Europa", "BW": "Afrika", "BR": "S√ºdamerika",
            "IO": "Asien", "BG": "Europa", "BF": "Afrika", "BI": "Afrika", "KH": "Asien", "CM": "Afrika", "CA": "Nordamerika", "CV": "Afrika", "KY": "Nordamerika", "CF": "Afrika",
            "TD": "Afrika", "CL": "S√ºdamerika", "CN": "Asien", "CX": "Asien", "CC": "Asien", "CO": "S√ºdamerika", "KM": "Afrika", "CG": "Afrika", "CD": "Afrika", "CK": "Ozeanien",
            "CR": "Nordamerika", "CI": "Afrika", "HR": "Europa", "CU": "Nordamerika", "CY": "Asien", "CZ": "Europa", "DK": "Europa", "DJ": "Afrika", "DM": "Nordamerika", "DO": "Nordamerika",
            "EC": "S√ºdamerika", "EG": "Afrika", "SV": "Nordamerika", "GQ": "Afrika", "ER": "Afrika", "EE": "Europa", "ET": "Afrika", "FK": "S√ºdamerika", "FO": "Europa", "FJ": "Ozeanien",
            "FI": "Europa", "FR": "Europa", "GF": "S√ºdamerika", "PF": "Ozeanien", "GA": "Afrika", "GM": "Afrika", "GE": "Asien", "DE": "Europa", "GH": "Afrika", "GI": "Europa",
            "GR": "Europa", "GL": "Nordamerika", "GD": "Nordamerika", "GP": "Nordamerika", "GU": "Ozeanien", "GT": "Nordamerika", "GG": "Europa", "GN": "Afrika", "GW": "Afrika", "GY": "S√ºdamerika",
            "HT": "Nordamerika", "HN": "Nordamerika", "HK": "Asien", "HU": "Europa", "IS": "Europa", "IN": "Asien", "ID": "Asien", "IR": "Asien", "IQ": "Asien", "IE": "Europa",
            "IM": "Europa", "IL": "Asien", "IT": "Europa", "JM": "Nordamerika", "JP": "Asien", "JE": "Europa", "JO": "Asien", "KZ": "Asien", "KE": "Afrika", "KI": "Ozeanien",
            "KP": "Asien", "KR": "Asien", "KW": "Asien", "KG": "Asien", "LA": "Asien", "LV": "Europa", "LB": "Asien", "LS": "Afrika", "LR": "Afrika", "LY": "Afrika", "LI": "Europa",
            "LT": "Europa", "LU": "Europa", "MO": "Asien", "MK": "Europa", "MG": "Afrika", "MW": "Afrika", "MY": "Asien", "MV": "Asien", "ML": "Afrika", "MT": "Europa", "MH": "Ozeanien",
            "MQ": "Nordamerika", "MR": "Afrika", "MU": "Afrika", "YT": "Afrika", "MX": "Nordamerika", "FM": "Ozeanien", "MD": "Europa", "MC": "Europa", "MN": "Asien", "ME": "Europa",
            "MS": "Nordamerika", "MA": "Afrika", "MZ": "Afrika", "MM": "Asien", "NA": "Afrika", "NR": "Ozeanien", "NP": "Asien", "NL": "Europa", "NC": "Ozeanien", "NZ": "Ozeanien",
            "NI": "Nordamerika", "NE": "Afrika", "NG": "Afrika", "NU": "Ozeanien", "NF": "Ozeanien", "MP": "Ozeanien", "NO": "Europa", "OM": "Asien", "PK": "Asien", "PW": "Ozeanien",
            "PS": "Asien", "PA": "Nordamerika", "PG": "Ozeanien", "PY": "S√ºdamerika", "PE": "S√ºdamerika", "PH": "Asien", "PN": "Ozeanien", "PL": "Europa", "PT": "Europa", "PR": "Nordamerika",
            "QA": "Asien", "RE": "Afrika", "RO": "Europa", "RU": "Europa", "RW": "Afrika", "BL": "Nordamerika", "SH": "Afrika", "KN": "Nordamerika", "LC": "Nordamerika", "MF": "Nordamerika",
            "PM": "Nordamerika", "VC": "Nordamerika", "WS": "Ozeanien", "SM": "Europa", "ST": "Afrika", "SA": "Asien", "SN": "Afrika", "RS": "Europa", "SC": "Afrika", "SL": "Afrika",
            "SG": "Asien", "SX": "Nordamerika", "SK": "Europa", "SI": "Europa", "SB": "Ozeanien", "SO": "Afrika", "ZA": "Afrika", "GS": "Antarktis", "SS": "Afrika", "ES": "Europa",
            "LK": "Asien", "SD": "Afrika", "SR": "S√ºdamerika", "SJ": "Europa", "SZ": "Afrika", "SE": "Europa", "CH": "Europa", "SY": "Asien", "TW": "Asien", "TJ": "Asien", "TZ": "Afrika",
            "TH": "Asien", "TL": "Asien", "TG": "Afrika", "TK": "Ozeanien", "TO": "Ozeanien", "TT": "Nordamerika", "TN": "Afrika", "TR": "Asien", "TM": "Asien", "TC": "Nordamerika",
            "TV": "Ozeanien", "UG": "Afrika", "UA": "Europa", "AE": "Asien", "GB": "Europa", "US": "Nordamerika", "UY": "S√ºdamerika", "UZ": "Asien", "VU": "Ozeanien", "VE": "S√ºdamerika",
            "VN": "Asien", "VG": "Nordamerika", "VI": "Nordamerika", "WF": "Ozeanien", "EH": "Afrika", "YE": "Asien", "ZM": "Afrika", "ZW": "Afrika"
        };
		
	  // Achievements
      const achievements = {
            flights: [
                { milestone: 1, emoji: 'üéâ', key: '1' },
                { milestone: 10, emoji: '‚úàÔ∏è', key: '10' },
                { milestone: 25, emoji: 'üõ´', key: '25' },
                { milestone: 50, emoji: 'üåç', key: '50' },
                { milestone: 100, emoji: 'üíØ', key: '100' },
                { milestone: 150, emoji: 'üåü', key: '150' },
                { milestone: 250, emoji: 'üèÜ', key: '250' },
                { milestone: 500, emoji: 'üöÄ', key: '500' },
                { milestone: 750, emoji: 'üíé', key: '750' },
                { milestone: 1000, emoji: 'üåå', key: '1000' }
            ],
            distance: [
                { milestone: 10000, emoji: 'üèÉ', key: '10000' },
                { milestone: 40075, emoji: 'üåê', key: '40075' },
                { milestone: 100000, emoji: '‚ú®', key: '100000' },
                { milestone: 250000, emoji: 'üèÖ', key: '250000' },
                { milestone: 384400, emoji: 'üåï', key: '384400' },
                { milestone: 500000, emoji: 'üå†', key: '500000' },
                { milestone: 768800, emoji: 'üõ∞Ô∏è', key: '768800' },
                { milestone: 1000000, emoji: 'üí•', key: '1000000' }
            ],
            time: [
                { milestone: 24, emoji: '‚òÄÔ∏è', key: '24' },
                { milestone: 100, emoji: 'üóìÔ∏è', key: '100' },
                { milestone: 500, emoji: 'üï∞Ô∏è', key: '500' },
                { milestone: 1000, emoji: '‚è≥', key: '1000' },
                { milestone: 2500, emoji: '‚ú®', key: '2500' },
                { milestone: 8760, emoji: 'üí´', key: '8760' }
            ],
            uniqueAirports: [
                { milestone: 10, emoji: 'üó∫Ô∏è', key: '10' },
                { milestone: 25, emoji: 'üß≠', key: '25' },
                { milestone: 50, emoji: 'üèõÔ∏è', key: '50' },
                { milestone: 100, emoji: 'üóΩ', key: '100' }
            ],
            longestFlight: [
                { milestone: 3000, emoji: '‚úàÔ∏è', key: '3000' },
                { milestone: 5000, emoji: 'üõ´', key: '5000' },
                { milestone: 8000, emoji: 'üåä', key: '8000' },
                { milestone: 12000, emoji: 'üöÄ', key: '12000' }
            ],
            co2_total: [
                { milestone: 1000, emoji: 'üí®', key: '1000' },
                { milestone: 5000, emoji: 'üåç', key: '5000' },
                { milestone: 10000, emoji: 'üìà', key: '10000' },
                { milestone: 50000, emoji: 'üè≠', key: '50000' },
                { milestone: 100000, emoji: 'üö®', key: '100000' }
            ]
        };

      let animationState = 'stopped'; // M√∂gliche Zust√§nde: 'stopped', 'running', 'paused'
	  let animationStartIndex = 0;    // Speichert, bei welchem Flug wir pausiert haben
	  let map;
      let routeLayer;
      let currentlyEditingFlightData = null;
      let isAllRoutesViewActive = false;
      let currentSort = { key: "flightLogNumber", direction: "asc" };
      let currentPage = 1;
      const ITEMS_PER_PAGE = 5;
      let flightsChartInstance, distanceChartInstance, timeChartInstance;
      let currentChartTimeframe = "year";
      let isAppInitialized = false; // SCHUTZSCHALTER
	  let currentLanguage = 'de'; // Standard-Sprache
      let translations = {}; // Leeres Objekt, das die geladene Sprache h√§lt
	  let globeInstance = null;
	  
      var airportData = {
        FRA: {
          name: "Frankfurt",
          city: "Frankfurt",
          lat: 50.0333,
          lon: 8.5706,
        },
        MUC: { name: "M√ºnchen", city: "Munich", lat: 48.3538, lon: 11.7861 },
        BER: {
          name: "Berlin Brandenburg",
          city: "Berlin",
          lat: 52.3667,
          lon: 13.5033,
        },
        HAM: { name: "Hamburg", city: "Hamburg", lat: 53.6304, lon: 9.9882 },
        DUS: {
          name: "D√ºsseldorf",
          city: "Dusseldorf",
          lat: 51.2895,
          lon: 6.7667,
        },
        VIE: { name: "Wien", city: "Vienna", lat: 48.1103, lon: 16.5697 },
        ZRH: { name: "Z√ºrich", city: "Zurich", lat: 47.4647, lon: 8.5492 },
        AMS: {
          name: "Amsterdam Schiphol",
          city: "Amsterdam",
          lat: 52.3086,
          lon: 4.7638,
        },
        LHR: {
          name: "London Heathrow",
          city: "London",
          lat: 51.47,
          lon: -0.4543,
        },
        CDG: {
          name: "Paris Charles de Gaulle",
          city: "Paris",
          lat: 49.0097,
          lon: 2.5479,
        },
        IST: { name: "Istanbul", city: "Istanbul", lat: 41.2619, lon: 28.7361 },
        JFK: {
          name: "New York JFK",
          city: "New York",
          lat: 40.6413,
          lon: -73.7781,
        },
        LAX: {
          name: "Los Angeles Intl",
          city: "Los Angeles",
          lat: 33.9416,
          lon: -118.4085,
        },
        ATL: {
          name: "Atlanta Intl",
          city: "Atlanta",
          lat: 33.6407,
          lon: -84.4277,
        },
        DXB: { name: "Dubai Intl", city: "Dubai", lat: 25.2532, lon: 55.3653 },
        SIN: {
          name: "Singapur Changi",
          city: "Singapore",
          lat: 1.3644,
          lon: 103.9915,
        },
        NRT: {
          name: "Tokio Narita",
          city: "Tokyo",
          lat: 35.7647,
          lon: 140.3864,
        },
        SYD: {
          name: "Sydney Intl",
          city: "Sydney",
          lat: -33.9461,
          lon: 151.1772,
        },
        HND: {
          name: "Tokio Haneda",
          city: "Tokyo",
          lat: 35.5523,
          lon: 139.7797,
        },
        ICN: {
          name: "Seoul Incheon",
          city: "Seoul",
          lat: 37.4692,
          lon: 126.4505,
        },
        PEK: {
          name: "Peking Capital",
          city: "Beijing",
          lat: 40.0799,
          lon: 116.6031,
        },
        PVG: {
          name: "Shanghai Pudong",
          city: "Shanghai",
          lat: 31.1434,
          lon: 121.7876,
        },
        DFW: {
          name: "Dallas/Fort Worth",
          city: "Dallas",
          lat: 32.8998,
          lon: -97.0403,
        },
        ORD: {
          name: "Chicago O'Hare",
          city: "Chicago",
          lat: 41.9742,
          lon: -87.9073,
        },
        MAD: {
          name: "Madrid Barajas",
          city: "Madrid",
          lat: 40.4839,
          lon: -3.5679,
        },
        BCN: {
          name: "Barcelona-El Prat",
          city: "Barcelona",
          lat: 41.2974,
          lon: 2.0787,
        },
        FCO: {
          name: "Rom Fiumicino",
          city: "Rome",
          lat: 41.8003,
          lon: 12.2389,
        },
        DOH: {
          name: "Doha Hamad Intl",
          city: "Doha",
          lat: 25.273,
          lon: 51.608,
        },
        GRU: {
          name: "S√£o Paulo Guarulhos",
          city: "Sao Paulo",
          lat: -23.4356,
          lon: -46.4731,
        },
        CPT: {
          name: "Kapstadt",
          city: "Cape Town",
          lat: -33.9692,
          lon: 18.6017,
        },
        JNB: {
          name: "Johannesburg OR Tambo",
          city: "Johannesburg",
          lat: -26.1367,
          lon: 28.2435,
        },
        SFO: {
          name: "San Francisco Intl",
          city: "San Francisco",
          lat: 37.6213,
          lon: -122.379,
        },
      };

      // =================================================================
      // AUTH & APP INITIALIZATION FUNCTIONS
      // =================================================================

		/**
         * √ñffnet das universelle Info-Modal.
         */
        function openInfoModal() {
            document.getElementById('info-modal').classList.remove('hidden');
            document.getElementById('info-modal').classList.add('flex');
        }

        /**
         * Schlie√üt das universelle Info-Modal und setzt den Inhalt zur√ºck.
         */
        function closeInfoModal() {
            document.getElementById('info-modal').classList.add('hidden');
            document.getElementById('info-modal').classList.remove('flex');
            document.getElementById('info-modal-title').textContent = 'Lade...';
            document.getElementById('info-modal-content').innerHTML = '<p>Lade Details...</p>';
        }
		
		/**
		 * Schlie√üt das 3D-Globus-Modal.
		 */
		function closeGlobeModal() {
			document.getElementById('globe-modal').classList.add('hidden');
			// Stoppt die Animation, um CPU zu sparen
			if (globeInstance) {
				globeInstance.controls().autoRotate = false;
			}
		}

		/**
		 * Bereitet die Flugdaten f√ºr den 3D-Globus auf.
		 */
		async function getGlobeData() {
			const allFlights = await getFlights();

			// Verarbeite die Fl√ºge: Wir brauchen nur Start- und End-Koordinaten
			const arcData = allFlights
				.filter(f => f.depLat && f.arrLat) // Nur Fl√ºge mit Koordinaten
				.map(flight => ({
					startLat: flight.depLat,
					startLng: flight.depLon,
					endLat: flight.arrLat,
					endLng: flight.arrLon,
					name: `${flight.departure} ‚Üí ${flight.arrival}` // F√ºr Tooltips
				}));
			return arcData;
		}

		/**
		 * √ñffnet das Globus-Modal und initialisiert/aktualisiert den 3D-Globus.
		 */
		async function openGlobeModal() {
			document.getElementById('globe-modal').classList.remove('hidden');

			// Daten abrufen
			const globeData = await getGlobeData();

			// Globus nur beim ersten Mal initialisieren
			if (!globeInstance) {
				globeInstance = Globe()
					(document.getElementById('globe-container'))
					.backgroundColor('rgba(0,0,0,0)') // Transparenter Hintergrund
					.globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
					.arcLabel('name') // Zeigt den Namen beim Hovern
					.arcColor(() => '#9333ea') // Lila Farbe (Tailwind purple-600)
					.arcDashLength(0.4)      // L√§nge der gestrichelten Linie
					.arcDashGap(0.2)         // Abstand
					.arcDashAnimateTime(1500) // Animationsgeschwindigkeit
					.arcStroke(0.5)          // Linienst√§rke
					.arcsTransitionDuration(500); // Wie schnell neue Linien erscheinen

				// Zoom-Steuerung und Rotation
				globeInstance.controls().autoRotate = true;
				globeInstance.controls().autoRotateSpeed = 0.2;
				globeInstance.controls().enableZoom = true; // Zoomen erlauben
			}

			// Daten an den Globus √ºbergeben und Animation starten
			globeInstance.arcsData(globeData);
			globeInstance.controls().autoRotate = true;
		}
	
		/**
         * Ruft Details f√ºr einen Flughafen ab und zeigt sie im Modal an.
         * @param {string} iataCode - Der IATA-Code des Flughafens (z.B. "DRS").
		 * FR24
         */
		async function showAirportDetails(iataCode, silentCache = false) {
    if (!silentCache) {
        openInfoModal();
        document.getElementById('info-modal-title').textContent = getTranslation('modalDetails.airportTitle').replace('{key}', iataCode);
        const contentContainer = document.getElementById('info-modal-content');
        contentContainer.innerHTML = `<p>${getTranslation('modalDetails.loading')}</p>`;
    }

    try {
        // Wir verwenden unsere GFL-Funktion
        const response = await fetch(`https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-airport-details?code=${iataCode}`);
        if (!response.ok) {
            throw new Error('Netzwerk-Antwort war nicht OK');
        }
        const result = await response.json();

        if (result.data && result.data.length > 0) {
            const airport = result.data[0];

            // Speichere die Infos (inkl. country_code) in DB & Cache
            await cacheAndSaveAirport({
                code: iataCode,
                name: airport.name,
                lat: airport.lat,
                lon: airport.lng,
                city: airport.city,
                country_code: airport.country_code
            });

            if (!silentCache) {
                const content = `
                    <p><strong>${getTranslation('modalDetails.airportName')}</strong> ${airport.name}</p>
                    <p><strong>${getTranslation('modalDetails.airportLocation')}</strong> ${airport.city}, ${airport.country_code}</p>
                    <p><strong>${getTranslation('modalDetails.airportTimezone')}</strong> ${airport.timezone}</p>
                    <p><strong>${getTranslation('modalDetails.airportCoords')}</strong> Lat: ${airport.lat}, Lng: ${airport.lng}</p>
                    <p class="mt-2"><a href="${airport.website}" target="_blank" class="text-indigo-500 hover:underline">${getTranslation('modalDetails.airportWebsite')}</a></p>
                `;
                document.getElementById('info-modal-content').innerHTML = content;
            }
        } else if (!silentCache) {
            document.getElementById('info-modal-content').innerHTML = `<p>${getTranslation('modalDetails.airportNoDetails')}</p>`;
        }
    } catch (error) {
        console.error("Fehler beim Abrufen der Flughafen-Details:", error);
        if (!silentCache) {
            document.getElementById('info-modal-content').innerHTML = `<p>${getTranslation('modalDetails.airportError')}</p>`;
        }
    }
}
		
		/**
         * Ruft Details f√ºr einen Flugzeugtyp ab und zeigt sie im Modal an.
         * @param {string} model - Das Flugzeugmodell (z.B. "A320").
         */
		 /**
        async function showAircraftDetails(model) {
            openInfoModal();
            document.getElementById('info-modal-title').textContent = getTranslation('modalDetails.aircraftTitle').replace('{key}', model);
            const contentContainer = document.getElementById('info-modal-content');
            contentContainer.innerHTML = `<p>${getTranslation('modalDetails.loading')}</p>`;

            try {
                const response = await fetch(`https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-aircraft-details?model=${model}`);
                if (!response.ok) {
                    throw new Error('Netzwerk-Antwort war nicht OK');
                }
                const result = await response.json();
                
                if (result && result.length > 0) {
                    const aircraft = result[0]; 
                    const notAvailable = getTranslation('modalDetails.notAvailable');
                    
                    const speed_kmh = aircraft.max_speed_knots ? (parseFloat(aircraft.max_speed_knots) * 1.852).toFixed(0) : null;
                    const ceiling_m = aircraft.ceiling_ft ? (parseFloat(aircraft.ceiling_ft) * 0.3048).toFixed(0) : null;
                    const weight_kg = aircraft.gross_weight_lbs ? (parseFloat(aircraft.gross_weight_lbs) * 0.453592).toFixed(0) : null;
                    const length_m = aircraft.length_ft ? (parseFloat(aircraft.length_ft) * 0.3048).toFixed(1) : null;
                    const wingspan_m = aircraft.wing_span_ft ? (parseFloat(aircraft.wing_span_ft) * 0.3048).toFixed(1) : null;
                    const range_km = aircraft.range_nautical_miles ? (parseFloat(aircraft.range_nautical_miles) * 1.852).toFixed(0) : null;
                    
                    const content = `
                        <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                            <p><strong>${getTranslation('modalDetails.aircraftManufacturer')}</strong></p> 
                            <p>${aircraft.manufacturer || notAvailable}</p>
                            
                            <p><strong>${getTranslation('modalDetails.aircraftModel')}</strong></p> 
                            <p>${aircraft.model || notAvailable}</p>
                            
                            <p><strong>${getTranslation('modalDetails.aircraftEngineType')}</strong></p> 
                            <p>${aircraft.engine_type || notAvailable}</p>
                            
                            <p><strong>${getTranslation('modalDetails.aircraftEngineCount')}</strong></p> 
                            <p>${aircraft.engines_count || notAvailable}</p>
                            
                            <p class="col-span-2 mt-2 pt-2 border-t dark:border-gray-700"></p>

                            <p><strong>${getTranslation('modalDetails.aircraftSpeed')}</strong></p> 
                            <p>${speed_kmh ? speed_kmh.toLocaleString('de-DE') : notAvailable}</p>
                            
                            <p><strong>${getTranslation('modalDetails.aircraftRange')}</strong></p> 
                            <p>${range_km ? range_km.toLocaleString('de-DE') : notAvailable}</p>
                            
                            <p><strong>${getTranslation('modalDetails.aircraftCeiling')}</strong></p> 
                            <p>${ceiling_m ? ceiling_m.toLocaleString('de-DE') : notAvailable}</p>
                            
                            <p><strong>${getTranslation('modalDetails.aircraftLength')}</strong></p> 
                            <p>${length_m ? length_m : notAvailable}</p>
                            
                            <p><strong>${getTranslation('modalDetails.aircraftWingspan')}</strong></p> 
                            <p>${wingspan_m ? wingspan_m : notAvailable}</p>
                            
                            <p><strong>${getTranslation('modalDetails.aircraftWeight')}</strong></p> 
                            <p>${weight_kg ? weight_kg.toLocaleString('de-DE') + ' kg' : notAvailable}</p>
                        </div>
                    `;
                    contentContainer.innerHTML = content;
                } else {
                    contentContainer.innerHTML = `<p>${getTranslation('modalDetails.aircraftNoDetails')}</p>`;
                }
            } catch (error) {
                console.error("Fehler beim Abrufen der Flugzeug-Details:", error);
                contentContainer.innerHTML = `<p>${getTranslation('modalDetails.aircraftError')}</p>`;
            }
        }
		 */
		
		/**
         * Ruft Details f√ºr einen Airline-Code ab und zeigt sie im Modal an.
         * @param {string} iataCode - Der IATA-Code der Airline (z.B. "LH").
         */
        async function showAirlineDetails(iataCode) {
            openInfoModal();
            document.getElementById('info-modal-title').textContent = getTranslation('modalDetails.airlineTitle').replace('{key}', iataCode);
            const contentContainer = document.getElementById('info-modal-content');
            contentContainer.innerHTML = `<p>${getTranslation('modalDetails.loading')}</p>`;

            try {
                const response = await fetch(`https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-airline-details?iata_code=${iataCode}`);
                if (!response.ok) {
                    throw new Error('Netzwerk-Antwort war nicht OK');
                }
                const result = await response.json(); // result ist { "success": true, "data": [...] }

                // --- HIER IST DIE KORREKTUR ---
                // Wir pr√ºfen auf 'result.data', nicht 'result.response.data'
                if (result.data && result.data.length > 0) {
                    let content = '';
                    const notAvailable = getTranslation('modalDetails.notAvailable');
                    
                    // Die API kann mehrere Airlines zur√ºckgeben (z.B. Lufthansa & Lufthansa Cargo)
                    result.data.forEach((airline, index) => {
                        if (index > 0) {
                            content += '<hr class="my-4 dark:border-gray-700">';
                        }

                        content += `
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                                <p><strong>${getTranslation('modalDetails.airlineName')}</strong></p> 
                                <p>${airline.name || notAvailable} <strong>(${airline.iata_code || '?'})</strong></p>
                                
                                <p><strong>${getTranslation('modalDetails.airlineCountry')}</strong></p> 
                                <p>${airline.country_code || notAvailable}</p>
                                
                                <p><strong>${getTranslation('modalDetails.airlineIcao')}</strong></p> 
                                <p>${airline.icao_code || notAvailable}</p>
                                
                                <p><strong>${getTranslation('modalDetails.airlineCallsign')}</strong></p> 
                                <p>${airline.callsign || notAvailable}</p>

                                <p><strong>${getTranslation('modalDetails.airlineFleetSize')}</strong></p> 
                                <p>${airline.total_aircrafts || notAvailable}</p>

                                <p><strong>${getTranslation('modalDetails.airlineFleetAge')}</strong></p> 
                                <p>${airline.average_fleet_age ? `${airline.average_fleet_age} ${getTranslation('modalDetails.airlineAgeUnit')}` : notAvailable}</p>
                                
                                <p class="mt-2 col-span-2"><a href="https://${airline.website}" target="_blank" class="text-indigo-500 hover:underline">${getTranslation('modalDetails.airlineWebsite')}</a></p>
                            </div>
                        `;
                    });
                    
                    contentContainer.innerHTML = content;
                } else {
                    // Dieser Block wird jetzt nur noch ausgef√ºhrt, wenn 'result.data' leer ist
                    contentContainer.innerHTML = `<p>${getTranslation('modalDetails.airlineNoDetails')}</p>`;
                }
            } catch (error) {
                console.error("Fehler beim Abrufen der Airline-Details:", error);
                contentContainer.innerHTML = `<p>${getTranslation('modalDetails.airlineError')}</p>`;
            }
        }

      async function initializeApp() {
        if (isAppInitialized) return;
        isAppInitialized = true;
		
		// Kann wieder entfernt werden:
		// const preferredLanguage = localStorage.getItem('preferredLanguage') || 'de';
		// await setLanguage(preferredLanguage);

        document.getElementById("auth-container").classList.add("hidden");
        document.getElementById("app-container").classList.remove("hidden");

        try {
          const {
            data: { user },
          } = await supabaseClient.auth.getUser();
          if (user) {
            const userDisplay = document.getElementById("user-display");
            if (userDisplay) {
              userDisplay.textContent = user.email;
            }
          }
        } catch (e) {
          console.error("Fehler beim Abrufen des Benutzers:", e);
        }

        await migrateAndLoadAirports();

        if (!map) {
          map = L.map("flight-map-container").setView([20, 0], 2);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution:
              '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          }).addTo(map);
          routeLayer = L.layerGroup().addTo(map);
        }

        // --- Event-Listener: ---

		// Listener f√ºr Flight-Number:
        document.getElementById('autofill-btn').addEventListener('click', autofillFlightData);

        // Listener f√ºr das neue Burger-Men√º
        document
          .getElementById("burger-menu-btn")
          .addEventListener("click", toggleBurgerMenu);
        document
          .getElementById("menu-logout-btn")
          .addEventListener("click", logout);
        document
          .getElementById("menu-theme-toggle")
          .addEventListener("click", toggleDarkMode);

        // Listener, um das Men√º zu schlie√üen, wenn man daneben klickt
        document.addEventListener("click", function (event) {
          const menu = document.getElementById("burger-menu");
          const menuBtn = document.getElementById("burger-menu-btn");
          // Pr√ºfe, ob das Men√º offen ist UND der Klick au√üerhalb des Men√ºs und des Buttons war
          if (
            !menu.classList.contains("hidden") &&
            !menu.contains(event.target) &&
            !menuBtn.contains(event.target)
          ) {
            toggleBurgerMenu();
          }
        });

        // Alle anderen, weiterhin g√ºltigen Listener
		document.getElementById('play-chronicle-btn').addEventListener('click', animateTravelChronicle);
        document.getElementById("flightClass").addEventListener("change", updateFlightDetails);
		document
          .getElementById("chart-view-year")
          .addEventListener("click", () => setChartTimeframe("year"));
        document
          .getElementById("chart-view-month")
          .addEventListener("click", () => setChartTimeframe("month"));
        document
          .getElementById("password-change-form")
          .addEventListener("submit", changePassword);
        document.getElementById('flightPhoto').addEventListener('change', (event) => {
    const files = event.target.files;
    const previewText = document.getElementById('photo-preview-text');

    if (files && files.length > 0) {
        // Verwendet den i18n-Schl√ºssel und ersetzt {count}
        previewText.textContent = getTranslation('form.filesSelected').replace('{count}', files.length);
    } else {
        // Setzt den Text auf den Standard-i18n-Text zur√ºck
        previewText.textContent = getTranslation('form.noFileSelected');
    }
});
        document.getElementById("departure").addEventListener("input", () => {
          updateAutocompleteList("departure", "departure-list");
          updateFlightDetails();
        });
        document.getElementById("arrival").addEventListener("input", () => {
          updateAutocompleteList("arrival", "arrival-list");
          updateFlightDetails();
        });
        document
          .getElementById("logbook-view-aircraft")
          .addEventListener("click", () => renderLogbookView("aircraftType"));
        document
          .getElementById("logbook-view-airline")
          .addEventListener("click", () => renderLogbookView("airline"));
        document
          .getElementById("logbook-view-airport")
          .addEventListener("click", () => renderLogbookView("airport"));
		document
		  .getElementById("logbook-view-registration")
		  .addEventListener("click", () => renderLogbookView("registration"));
		  
		document.getElementById('import-file-input').addEventListener('change', handleImport);
		
		document.getElementById('show-globe-btn').addEventListener('click', openGlobeModal);

        // --- ENDE Event-Listener ---

        // Initiales Rendern der App
        showTab("neue-fluege");
        renderFlights();
        displayAppVersion();
      }

      function showAuth() {
        document.getElementById("auth-container").classList.remove("hidden");
        document.getElementById("app-container").classList.add("hidden");
      }

      function switchAuthTab(tab) {
        const loginTab = document.getElementById("login-tab");
        const registerTab = document.getElementById("register-tab");
        const loginForm = document.getElementById("login-form");
        const registerForm = document.getElementById("register-form");
        document.getElementById("auth-error").textContent = "";

        if (tab === "login") {
          loginTab.classList.add("active-tab");
          registerTab.classList.remove("active-tab");
          loginForm.classList.remove("hidden");
          registerForm.classList.add("hidden");
        } else {
          loginTab.classList.remove("active-tab");
          registerTab.classList.add("active-tab");
          loginForm.classList.add("hidden");
          registerForm.classList.remove("hidden");
        }
      }

      async function logout() {
        const { error } = await supabaseClient.auth.signOut();
        if (error) {
          console.error("Error logging out:", error);
          showMessage("Logout-Fehler", error.message, "error");
        } else {
          window.location.reload();
        }
      }

      function showPasswordChangeModal() {
        document.getElementById("new-password").value = "";
        document
          .getElementById("password-change-modal")
          .classList.remove("hidden");
        document.getElementById("password-change-modal").classList.add("flex");
      }

      function closePasswordChangeModal(event) {
        if (event) {
          event.preventDefault(); // Verhindert jegliche Standard-Button-Aktion
        }
        document
          .getElementById("password-change-modal")
          .classList.add("hidden");
        document
          .getElementById("password-change-modal")
          .classList.remove("flex");
      }

      async function changePassword(event) {
        event.preventDefault();
        const newPassword = document.getElementById("new-password").value;

        if (newPassword.length < 6) {
          showMessage(
            "Fehler",
            "Das Passwort muss mindestens 6 Zeichen lang sein.",
            "error"
          );
          return;
        }

        try {
          const { error } = await supabaseClient.auth.updateUser({
            password: newPassword,
          });

          if (error) {
            // F√§ngt "normale" Supabase-Fehler ab (z.B. "Passwort zu schwach")
            throw error;
          }

          // Dieser Teil wird jetzt wieder erreicht werden
          showMessage(
            "Erfolg!",
            "Dein Passwort wurde erfolgreich ge√§ndert.",
            "success"
          );
          closePasswordChangeModal();
        } catch (error) {
          // F√§ngt JEDEN denkbaren Fehler ab, auch Netzwerkprobleme oder unerwartetes Verhalten
          showMessage(
            "Fehler",
            "Das Passwort konnte nicht ge√§ndert werden.",
            "error"
          );
          console.error(
            "Ein unerwarteter Fehler ist beim Passwort-Update aufgetreten:",
            error
          );
        }
      }

      function showPasswordResetForm() {
        document.getElementById("auth-tabs").classList.add("hidden");
        document.getElementById("login-form").classList.add("hidden");
        document.getElementById("register-form").classList.add("hidden");
        document
          .getElementById("password-reset-container")
          .classList.remove("hidden");
        document
          .getElementById("request-reset-form")
          .classList.remove("hidden");
        document.getElementById("update-password-form").classList.add("hidden");
        document.getElementById("auth-error").textContent = "";
      }

      function backToLogin() {
        document.getElementById("auth-tabs").classList.remove("hidden");
        document
          .getElementById("password-reset-container")
          .classList.add("hidden");
        switchAuthTab("login");
      }

      // =================================================================
      // DATA MIGRATION & LOADING FUNCTIONS
      // =================================================================

      async function migrateDataToSupabase() {
        if (localStorage.getItem("supabase_migrated") === "true") {
          return;
        }
        console.log(
          "Starte einmalige Datenmigration von localStorage nach Supabase..."
        );
        const oldFlightsJson = localStorage.getItem("flightLog");
        const oldFlights = oldFlightsJson ? JSON.parse(oldFlightsJson) : [];
        if (oldFlights.length > 0) {
          const flightsToInsert = oldFlights.map((flight) => {
            return {
              flight_id: flight.id,
              date: flight.date,
              departure: flight.departure,
              arrival: flight.arrival,
              distance: flight.distance,
              time: flight.time,
              class: flight.class,
              flightNumber: flight.flightNumber,
              aircraftType: flight.aircraftType,
              notes: flight.notes,
              depLat: flight.depLat,
              depLon: flight.depLon,
              arrLat: flight.arrLat,
              arrLon: flight.arrLon,
              depName: flight.depName,
              arrName: flight.arrName,
              flightLogNumber: flight.flightLogNumber,
            };
          });
          const { error } = await supabaseClient
            .from("flights")
            .insert(flightsToInsert);
          if (error) {
            console.error("Fehler bei der Migration:", error);
            showMessage(
              "Migrations-Fehler",
              "Daten konnten nicht zu Supabase migriert werden.",
              "error"
            );
          } else {
            console.log("Migration erfolgreich!");
            localStorage.setItem("supabase_migrated", "true");
          }
        } else {
          localStorage.setItem("supabase_migrated", "true");
        }
      }

      async function migrateAndLoadAirports() {
        if (localStorage.getItem("airports_migrated") !== "true") {
          console.log(
            "Starte einmalige Migration der Flugh√§fen von localStorage nach Supabase..."
          );
          const cachedAirportsJSON = localStorage.getItem("cachedAirports");
          const cachedAirports = cachedAirportsJSON
            ? JSON.parse(cachedAirportsJSON)
            : {};
          const airportsToInsert = Object.keys(cachedAirports).map((iata) => ({
            iata: iata,
            name: cachedAirports[iata].name,
            lat: cachedAirports[iata].lat,
            lon: cachedAirports[iata].lon,
          }));
          if (airportsToInsert.length > 0) {
            const { error } = await supabaseClient
              .from("airports")
              .insert(airportsToInsert);
            if (error) {
              console.error("Fehler bei der Flughafen-Migration:", error);
            } else {
              console.log("Flughafen-Migration erfolgreich!");
              localStorage.setItem("airports_migrated", "true");
              localStorage.removeItem("cachedAirports");
            }
          } else {
            localStorage.setItem("airports_migrated", "true");
          }
        }
        const { data, error } = await supabaseClient
          .from("airports")
          .select("*");
        if (error) {
          console.error("Fehler beim Laden der Flugh√§fen aus Supabase:", error);
          return;
        }
        // Wandle die geladenen Daten in das Format um, das 'airportData' erwartet
        data.forEach((airport) => {
          airportData[airport.iata] = {
            name: airport.name,
            lat: airport.lat,
            lon: airport.lon,
            city: airport.city,
			country_code: airport.country_code
          };
        });
        console.log(`${data.length} Flugh√§fen aus der Datenbank geladen.`);
      }

      async function claimExistingFlights() {
        if (localStorage.getItem("flights_claimed") === "true") {
          return;
        }
        const {
          data: { user },
        } = await supabaseClient.auth.getUser();
        if (user) {
          console.log(
            `Beanspruche bestehende Fl√ºge f√ºr Benutzer ${user.id}...`
          );
          const { error } = await supabaseClient
            .from("flights")
            .update({ user_id: user.id })
            .is("user_id", null);
          if (error) {
            console.error("Fehler beim Beanspruchen der Fl√ºge:", error);
          } else {
            console.log("Fl√ºge erfolgreich beansprucht!");
            localStorage.setItem("flights_claimed", "true");
          }
        }
      }

      async function getFlights() {
        const { data, error } = await supabaseClient
          .from("flights")
          .select("*");
        if (error) {
          console.error("Fehler beim Laden der Fl√ºge:", error);
          return [];
        }
        return data.map((flight) => ({ ...flight, id: flight.flight_id }));
      }

      // =================================================================
      // CORE APP & HELPER FUNCTIONS
      // =================================================================

      function toggleDarkMode() {
        document.documentElement.classList.toggle("dark");
        if (document.documentElement.classList.contains("dark")) {
          localStorage.setItem("theme", "dark");
        } else {
          localStorage.setItem("theme", "light");
        }
      }
	  
		/**
         * L√§dt die √úbersetzungsdatei und startet die √úbersetzung der Seite.
         * @param {string} lang - Der Sprachcode (z.B. "de" or "en").
         */
        async function setLanguage(lang) {
            try {
                const response = await fetch(`locales/${lang}.json`);
                
                if (!response.ok) {
                    throw new Error(`Netzwerk-Antwort war nicht OK: ${response.statusText}`);
                }

                translations = await response.json();
                currentLanguage = lang;
                localStorage.setItem('preferredLanguage', lang);
                
                // 1. Alle statischen Elemente (mit data-i18n) √ºbersetzen
                translatePage(); 

                // 2. Dynamische Inhalte des AKTIVEN Tabs neu laden,
                //    damit sie die neuen √úbersetzungen verwenden.
                
				// Pr√ºfen, ob der "Fl√ºge"-Tab aktiv ist
                if (!document.getElementById('tab-content-fluege').classList.contains('hidden')) {
                    // Ja -> Lade die Flugliste neu.
                    // renderFlights() beh√§lt die aktuelle Seite (currentPage) bei
                    // und baut die Liste mit getTranslation('flights.flightDetails') neu auf.
                    renderFlights(); 
                }
				
                // Pr√ºfen, ob der Errungenschaften-Tab aktiv ist
                if (!document.getElementById('tab-content-achievements').classList.contains('hidden')) {
                    // Ja -> Lade die Errungenschaften neu (diese rufen intern getTranslation auf)
                    updateAchievements();
                }
                
                // Pr√ºfen, ob der Logbuch-Tab aktiv ist
                if (!document.getElementById('tab-content-logbook').classList.contains('hidden')) {
                    // Ja -> Finde heraus, welche Ansicht aktiv ist und lade sie neu
                    const activeBtn = document.querySelector('.logbook-view-btn.active');
                    let view = 'aircraftType'; // Standard
                    if (activeBtn) {
                        if (activeBtn.id.includes('airline')) view = 'airline';
                        if (activeBtn.id.includes('airport')) view = 'airport';
                    }
                    renderLogbookView(view);
                }
                
                // Pr√ºfen, ob der Charts-Tab aktiv ist (f√ºr zuk√ºnftige √úbersetzungen der Chart-Titel)
                if (!document.getElementById('tab-content-charts').classList.contains('hidden')) {
                    const flights = await getFlights();
                    updateCharts(flights, currentChartTimeframe);
                }
                // --- ENDE NEUE LOGIK ---

            } catch (error) {
                console.error(`Sprachdatei ${lang}.json konnte nicht geladen werden:`, error);
            }
        }

        /**
         * Geht durch die Seite und ersetzt alle data-i18n-Schl√ºssel mit dem Text der geladenen Sprache.
         */
        function translatePage() {
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');

            // --- NEUE LOGIK F√úR DYNAMISCHE INHALTE ---
            if (key === 'mapVisualization') {
                const depName = element.getAttribute('data-dynamic-depName');

                // Pr√ºft, ob dynamische Daten vorhanden sind
                if (depName) {
                    // Ja: Baue den Text mit der NEUEN Sprache neu zusammen
                    const template = getTranslation('mapVisualization'); // Holt die NEUE Sprachvorlage
                    const translatedText = template
                        .replace('{depName}', depName)
                        .replace('{depCode}', element.getAttribute('data-dynamic-depCode'))
                        .replace('{arrName}', element.getAttribute('data-dynamic-arrName'))
                        .replace('{arrCode}', element.getAttribute('data-dynamic-arrCode'));
                    element.textContent = translatedText;
                } else {
                    // Nein: Nutze den statischen Fallback-Text (z.B. "Flugroute wird visualisiert.")
                    element.textContent = getTranslation('mapInfo'); 
                }
            // --- ENDE NEUE LOGIK ---

            } else {
                // Standard-Logik f√ºr alle anderen Elemente
                const translation = getTranslation(key);
                if (translation) {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        element.placeholder = translation;
                    } else {
                        element.textContent = translation;
                    }
                }
            }
        });
    }

        /**
         * Holt eine √úbersetzung anhand eines Schl√ºssels aus dem geladenen Sprachobjekt.
         * Unterst√ºtzt verschachtelte Schl√ºssel wie "tabs.newFlight".
         * @param {string} key - Der √úbersetzungsschl√ºssel.
         * @returns {string} Der √ºbersetzte Text oder der Schl√ºssel selbst, falls nicht gefunden.
         */
        function getTranslation(key) {
			// KORREKTUR: Pr√ºft auf 'undefined' als Typ, nicht als String
			return key.split('.').reduce((obj, k) => (obj && obj[k] !== undefined) ? obj[k] : key, translations);
		}
		
		/**
         * Findet den Kontinent f√ºr einen IATA-Code √ºber den lokalen Cache.
         * @param {string} iataCode - Der IATA-Code (z.B. "FRA").
         * @returns {string|null} Der Kontinent (z.B. "Europa") or null.
         */
        function getContinentForAirport(iataCode) {
            const airport = airportData[iataCode];
            if (airport && airport.country_code) {
                return countryToContinent[airport.country_code] || null;
            }
            return null;
        }
	  
		/**
         * Berechnet den gesch√§tzten CO2-Aussto√ü in kg.
         * Formel basiert auf g√§ngigen Emissionsmodellen (angepasste Faktoren).
         * @param {number} distance - Distanz in km.
         * @param {string} flightClass - "Economy", "Business", "First".
         * @returns {number} Gesch√§tzter CO2-Aussto√ü in kg.
         */
        function calculateCO2(distance, flightClass) {
            if (!distance || distance <= 0) return 0;

            let baseFactor; // kg CO2 pro Passagier-km
            
            // Emissionsfaktor variiert je nach Streckenl√§nge (Kurzstrecke ist ineffizienter pro km)
            if (distance < 1000) {
                baseFactor = 0.20; // Faktor f√ºr Kurzstrecke
            } else if (distance < 3500) {
                baseFactor = 0.15; // Faktor f√ºr Mittelstrecke
            } else {
                baseFactor = 0.12; // Faktor f√ºr Langstrecke
            }

            // Multiplikator f√ºr die Flugklasse
            let classMultiplier = 1.0; // Economy
            if (flightClass === 'Business') classMultiplier = 2.5;
            if (flightClass === 'First') classMultiplier = 4.0;
            
            // Radiativer Forcing Index (RFI) - ein Multiplikator, der die verst√§rkte
            // Klimawirkung von Emissionen in gro√üer H√∂he ber√ºcksichtigt.
            const RFI_MULTIPLIER = 1.9;

            const co2_kg = distance * baseFactor * classMultiplier * RFI_MULTIPLIER;
            return Math.round(co2_kg);
        }

      function showTab(tabName) {
            // Alle Inhalte verstecken
            document.getElementById('tab-content-stats').classList.add('hidden');
            document.getElementById('tab-content-charts').classList.add('hidden');
            document.getElementById('tab-content-logbook').classList.add('hidden');
            document.getElementById('tab-content-fluege').classList.add('hidden');
            document.getElementById('tab-content-neue-fluege').classList.add('hidden');
            document.getElementById('tab-content-achievements').classList.add('hidden');

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-indigo-500', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });

            const activeBtn = document.getElementById(`tab-btn-${tabName}`);
            const activeContent = document.getElementById(`tab-content-${tabName}`);
            if (activeBtn && activeContent) {
                activeContent.classList.remove('hidden');
                activeBtn.classList.add('border-indigo-500', 'text-indigo-600');
                activeBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            }
            
            if (tabName === 'logbook') {
                renderLogbookView('aircraftType');
            }
            if (tabName === 'achievements') {
                updateAchievements();
            }
        }

      var findAirport = function(input) {
    const normalizedInput = input.trim().toUpperCase();

    // KORREKTUR: Akzeptiere 3- (IATA) oder 4-stellige (ICAO) Codes
    if ((normalizedInput.length === 3 || normalizedInput.length === 4) && airportData[normalizedInput]) {
        return { code: normalizedInput, ...airportData[normalizedInput] };
    }

    // Fallback: Suche nach Namen (bleibt unver√§ndert)
    for (const code in airportData) {
        if (airportData[code].name.toUpperCase().includes(normalizedInput)) {
            return { code: code, ...airportData[code] };
        }
    }
    return null;
};

      var calculateDistance = function (lat1, lon1, lat2, lon2) {
        var R = 6371;
        var toRad = (d) => d * (Math.PI / 180);
        var dLat = toRad(lat2 - lat1);
        var dLon = toRad(lon2 - lon1);
        var a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(toRad(lat1)) *
            Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      };

      var estimateFlightTime = function (distanceKm) {
        var hours = Math.floor(distanceKm / 850 + 0.5);
        var minutes = Math.round((distanceKm / 850 + 0.5 - hours) * 60);
        return `${hours} Std. ${minutes} Min.`;
      };

      async function uploadFlightPhotos(files) {
        if (!files || files.length === 0) {
          return [];
        }
        const photoUrls = [];
        for (const file of files) {
          const filePath = `public/${Date.now()}-${file.name}`;
          const { error: uploadError } = await supabaseClient.storage
            .from("flight-photos")
            .upload(filePath, file);
          if (uploadError) {
            console.error("Fehler beim Hochladen der Datei:", uploadError);
            showMessage(
              "Upload-Fehler",
              `Foto ${file.name} konnte nicht hochgeladen werden.`,
              "error"
            );
            continue;
          }
          const { data } = supabaseClient.storage
            .from("flight-photos")
            .getPublicUrl(filePath);
          if (data.publicUrl) {
            photoUrls.push(data.publicUrl);
          }
        }
        return photoUrls;
      }

      const cacheAndSaveAirport = async (airport) => {
    // Pr√ºft, ob der Eintrag fehlt ODER ob die country_code-Info fehlt
    if (airport && (!airportData[airport.code] || !airportData[airport.code].country_code)) {
        airportData[airport.code] = {
            name: airport.name,
            lat: airport.lat,
            lon: airport.lon,
            city: airport.city,
            country_code: airport.country_code // NEU
        };

        const { error } = await supabaseClient.from("airports").upsert({
            iata: airport.code,
            name: airport.name,
            lat: airport.lat,
            lon: airport.lon,
            city: airport.city,
            country_code: airport.country_code // NEU
        });

        if (error) {
            console.error("Fehler beim Speichern des Flughafens:", error);
        }
    }
};

      var showMessage = function (title, message, type = "info") {
        const container = document.getElementById("toast-container");
        if (!container) return;
        const toast = document.createElement("div");
        let typeClass = "toast-info";
        if (type === "success") typeClass = "toast-success";
        if (type === "error") typeClass = "toast-error";
        toast.className = `toast ${typeClass}`;
        toast.innerHTML = `<strong class="block">${title}</strong> ${message}`;
        container.appendChild(toast);
        setTimeout(() => {
          toast.remove();
        }, 5000);
      };

      /**
       * Formatiert Wetterdaten f√ºr die Anzeige in einem Leaflet-Popup.
       * @param {object} weather - Das Wetter-Objekt von der API.
       * @returns {string} Ein formatierter HTML-String oder ein leerer String.
       */
	   /**
      function formatWeatherForPopup(weather) {
        if (weather && typeof weather.temp !== "undefined") {
          return `<br><hr class="my-1">üå°Ô∏è ${weather.temp}¬∞C | üí® ${weather.wind_speed} km/h`;
        }
        return ""; // Gibt nichts zur√ºck, wenn keine Wetterdaten vorhanden sind
      }
	  */

		/**
         * Extrahiert einen IATA-Code aus einem String wie "Dresden (DRS)".
         * @param {string} text - Der Text, der den Code enth√§lt.
         * @returns {string|null} Der extrahierte IATA-Code (z.B. "DRS") or null.
         */
        function extractIata(text) {
            const match = text.match(/\(([^)]+)\)/);
            return match ? match[1] : null;
        }


      // =================================================================
      // Hier sind alle weiteren, vollst√§ndigen Funktionen
      // =================================================================

      /**
       * L√§dt die Version aus der package.json und zeigt sie in der App an.
       */
      async function displayAppVersion() {
        try {
          const response = await fetch("package.json");
          const data = await response.json();
          const versionElement = document.getElementById("app-version");
          if (versionElement && data.version) {
            versionElement.textContent = `v${data.version}`;
          }
        } catch (error) {
          console.error("Fehler beim Laden der Versionsnummer:", error);
        }
      }

      /**
       * Schaltet die Sichtbarkeit des Burger-Men√ºs um.
       */
      function toggleBurgerMenu() {
        const menu = document.getElementById("burger-menu");
        menu.classList.toggle("hidden");
      }

      /**
       * Berechnet und zeigt die Errungenschaften des Nutzers an.
       */
      async function updateAchievements() {
            const container = document.getElementById('achievements-container');
            container.innerHTML = `<p class="text-gray-500">${getTranslation('achievements.loading')}</p>`;

            const allFlights = await getFlights();
            if (allFlights.length === 0) {
                container.innerHTML = `<p class="text-gray-500">${getTranslation('achievements.noFlights')}</p>`;
                document.getElementById('records-container').innerHTML = `<p class="text-gray-500 md:col-span-2">${getTranslation('stats.noData')}</p>`;
                return;
            }

            // 1. Aktuelle Statistiken berechnen
            const totalFlights = allFlights.length;
            const totalDistance = allFlights.reduce((sum, flight) => sum + flight.distance, 0);
            const totalMinutes = allFlights.reduce((sum, flight) => sum + parseFlightTimeToMinutes(flight.time), 0);
            const totalHours = totalMinutes / 60;
            const uniqueAirports = new Set(allFlights.flatMap(f => [f.departure, f.arrival]));
            const longestFlightDistance = Math.max(...allFlights.map(f => f.distance));
            const totalCO2 = allFlights.reduce((sum, flight) => sum + (flight.co2_kg || 0), 0);

            let html = '';

            // 2. Alle definierten Errungenschaften durchgehen
            const allAchievementTypes = [
                { category: 'flights', value: totalFlights, unit: getTranslation('achievements.unitFlights') },
                { category: 'distance', value: totalDistance, unit: getTranslation('achievements.unitKm') },
                { category: 'time', value: totalHours, unit: getTranslation('achievements.unitHours') },
                { category: 'uniqueAirports', value: uniqueAirports.size, unit: getTranslation('achievements.unitAirports') },
                { category: 'longestFlight', value: longestFlightDistance, unit: getTranslation('achievements.unitKm') },
                { category: 'co2_total', value: totalCO2, unit: getTranslation('achievements.unitCo2') }
            ];

            allAchievementTypes.forEach(type => {
                achievements[type.category].forEach(achievement => {
                    const isUnlocked = type.value >= achievement.milestone;
                    const progressPercent = Math.min((type.value / achievement.milestone) * 100, 100);
                    const progressBarColor = (type.category === 'co2_total') ? 'bg-red-500' : 'bg-indigo-500';

                    // KORREKTUR: Verwende getTranslation mit den Schl√ºsseln aus dem Objekt
                    const title = getTranslation(`achievements.${type.category}.${achievement.key}.title`);
                    const description = getTranslation(`achievements.${type.category}.${achievement.key}.description`);

                    html += `
                        <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg flex items-center gap-4 ${isUnlocked ? '' : 'opacity-40'}">
                            <span class="text-3xl">${achievement.emoji}</span>
                            <div>
                                <h3 class="font-bold text-gray-800 dark:text-white">${title}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400">${description}</p>
                                <div class="w-full bg-gray-300 dark:bg-gray-600 rounded-full h-2 mt-2">
                                    <div class="${progressBarColor} h-2 rounded-full" style="width: ${progressPercent}%"></div>
                                </div>
                                <p class="text-xs text-right text-gray-500 dark:text-gray-400 mt-1">${Math.round(type.value).toLocaleString('de-DE')} / ${achievement.milestone.toLocaleString('de-DE')} ${type.unit}</p>
                            </div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
            
            // Rekorde & Firsts berechnen und anzeigen
            const sortedFlights = resequenceAndAssignNumbers([...allFlights]);
            displayPersonalRecords(allFlights, sortedFlights);
        }
	  
		/**
         * Erstellt den HTML-Code f√ºr einen einzelnen Rekord-Eintrag.
         */
        function formatRecordEntry(title, value, description) {
            return `
                <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg">
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400">${title}</p>
                    <p class="text-lg font-bold text-indigo-700 dark:text-indigo-400">${value}</p>
                    <p class="text-sm text-gray-600 dark:text-gray-300">${description}</p>
                </div>
            `;
        }
		
		/**
         * Erstellt den HTML-Code f√ºr einen noch nicht erreichten ("gesperrten") Rekord.
         */
        function formatLockedEntry(title, description) {
            return `
                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg opacity-40">
                    <p class="text-xs font-medium text-gray-500 dark:text-gray-400">${title}</p>
                    <p class="text-lg font-bold text-gray-400 dark:text-gray-500">???</p>
                    <p class="text-sm text-gray-600 dark:text-gray-300">${description}</p>
                </div>
            `;
        }

        /**
         * Berechnet und zeigt die pers√∂nlichen Rekorde und "Firsts" an.
         */
        function displayPersonalRecords(allFlights, sortedFlights) {
            const container = document.getElementById('records-container');
            if (!container) return;

            // --- 1. REKORDE BERECHNEN ---
            const longestFlight = allFlights.reduce((max, f) => (f.distance > max.distance ? f : max), allFlights[0]);
            const shortestFlight = allFlights.reduce((min, f) => (f.distance < min.distance ? f : min), allFlights[0]);
            
            const paidFlights = allFlights.filter(f => typeof f.price === 'number');
            const mostExpensiveFlight = paidFlights.length > 0 ? paidFlights.reduce((max, f) => (f.price > max.price ? f : max), paidFlights[0]) : null;
            
            const co2Flights = allFlights.filter(f => typeof f.co2_kg === 'number');
            const highestCo2Flight = co2Flights.length > 0 ? co2Flights.reduce((max, f) => (f.co2_kg > max.co2_kg ? f : max), co2Flights[0]) : null;

            // --- 2. "FIRSTS" BERECHNEN ---
            const firstFlight = sortedFlights[0];
            const firstLongHaul = sortedFlights.find(f => f.distance > 5000);
            const firstBusinessOrFirst = sortedFlights.find(f => f.class === 'Business' || f.class === 'First');
            const firstA380 = sortedFlights.find(f => f.aircraftType && f.aircraftType.toUpperCase().includes('A380'));
            
            const firstEquator = sortedFlights.find(f => (f.depLat > 0 && f.arrLat < 0) || (f.depLat < 0 && f.arrLat > 0));
            const firstArctic = sortedFlights.find(f => f.depLat > 66.5 || f.arrLat > 66.5);
            const firstAntarctic = sortedFlights.find(f => f.depLat < -66.5 || f.arrLat < -66.5);
            const firstMeridian = sortedFlights.find(f => (f.depLon > 0 && f.arrLon < 0) || (f.depLon < 0 && f.arrLon > 0));
			
			// KONTINENT-LOGIK
            const firstContinents = {};
            const continents = ["Asien", "Europa", "Nordamerika", "S√ºdamerika", "Afrika", "Ozeanien", "Antarktis"];
            
            // Initialisiere alle Kontinente als "gesperrt" (null)
            continents.forEach(c => firstContinents[c] = null); 
            
            // Gehe durch alle Fl√ºge und finde den ERSTEN Besuch
            for (const flight of sortedFlights) {
                const continent = getContinentForAirport(flight.arrival);
                if (continent && !firstContinents[continent]) {
                    // Dies ist der erste Flug zu diesem Kontinent, den wir gefunden haben
                    firstContinents[continent] = flight;
                }
            }
            
            // --- 3. HTML ERSTELLEN ---
            let html = '';

            // Rekorde (immer sichtbar)
            html += formatRecordEntry(getTranslation('records.longestFlight'), `${longestFlight.distance.toLocaleString('de-DE')} km`, `${longestFlight.departure} ‚Üí ${longestFlight.arrival}`);
            html += formatRecordEntry(getTranslation('records.shortestFlight'), `${shortestFlight.distance.toLocaleString('de-DE')} km`, `${shortestFlight.departure} ‚Üí ${shortestFlight.arrival}`);
            
            if (mostExpensiveFlight) {
                html += formatRecordEntry(getTranslation('records.mostExpensive'), `${mostExpensiveFlight.price.toLocaleString('de-DE')} ${mostExpensiveFlight.currency}`, `${mostExpensiveFlight.departure} ‚Üí ${mostExpensiveFlight.arrival}`);
            }
            if (highestCo2Flight) {
                html += formatRecordEntry(getTranslation('records.highestCO2'), `${highestCo2Flight.co2_kg.toLocaleString('de-DE')} kg`, `${highestCo2Flight.departure} ‚Üí ${highestCo2Flight.arrival}`);
            }

            // "Firsts" (jetzt mit "Gesperrt"-Zustand)
            html += formatRecordEntry(getTranslation('records.firstFlight'), `${firstFlight.date}`, `${firstFlight.departure} ‚Üí ${firstFlight.arrival}`);
            
            if (firstLongHaul) {
                html += formatRecordEntry(getTranslation('records.firstLongHaul'), `${firstLongHaul.date}`, `${firstLongHaul.departure} ‚Üí ${firstLongHaul.arrival}`);
            } else {
                html += formatLockedEntry(getTranslation('records.firstLongHaul'), getTranslation('records.firstLongHaulDesc'));
            }

            if (firstBusinessOrFirst) {
                const title = getTranslation('records.firstPremiumFlight').replace('{class}', firstBusinessOrFirst.class);
                html += formatRecordEntry(title, `${firstBusinessOrFirst.date}`, `${firstBusinessOrFirst.departure} ‚Üí ${firstBusinessOrFirst.arrival}`);
            } else {
                const title = getTranslation('records.firstPremiumFlight').replace('{class}', 'Premium');
                html += formatLockedEntry(title, getTranslation('records.firstPremiumFlightDesc'));
            }

            if (firstA380) {
                html += formatRecordEntry(getTranslation('records.firstA380'), `${firstA380.date}`, `${firstA380.departure} ‚Üí ${firstA380.arrival}`);
            } else {
                html += formatLockedEntry(getTranslation('records.firstA380'), getTranslation('records.firstA380Desc'));
            }

            if (firstEquator) {
                html += formatRecordEntry(getTranslation('records.firstEquator'), `${firstEquator.date}`, `${firstEquator.departure} ‚Üí ${firstEquator.arrival}`);
            } else {
                html += formatLockedEntry(getTranslation('records.firstEquator'), getTranslation('records.firstEquatorDesc'));
            }
            
            if (firstArctic) {
                html += formatRecordEntry(getTranslation('records.firstArctic'), `${firstArctic.date}`, `${firstArctic.departure} ‚Üí ${firstArctic.arrival}`);
            } else {
                html += formatLockedEntry(getTranslation('records.firstArctic'), getTranslation('records.firstArcticDesc'));
            }

            if (firstAntarctic) {
                html += formatRecordEntry(getTranslation('records.firstAntarctic'), `${firstAntarctic.date}`, `${firstAntarctic.departure} ‚Üí ${firstAntarctic.arrival}`);
            } else {
                html += formatLockedEntry(getTranslation('records.firstAntarctic'), getTranslation('records.firstAntarcticDesc'));
            }

            if (firstMeridian) {
                html += formatRecordEntry(getTranslation('records.firstMeridian'), `${firstMeridian.date}`, `${firstMeridian.departure} ‚Üí ${firstMeridian.arrival}`);
            } else {
                html += formatLockedEntry(getTranslation('records.firstMeridian'), getTranslation('records.firstMeridianDesc'));
            }
			
			// Kontinent-Meilensteine anzeigen
            const continentToKeyMap = {
                "Asien": "Asia",
                "Europa": "Europe",
                "Nordamerika": "NorthAmerica",
                "S√ºdamerika": "SouthAmerica",
                "Afrika": "Africa",
                "Ozeanien": "Oceania",
                "Antarktis": "Antarctica"
            };

            // Iteriere √ºber die deutschen Kontinentnamen aus der Logik
            continents.forEach(continent => {
                const flight = firstContinents[continent];
                
                // KORREKTUR: Baue den Schl√ºssel √ºber das Mapping-Objekt
                const keySuffix = continentToKeyMap[continent]; 
                const titleKey = `records.firstVisit${keySuffix}`;
                const descKey = `records.firstVisit${keySuffix}Desc`;
                
                if (flight) {
                    html += formatRecordEntry(
                        getTranslation(titleKey), // <-- KORREKTER SCHL√úSSEL
                        `${flight.date}`, 
                        `${flight.departure} ‚Üí ${flight.arrival}`
                    );
                } else {
                    html += formatLockedEntry(
                        getTranslation(titleKey), // <-- KORREKTER SCHL√úSSEL
                        getTranslation(descKey)  // <-- KORREKTER SCHL√úSSEL
                    );
                }
            });

            container.innerHTML = html;
        }

      /**
       * Ermittelt eine CSS-Farbklasse basierend auf der Flugnummer und den Errungenschaften.
       * @param {number} flightNumber - Die sequenzielle Flugnummer.
       * @returns {string} Die Tailwind-CSS-Klasse f√ºr die Hintergrundfarbe.
       */
      function getMilestoneColor(flightNumber) {
        // Wir durchsuchen die Errungenschaften von der h√∂chsten zur niedrigsten Stufe.
        const flightAchievements = [...achievements.flights].reverse();

        for (const achievement of flightAchievements) {
          if (flightNumber >= achievement.milestone) {
            // Weise Farben basierend auf dem Titel oder der Stufe zu
            switch (achievement.milestone) {
              case 1000:
                return "bg-purple-600"; // Meister
              case 750:
                return "bg-cyan-500"; // Diamant
              case 500:
                return "bg-amber-500"; // Legende
              case 250:
                return "bg-yellow-400"; // Gold
              case 150:
                return "bg-slate-400"; // Silber
              case 100:
                return "bg-rose-600";
              case 50:
                return "bg-orange-400"; // Globetrotter
              case 25:
                return "bg-amber-600"; // Bronze
              case 10:
                return "bg-teal-500";
              default:
                continue; // Pr√ºfe die n√§chste Stufe
            }
          }
        }
        // Standardfarbe, wenn kein besonderer Meilenstein erreicht wurde
        return "bg-indigo-600";
      }

      var calculateStatistics = function (flights) {
        var stats = {
          totalCount: flights.length,
          totalDistance: 0,
		  totalCO2: 0,
          airportUsage: {},
          frequentAirport: getTranslation('stats.noData'),
          // Neue Statistik-Properties
          longestFlight: null,
          shortestFlight: null,
          averageDistance: 0,
		  averageCO2: 0,
          aircraftUsage: {},
          frequentAircraft: getTranslation('stats.noData'),
          yearlyData: {},
          totalSpending: {}, // Objekt, um mehrere W√§hrungen zu speichern
          mostExpensiveFlight: null,
          leastExpensiveFlight: null,
        };

        if (flights.length === 0) return stats;

        flights.forEach(function (flight) {
          stats.totalDistance += flight.distance;
		  
		  if (flight.co2_kg > 0) { // NEU
                    stats.totalCO2 += flight.co2_kg;
                }

          // 1. L√§ngsten/k√ºrzesten Flug finden
          if (
            !stats.longestFlight ||
            flight.distance > stats.longestFlight.distance
          ) {
            stats.longestFlight = flight;
          }
          if (
            !stats.shortestFlight ||
            flight.distance < stats.shortestFlight.distance
          ) {
            stats.shortestFlight = flight;
          }

          // 2. Flugzeugtyp-Nutzung z√§hlen
          if (flight.aircraftType && flight.aircraftType.trim() !== "") {
            const type = flight.aircraftType.trim().toUpperCase();
            stats.aircraftUsage[type] = (stats.aircraftUsage[type] || 0) + 1;
          }

          // 3. Jahresdaten sammeln
          const year = flight.date.substring(0, 4);
          if (!stats.yearlyData[year]) {
            stats.yearlyData[year] = { count: 0, distance: 0 };
          }
          stats.yearlyData[year].count++;
          stats.yearlyData[year].distance += flight.distance;

          // Bestehende Logik
          stats.airportUsage[flight.departure] =
            (stats.airportUsage[flight.departure] || 0) + 1;
          stats.airportUsage[flight.arrival] =
            (stats.airportUsage[flight.arrival] || 0) + 1;

          // NEU: Kosten berechnen
          // Pr√ºfe, ob der Preis eine Zahl ist (inklusive 0)
          if (typeof flight.price === "number" && flight.currency) {
            //          if (flight.price > 0 && flight.currency) {
            const currency = flight.currency;
            // Gesamtausgaben pro W√§hrung summieren
            stats.totalSpending[currency] =
              (stats.totalSpending[currency] || 0) + flight.price;

            // Teuersten/g√ºnstigsten Flug finden (vereinfacht, vergleicht nur Preise ohne W√§hrungsumrechnung)
            if (
              !stats.mostExpensiveFlight ||
              flight.price > stats.mostExpensiveFlight.price
            ) {
              stats.mostExpensiveFlight = flight;
            }
            if (
              !stats.leastExpensiveFlight ||
              flight.price < stats.leastExpensiveFlight.price
            ) {
              stats.leastExpensiveFlight = flight;
            }
          }
        });

        // Berechnungen nach der Schleife
        stats.averageDistance = Math.round(stats.totalDistance / stats.totalCount);
		stats.averageCO2 = Math.round(stats.totalCO2 / stats.totalCount);
        

        // H√§ufigsten Flughafen finden
        let maxCount = 0;
        for (var code in stats.airportUsage) {
          if (stats.airportUsage[code] > maxCount) {
            maxCount = stats.airportUsage[code];
            stats.frequentAirport = airportData[code]
              ? `${airportData[code].name} (${code})`
              : code;
          }
        }

        // H√§ufigsten Flugzeugtyp finden
        let maxAircraftCount = 0;
        for (var type in stats.aircraftUsage) {
          if (stats.aircraftUsage[type] > maxAircraftCount) {
            maxAircraftCount = stats.aircraftUsage[type];
            stats.frequentAircraft = `${type} (${maxAircraftCount}x)`;
          }
        }

        return stats;
      };

      var updateStatisticsDisplay = function (flights) {
            var stats = calculateStatistics(flights);

            // Standard-Werte
            document.getElementById("stat-count").textContent = stats.totalCount.toLocaleString("de-DE");
            document.getElementById("stat-distance").textContent = `${stats.totalDistance.toLocaleString("de-DE")} km`;
            document.getElementById("stat-frequent").textContent = stats.frequentAirport;
            document.getElementById("stat-avg-distance").textContent = `${stats.averageDistance.toLocaleString("de-DE")} km`;
            document.getElementById("stat-frequent-aircraft").textContent = stats.frequentAircraft;
            document.getElementById("stat-total-co2").textContent = `${stats.totalCO2.toLocaleString("de-DE")} kg`;
            document.getElementById("stat-avg-co2").textContent = `${stats.averageCO2.toLocaleString("de-DE")} kg`;

            // L√§ngster Flug
            if (stats.longestFlight) {
                document.getElementById("stat-longest-flight").textContent = getTranslation('stats.flightRouteKm')
                    .replace('{departure}', stats.longestFlight.departure)
                    .replace('{arrival}', stats.longestFlight.arrival)
                    .replace('{distance}', stats.longestFlight.distance.toLocaleString("de-DE"));
            } else {
                document.getElementById("stat-longest-flight").textContent = getTranslation('stats.noData');
            }

            // K√ºrzester Flug
            if (stats.shortestFlight) {
                document.getElementById("stat-shortest-flight").textContent = getTranslation('stats.flightRouteKm')
                    .replace('{departure}', stats.shortestFlight.departure)
                    .replace('{arrival}', stats.shortestFlight.arrival)
                    .replace('{distance}', stats.shortestFlight.distance.toLocaleString("de-DE"));
            } else {
                document.getElementById("stat-shortest-flight").textContent = getTranslation('stats.noData');
            }

            // Kosten-Statistiken
            const spendingText = Object.keys(stats.totalSpending)
                .map(currency => stats.totalSpending[currency].toLocaleString("de-DE", { style: "currency", currency: currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }))
                .join(' | ') || getTranslation('stats.noData');
            document.getElementById("stat-total-spending").textContent = spendingText;

            if (stats.mostExpensiveFlight) {
                document.getElementById("stat-most-expensive").textContent = getTranslation('stats.flightRoutePrice')
                    .replace('{departure}', stats.mostExpensiveFlight.departure)
                    .replace('{arrival}', stats.mostExpensiveFlight.arrival)
                    .replace('{price}', stats.mostExpensiveFlight.price.toLocaleString("de-DE"))
                    .replace('{currency}', stats.mostExpensiveFlight.currency);
            } else {
                document.getElementById("stat-most-expensive").textContent = getTranslation('stats.noData');
            }

            if (stats.leastExpensiveFlight) {
                document.getElementById("stat-least-expensive").textContent = getTranslation('stats.flightRoutePrice')
                    .replace('{departure}', stats.leastExpensiveFlight.departure)
                    .replace('{arrival}', stats.leastExpensiveFlight.arrival)
                    .replace('{price}', stats.leastExpensiveFlight.price.toLocaleString("de-DE"))
                    .replace('{currency}', stats.leastExpensiveFlight.currency);
            } else {
                document.getElementById("stat-least-expensive").textContent = getTranslation('stats.noData');
            }

            // Jahreszusammenfassung
            const yearSelect = document.getElementById("stat-year-select");
            const yearlySummary = document.getElementById("stat-yearly-summary");
            yearSelect.innerHTML = ""; 

            const years = Object.keys(stats.yearlyData).sort((a, b) => b - a);

            if (years.length > 0) {
                years.forEach((year) => {
                    const option = document.createElement("option");
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });

                const updateYearlyDisplay = (year) => {
                    const data = stats.yearlyData[year];
                    yearlySummary.textContent = getTranslation('stats.yearlySummaryContent')
                        .replace('{count}', data.count)
                        .replace('{distance}', data.distance.toLocaleString("de-DE"));
                };

                yearSelect.onchange = (event) => {
                    updateYearlyDisplay(event.target.value);
                };
                
                updateYearlyDisplay(years[0]);
                yearSelect.style.display = "inline-block";
            } else {
                yearlySummary.textContent = getTranslation('stats.noYearlyData');
                yearSelect.style.display = "none";
            }
        };

		/**
         * Ruft Flugdaten per Flugnummer und Datum ab und f√ºllt das Formular aus.
		 * OLD
         */
	/**	 
	async function autofillFlightData() {
            const flightNumber = document.getElementById('auto-flight-number').value.replace(/\s/g, '').trim().toUpperCase();
            const flightDate = document.getElementById('auto-flight-date').value;

            if (!flightNumber || !flightDate) {
                showMessage('Fehler', 'Bitte Flugnummer UND Datum eingeben.', 'error');
                return;
            }

            const btn = document.getElementById('autofill-btn');
            btn.textContent = 'Suche...';
            btn.disabled = true;

            try {
                // Wir verwenden 'flight_number', wie von dir im Browser getestet
                const response = await fetch(`https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-flight-by-number?flight_number=${flightNumber}&date=${flightDate}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText); 
                }

                const result = await response.json();
                console.log("Antwort von GoFlightLabs API:", JSON.stringify(result, null, 2));

                // KORRIGIERTE ANTWORT-VERARBEITUNG
                // 1. Pr√ºfen, ob 'result.data' existiert und ein Objekt ist
                // 2. Pr√ºfen, ob dieses Objekt Eintr√§ge hat (z.B. "1", "2")
                if (result.data && typeof result.data === 'object' && Object.keys(result.data).length > 0) {
                    
                    // Nimm den ersten Flug aus dem Objekt (den Schl√ºssel "1")
                    const flightKey = Object.keys(result.data)[0];
                    const flight = result.data[flightKey]; 
                    
                    // Verwende die neue Hilfsfunktion, um die IATA-Codes zu extrahieren
                    const depIata = extractIata(flight.FROM);
                    const arrIata = extractIata(flight.TO);

                    if (!depIata || !arrIata) {
                        throw new Error("Konnte IATA-Codes nicht aus der API-Antwort extrahieren.");
                    }

					// 1. Extrahiere den Airline-Code aus der Flugnummer (z.B. "EW" aus "EW9029")
                    const airlineIataMatch = flightNumber.match(/^[A-Z0-9]{2}/);
                    let airlineName = '';
                    
                    if (airlineIataMatch) {
                        // 2. Rufe parallel den Airline-Namen ab
                        airlineName = await fetchAirlineName(airlineIataMatch[0]);
                    }

                    document.getElementById('departure').value = depIata;
                    document.getElementById('arrival').value = arrIata;
                    document.getElementById('aircraftType').value = flight.AIRCRAFT.split(' ')[0] || ''; // Nimm nur den Typ, z.B. "A320"
                    document.getElementById('flightNumber').value = flightNumber;
					document.getElementById('airline').value = airlineName || '';
                    document.getElementById('flightDate').value = flightDate; 

                    updateFlightDetails();
                    showMessage('Erfolg!', 'Flugdaten wurden erfolgreich geladen.', 'success');
                } else {
                    showMessage('Fehler', 'Keine Flugdaten f√ºr diese Kombination gefunden.', 'error');
                }
            } catch (error) {
                console.error("Fehler beim Abrufen der Flugdaten:", error);
                showMessage('Fehler', `Suche fehlgeschlagen: ${error.message}`, 'error');
            } finally {
                btn.textContent = 'Daten abrufen';
                btn.disabled = false;
            }
        }
		*/
		
		/**
         * Ruft Flugdaten per Flugnummer und Datum ab und f√ºllt das Formular aus.
		 * FR24
         */
		async function autofillFlightData() {
    const flightNumber = document.getElementById('auto-flight-number').value.replace(/\s/g, '').trim().toUpperCase();
    const flightDate = document.getElementById('auto-flight-date').value;

    if (!flightNumber || !flightDate) {
        showMessage(getTranslation('form.autopilotError'), 'error');
        return;
    }

    const btn = document.getElementById('autofill-btn');
    btn.textContent = getTranslation('form.buttonFetching');
    btn.disabled = true;

    try {
        // Wir √ºbergeben 'flight_number' (wird von der Netlify-Funktion als 'flights' interpretiert)
        const response = await fetch(`https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-flight-by-number?flight_number=${flightNumber}&date=${flightDate}`);

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText); 
        }

        const result = await response.json();

        // KORRIGIERTE ANTWORT-STRUKTUR: 'result.data'
        if (result.data && result.data.length > 0) {
            // Finde den Flug, der am n√§chsten am Zieldatum liegt
            const targetTimestamp = new Date(flightDate).getTime();
            const flight = result.data.reduce((prev, curr) => {
                const prevDiff = Math.abs(new Date(prev.first_seen).getTime() - targetTimestamp);
                const currDiff = Math.abs(new Date(curr.first_seen).getTime() - targetTimestamp);
                return (currDiff < prevDiff ? curr : prev);
            });

            // --- DATEN EXTRAHIEREN ---
            const depIata = flight.orig_iata;
            const arrIata = flight.dest_iata;
            const airlineIata = flight.operating_as || flight.painted_as; // z.B. "LH" oder "DLH"
            const aircraftModel = flight.type; // z.B. "B738"
            const registration = flight.reg; // z.B. "D-AINY"

            // Airline-Namen parallel abrufen (wir nutzen daf√ºr unsere GFL-Funktion)
            let airlineName = '';
            if (airlineIata) {
                airlineName = await fetchAirlineName(airlineIata);
            }

            // --- FORMULAR F√úLLEN ---
            document.getElementById('departure').value = depIata;
            document.getElementById('arrival').value = arrIata;
            document.getElementById('aircraftType').value = aircraftModel || '';
            document.getElementById('flightNumber').value = flight.flight;
            document.getElementById('airline').value = airlineName || '';
            document.getElementById('registration').value = registration || '';
            document.getElementById('flightDate').value = flightDate; 

            // Wir m√ºssen die Flughafendaten noch schnell cachen, falls sie neu sind
            // (Wir rufen die Detail-API auf, um alle Infos zu haben)
            await showAirportDetails(depIata, true); // true = "nur cachen, nicht anzeigen"
            await showAirportDetails(arrIata, true);

            updateFlightDetails(); // Distanz, Zeit & CO2 berechnen
            showMessage(getTranslation('form.autopilotSuccess'), 'success');
        } else {
            showMessage(getTranslation('messages.noDataFound'), 'error');
        }
    } catch (error) {
        console.error("Fehler beim Abrufen der Flugdaten:", error);
        showMessage(getTranslation('messages.fetchError') + `: ${error.message}`, 'error');
    } finally {
        btn.textContent = getTranslation('form.buttonFetch');
        btn.disabled = false;
    }
}
		
		
	  
	  /**
       * Eine Hilfsfunktion, die einen Flugzeit-String (z.B. "3 Std. 45 Min.") in Minuten umwandelt.
       * @param {string} timeString - Der Flugzeit-String.
       * @returns {number} Die Gesamtflugzeit in Minuten.
       */
      function parseFlightTimeToMinutes(timeString) {
        if (!timeString || !timeString.includes("Std.")) return 0;
        const parts = timeString.match(/(\d+)\s*Std\.\s*(\d+)\s*Min\./);
        if (parts && parts.length === 3) {
          return parseInt(parts[1]) * 60 + parseInt(parts[2]);
        }
        return 0;
      }

      /**
       * Gruppiert Fl√ºge nach einem bestimmten Kriterium und zeigt sie im Logbuch-Tab an.
       * @param {'aircraftType' | 'airline' | 'airport'} groupBy - Das Kriterium f√ºr die Gruppierung.
       */
      async function renderLogbookView(groupBy) {
            const contentContainer = document.getElementById('logbook-content');
            contentContainer.innerHTML = `<p class="text-gray-500">${getTranslation('logbook.loading')}</p>`;
            
            const allFlights = await getFlights();
            const grouped = {};
            
            const unknownKey = getTranslation('logbook.unknown'); // Hole "Unbekannt" einmal

            let isAirportView = (groupBy === 'airport');
            let isAircraftTypeView = (groupBy === 'aircraftType');
            let isAirlineView = (groupBy === 'airline'); 
			let isRegistrationView = (groupBy === 'registration');

            allFlights.forEach(flight => {
                let keys = [];
                if (isAircraftTypeView) {
                    let type = (flight.aircraftType || unknownKey).trim().toUpperCase();
                    if (type === '') type = unknownKey;
                    keys.push(type);
                } else if (isAirlineView) { 
                    const match = flight.flightNumber ? flight.flightNumber.match(/^[A-Z0-9]{2}/) : null;
                    const airline = match ? match[0].toUpperCase() : unknownKey;
                    keys.push(airline);
                } else if (isAirportView) { 
                    if (flight.departure) keys.push(flight.departure.toUpperCase());
                    if (flight.arrival) keys.push(flight.arrival.toUpperCase());
                } else if (isRegistrationView) { // NEU
					let reg = (flight.registration || unknownKey).trim().toUpperCase();
					if (reg === '') reg = unknownKey;
					keys.push(reg);
				}
                
                keys.forEach(key => {
                    if(key === '') key = unknownKey; 
                    if (!grouped[key]) { grouped[key] = { flights: [], totalDistance: 0, count: 0 }; }
                    grouped[key].flights.push(flight);
                    grouped[key].totalDistance += flight.distance;
                    grouped[key].count++;
                });
            });

            contentContainer.innerHTML = '';
            const sortedKeys = Object.keys(grouped).sort();

            if (sortedKeys.length === 0) {
                contentContainer.innerHTML = `<p class="text-gray-500">${getTranslation('logbook.noData')}</p>`;
                return;
            }

            sortedKeys.forEach(key => {
                const group = grouped[key];
                const detailsElement = document.createElement('details');
                detailsElement.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg';
                
                const summaryElement = document.createElement('summary');
                summaryElement.className = 'font-semibold text-lg cursor-pointer text-indigo-700 dark:text-indigo-400 flex items-center'; 
                
                let titleHtml = key;
                let titleKey = '';
                
                if (isAirportView && key !== unknownKey) { 
					titleKey = getTranslation('logbook.detailsTitleAirport').replace('{key}', key);
					// KORREKTUR: Der 'key' (Flughafen-Code) ist jetzt nur noch reiner Text.
					// Nur der Button l√∂st die showAirportDetails-Funktion aus.
					titleHtml = `
						${key}
						<button onclick="event.stopPropagation(); showAirportDetails('${key}')" class="ml-2 p-1 rounded-full text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900 transition-colors duration-150" title="${titleKey}">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
						</button>
					`;
				} 
              /**  
				else if (isAircraftTypeView && key !== unknownKey) {
                    titleKey = getTranslation('logbook.detailsTitleAircraft').replace('{key}', key);
                    titleHtml = `
                        ${key}
                        <button onclick="event.stopPropagation(); showAircraftDetails('${key}')" class="ml-2 p-1 rounded-full text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900 transition-colors duration-150" title="${titleKey}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
                        </button>
                    `;
                }
			   */	
				
                else if (isAirlineView && key !== unknownKey) {
                    const firstFlightWithName = group.flights.find(f => f.airline && f.airline.trim() !== '');
                    const displayLabel = firstFlightWithName ? `${firstFlightWithName.airline} (${key})` : key;
                    titleKey = getTranslation('logbook.detailsTitleAirline').replace('{key}', key);

                    titleHtml = `
                        ${displayLabel}
                        <button onclick="event.stopPropagation(); showAirlineDetails('${key}')" class="ml-2 p-1 rounded-full text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-900 transition-colors duration-150" title="${titleKey}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" /></svg>
                        </button>
                    `;
                }
				// KEIN Info-Button f√ºr Registrierung, da es keine API daf√ºr gibt

                summaryElement.innerHTML = `
                    ${titleHtml} 
                    <span class="text-sm font-normal text-gray-500 dark:text-gray-400 ml-2">
                        ${getTranslation('logbook.summary')
                            .replace('{count}', group.count)
                            .replace('{distance}', group.totalDistance.toLocaleString('de-DE'))}
                    </span>
                `;
                
                const flightListDiv = document.createElement('div');
                flightListDiv.className = 'mt-4 space-y-2 border-t border-gray-200 dark:border-gray-600 pt-4';
                
                group.flights.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(flight => {
                    const flightText = getTranslation('logbook.flightEntry')
                        .replace('{date}', flight.date)
                        .replace('{departure}', flight.departure)
                        .replace('{arrival}', flight.arrival)
                        .replace('{distance}', flight.distance.toLocaleString('de-DE'));

                    flightListDiv.innerHTML += `<div class="text-sm text-gray-700 dark:text-gray-300">${flightText}</div>`;
                });
                
                detailsElement.appendChild(summaryElement);
                detailsElement.appendChild(flightListDiv);
                contentContainer.appendChild(detailsElement);
            });

            // UI f√ºr die Buttons aktualisieren
            document.querySelectorAll('.logbook-view-btn').forEach(btn => btn.classList.remove('active'));
            let buttonIdFragment = groupBy;
            if (groupBy === 'aircraftType') { buttonIdFragment = 'aircraft'; }
            if (groupBy === 'airline') { buttonIdFragment = 'airline'; } 
			if (groupBy === 'registration') { buttonIdFragment = 'registration'; }
            const activeButton = document.getElementById(`logbook-view-${buttonIdFragment}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }

      /**
       * Setzt den Zeitraum f√ºr die Charts und l√∂st eine Aktualisierung aus.
       * @param {'year' | 'month'} timeframe
       */
      async function setChartTimeframe(timeframe) {
        currentChartTimeframe = timeframe; // Neuen Zeitraum speichern
        const flights = await getFlights(); // Immer die kompletten, aktuellen Daten laden
        updateCharts(flights, currentChartTimeframe); // Charts mit den neuen Daten und dem neuen Zeitraum aktualisieren
      }

      /**
       * Zeichnet alle Diagramme basierend auf den aufbereiteten Daten.
       * Zerst√∂rt alte Diagramme, bevor neue gezeichnet werden.
       * @param {Array<string>} labels - Die Labels f√ºr die X-Achse (z.B. ['2024', '2025']).
       * @param {Array<number>} flightsData - Die Daten f√ºr die Anzahl der Fl√ºge.
       * @param {Array<number>} distanceData - Die Daten f√ºr die Distanz.
       * @param {Array<number>} timeData - Die Daten f√ºr die Flugzeit in Minuten.
       */
      function renderAllCharts(labels, flightsData, distanceData, timeData) {
            if (flightsChartInstance) flightsChartInstance.destroy();
            if (distanceChartInstance) distanceChartInstance.destroy();
            if (timeChartInstance) timeChartInstance.destroy();

            const isDarkMode = document.documentElement.classList.contains("dark");
            const gridColor = isDarkMode ? "rgba(255, 255, 255, 0.1)" : "rgba(0, 0, 0, 0.1)";
            const labelColor = isDarkMode ? "#d1d5db" : "#374151";

            // 1. Fl√ºge pro Zeitraum (Balkendiagramm)
            flightsChartInstance = new Chart(
                document.getElementById("flightsChart"),
                {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: getTranslation('charts.labelFlights'), // KORRIGIERT
                                data: flightsData,
                                backgroundColor: "rgba(79, 70, 229, 0.8)",
                                borderColor: "rgba(79, 70, 229, 1)",
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, ticks: { color: labelColor }, grid: { color: gridColor } },
                            x: { ticks: { color: labelColor }, grid: { color: gridColor } },
                        },
                    },
                }
            );

            // 2. Distanz pro Zeitraum (Liniendiagramm)
            distanceChartInstance = new Chart(
                document.getElementById("distanceChart"),
                {
                    type: "line",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: getTranslation('charts.labelDistance'), // KORRIGIERT
                                data: distanceData,
                                fill: false,
                                borderColor: "rgba(22, 163, 74, 1)",
                                tension: 0.1,
                            },
                        ],
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, ticks: { color: labelColor }, grid: { color: gridColor } },
                            x: { ticks: { color: labelColor }, grid: { color: gridColor } },
                        },
                    },
                }
            );

            // 3. Flugzeit pro Zeitraum (Liniendiagramm)
            timeChartInstance = new Chart(document.getElementById("timeChart"), {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: getTranslation('charts.labelDuration'), // KORRIGIERT
                            data: timeData,
                            fill: false,
                            borderColor: "rgba(219, 39, 119, 1)",
                            tension: 0.1,
                        },
                    ],
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { color: labelColor }, grid: { color: gridColor } },
                        x: { ticks: { color: labelColor }, grid: { color: gridColor } },
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || "";
                                    if (label) label += ": ";
                                    const totalMinutes = context.parsed.y;
                                    const hours = Math.floor(totalMinutes / 60);
                                    const minutes = totalMinutes % 60;
                                    
                                    // KORRIGIERT: Verwendet die √úbersetzungsvorlage
                                    return getTranslation('charts.tooltipLabel')
                                        .replace('{label}', label)
                                        .replace('{hours}', hours)
                                        .replace('{minutes}', minutes);
                                },
                            },
                        },
                    },
                },
            });
        }

      /**
       * Hauptfunktion zum Aufbereiten der Flugdaten und Aktualisieren der Charts.
       * @param {Array<Object>} allFlights - Das Array mit allen Flug-Objekten.
       * @param {string} timeframe - Entweder 'year' oder 'month'.
       */
      function updateCharts(allFlights, timeframe = "year") {
        // Zeile entfernt: const allFlights = getFlights();

        if (!allFlights || allFlights.length === 0) {
          // Optional: Verstecke oder leere die Charts, wenn keine Daten da sind
          if (flightsChartInstance) flightsChartInstance.destroy();
          if (distanceChartInstance) distanceChartInstance.destroy();
          if (timeChartInstance) timeChartInstance.destroy();
          return;
        }

        const aggregatedData = {};

        allFlights.forEach((flight) => {
          const key =
            timeframe === "year"
              ? flight.date.substring(0, 4)
              : flight.date.substring(0, 7);
          if (!aggregatedData[key]) {
            aggregatedData[key] = { count: 0, distance: 0, time: 0 };
          }
          aggregatedData[key].count++;
          aggregatedData[key].distance += flight.distance;
          aggregatedData[key].time += parseFlightTimeToMinutes(flight.time);
        });

        const sortedLabels = Object.keys(aggregatedData).sort();

        const flightsData = sortedLabels.map(
          (label) => aggregatedData[label].count
        );
        const distanceData = sortedLabels.map(
          (label) => aggregatedData[label].distance
        );
        const timeData = sortedLabels.map(
          (label) => aggregatedData[label].time
        );

        renderAllCharts(sortedLabels, flightsData, distanceData, timeData);

        document
          .getElementById("chart-view-year")
          .classList.toggle("active", timeframe === "year");
        document
          .getElementById("chart-view-month")
          .classList.toggle("active", timeframe === "month");
      }

      window.exportData = async function (format) {
            const allFlights = await getFlights(); // Lade alle Fl√ºge asynchron
            const stats = calculateStatistics(allFlights);
            let filename = `flugbuch_export_${new Date().toISOString().slice(0, 10)}`;
            let data, mimeType;

            if (allFlights.length === 0) {
                showMessage("Export Fehler", "Keine Daten zum Exportieren vorhanden.", "error");
                return;
            }

            if (format === "json") {
                // JSON-Export: Wir exportieren die Rohdaten der Fl√ºge
                const exportObj = {
                    metadata: {
                        export_date: new Date().toISOString(),
                        totalFlights: stats.totalCount,
                        totalDistanceKm: stats.totalDistance,
                    },
                    flights: allFlights, // Das Array mit allen Flugobjekten
                };
                data = JSON.stringify(exportObj, null, 2);
                mimeType = "application/json";
                filename += ".json";

            } else if (format === "csv") {
                const separator = ";";
                // Definiere ALLE Spalten, die wir exportieren wollen
                const flightKeys = [
                    'flightLogNumber', 'date', 'departure', 'arrival', 'distance', 'time',
                    'class', 'flightNumber', 'airline', 'aircraftType', 'price', 'currency', 'notes'
                ];
                const headers = flightKeys.join(separator);

                const csvRows = allFlights.map(flight => {
                    return flightKeys.map(key => {
                        let value = (flight[key] !== undefined && flight[key] !== null) ? String(flight[key]) : "";
                        // Werte mit Anf√ºhrungszeichen umschlie√üen, um Kommas/Semikolons im "notes"-Feld abzufangen
                        return `"${value.replace(/"/g, '""')}"`;
                    }).join(separator);
                }).join("\n");

                data = "\uFEFF" + headers + "\n" + csvRows; // BOM f√ºr Excel-Kompatibilit√§t
                mimeType = "text/csv;charset=utf-8;";
                filename += ".csv";

            } else {
                return;
            }

            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("Export erfolgreich", `Daten wurden als "${filename}" exportiert.`, "success");
        };

		/**
         * Verarbeitet die hochgeladene JSON-Importdatei.
         */
        async function handleImport(event) {
            toggleBurgerMenu();
			const file = event.target.files[0];
            if (!file) {
                return; // Abbruch, wenn keine Datei gew√§hlt wurde
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                let importData;
                try {
                    importData = JSON.parse(e.target.result);
                    if (!importData.flights || !Array.isArray(importData.flights)) {
                        throw new Error("JSON-Datei hat nicht das erwartete Format (fehlendes 'flights'-Array).");
                    }
                } catch (error) {
                    showMessage("Import-Fehler", `Die Datei konnte nicht gelesen werden: ${error.message}`, "error");
                    return;
                }

                const flightCount = importData.flights.length;
                if (flightCount === 0) {
                    showMessage("Import-Info", "Die JSON-Datei enth√§lt keine Fl√ºge.", "info");
                    return;
                }

                // WICHTIGE SICHERHEITSABFRAGE
                const confirmed = confirm(
                    `ACHTUNG!\n\nDu bist dabei, ${flightCount} Fl√ºge zu importieren. \n\n'OK' klicken: ALLE deine aktuell in der Cloud gespeicherten Fl√ºge werden gel√∂scht und durch die Fl√ºge aus der Datei ersetzt.\n'Abbrechen' klicken: Der Vorgang wird abgebrochen.`
                );

                if (!confirmed) {
                    showMessage("Import abgebrochen", "Es wurden keine Daten ge√§ndert.", "info");
                    event.target.value = null; // Setzt den Datei-Input zur√ºck
                    return;
                }

                try {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (!user) {
                        throw new Error("Nutzer nicht authentifiziert.");
                    }

                    // 1. Alle alten Fl√ºge f√ºr diesen Nutzer l√∂schen
                    const { error: deleteError } = await supabaseClient
                        .from('flights')
                        .delete()
                        .eq('user_id', user.id);
                    
                    if (deleteError) throw deleteError;

                    // 2. Die neuen Fl√ºge vorbereiten (alle 'id'-Felder entfernen und 'user_id' setzen)
                    const flightsToInsert = importData.flights.map(flight => {
                        delete flight.id; // Entfernt die alte Supabase-ID
                        return { ...flight, user_id: user.id };
                    });

                    // 3. Neue Fl√ºge einf√ºgen
                    const { error: insertError } = await supabaseClient
                        .from('flights')
                        .insert(flightsToInsert);
                    
                    if (insertError) throw insertError;

                    showMessage("Import erfolgreich!", `${flightCount} Fl√ºge wurden importiert. Die Ansicht wird aktualisiert.`, "success");
                    renderFlights(); // Lade die App neu

                } catch (error) {
                    showMessage("Import-Fehler", `Ein Datenbankfehler ist aufgetreten: ${error.message}`, "error");
                } finally {
                    event.target.value = null; // Setzt den Datei-Input zur√ºck
                }
            };
            
            reader.readAsText(file);
        }

      // *** Autocomplete-Logik ***
      async function updateAutocompleteList(inputId, listId) {
        const input = document.getElementById(inputId);
        const list = document.getElementById(listId);
        const value = input.value.trim();
        list.innerHTML = "";

        if (value.length < 3) {
          list.classList.add("hidden");
          return;
        }

        const upperCaseValue = value.toUpperCase();
        let matches = [];

        // 1. Lokale Suche (schnell)
        for (const code in airportData) {
          const airport = airportData[code];
          if (
            code.includes(upperCaseValue) ||
            airport.name.toUpperCase().includes(upperCaseValue)
          ) {
            matches.push({ code, ...airport });
          }
        }

        // 2. Externe API-Suche (langsamer)
        const apiResults = await window.fetchExternalAirport(value);

        // 3. Ergebnisse zusammenf√ºhren und Duplikate entfernen
        if (apiResults && apiResults.length > 0) {
          const existingCodes = new Set(matches.map((m) => m.code));
          apiResults.forEach((result) => {
            if (!existingCodes.has(result.code)) {
              matches.push(result);
            }
          });
        }

        // 4. Ergebnisse alphabetisch sortieren
        matches.sort((a, b) => a.name.localeCompare(b.name));

        // 5. Ergebnisse anzeigen
        if (matches.length > 0) {
          matches.slice(0, 10).forEach((match) => {
            // Begrenze auf 10 Ergebnisse zur √úbersicht
            const item = document.createElement("div");
            item.className =
              "p-2 cursor-pointer text-gray-700 dark:text-gray-300 autocomplete-item";
            item.textContent = `${match.name} (${match.code})`;
            item.addEventListener("click", () => {
              selectAutocompleteItem(input, list, match); // √úbergib das komplette Objekt
            });
            list.appendChild(item);
          });
          list.classList.remove("hidden");
        } else {
          list.classList.add("hidden");
        }
      }

      var hideAllAutocompleteLists = function () {
        document.getElementById("departure-list").classList.add("hidden");
        document.getElementById("arrival-list").classList.add("hidden");
      };

      function selectAutocompleteItem(input, list, selectedAirport) {
        // Stelle sicher, dass die Stadtinformation an die Speicherfunktion √ºbergeben wird
        cacheAndSaveAirport({
          code: selectedAirport.code,
          name: selectedAirport.name,
          lat: selectedAirport.lat,
          lon: selectedAirport.lon,
          city: selectedAirport.city, // KORREKTUR: Stadtinformation hinzuf√ºgen
        });

        input.value = selectedAirport.code;
        list.classList.add("hidden");
        updateFlightDetails();
        input.focus();
      }

      var updateFlightDetails = function () {
            var departureInput = document.getElementById("departure").value;
            var arrivalInput = document.getElementById("arrival").value;
            var flightClass = document.getElementById("flightClass").value; // NEU
            var departureAirport = findAirport(departureInput);
            var arrivalAirport = findAirport(arrivalInput);
            var distanceDisplay = document.getElementById("distance-display");
            var timeDisplay = document.getElementById("time-display");
            var co2Display = document.getElementById("co2-display"); // NEU
            var logButton = document.getElementById("log-button");
            
            distanceDisplay.textContent = "-";
            timeDisplay.textContent = "-";
            co2Display.textContent = "-"; // NEU
            logButton.disabled = true;

            if (departureAirport && arrivalAirport) {
                var distance = calculateDistance(departureAirport.lat, departureAirport.lon, arrivalAirport.lat, arrivalAirport.lon);
                var estimatedTime = estimateFlightTime(distance);
                var estimatedCO2 = calculateCO2(distance, flightClass); // NEU

                distanceDisplay.textContent = `${Math.round(distance).toLocaleString("de-DE")} km`;
                timeDisplay.textContent = estimatedTime;
                co2Display.textContent = `${estimatedCO2.toLocaleString("de-DE")} kg`; // NEU
                logButton.disabled = false;
            } else if (departureInput.trim().length === 3 && arrivalInput.trim().length === 3) {
                logButton.disabled = false;
                distanceDisplay.textContent = "Berechnung...";
                timeDisplay.textContent = "Berechnung...";
                co2Display.textContent = "Berechnung..."; // NEU
            }
        };

      /**
       * Setzt das Formular zur√ºck und beendet den Bearbeitungsmodus.
       */
      window.resetForm = function () {
        // Formularfelder leeren
        document.getElementById("departure").value = "";
        document.getElementById("arrival").value = "";
        document.getElementById("flightDate").value = "";
        document.getElementById("flightNumber").value = "";
		document.getElementById("airline").value = "";
        document.getElementById("aircraftType").value = "";
        document.getElementById("notes").value = "";
        document.getElementById("price").value = "";
        document.getElementById("currency").value = "";
		document.getElementById("registration").value = "";

        // Foto-Feld und Vorschau zur√ºcksetzen
        document.getElementById("flightPhoto").value = null;
        document
          .getElementById("photo-preview-container")
          .classList.add("hidden");
        document.getElementById("photo-preview-text").textContent = getTranslation('form.noFileSelected');

        // Zustand zur√ºcksetzen
        currentlyEditingFlightData = null;

        // UI zur√ºcksetzen
        const logButton = document.getElementById("log-button");
        logButton.textContent = "Flug loggen und speichern";
        document.getElementById("cancel-edit-button").classList.add("hidden");

        updateFlightDetails(); // Setzt Distanz etc. zur√ºck und deaktiviert den Button
      };

      /**
       * Startet den Bearbeitungsmodus f√ºr einen bestimmten Flug.
       * @param {number} id - Die ID des zu bearbeitenden Flugs.
       */
      window.editFlight = async function (id) {
        showTab("neue-fluege"); // Wechsle zum Formular-Tab
        // Wenn die Gesamtansicht aktiv ist, schalte sie zuerst aus
        if (isAllRoutesViewActive) {
          toggleAllRoutesView();
        }
        const flights = await getFlights();
        const flightToEdit = flights.find((flight) => flight.id === id);

        if (!flightToEdit) {
          showMessage(
            "Fehler",
            "Der zu bearbeitende Flug wurde nicht gefunden.",
            "error"
          );
          return;
        }

        const previewContainer = document.getElementById(
          "photo-preview-container"
        );
        const previewText = document.getElementById("photo-preview-text");
        if (flightToEdit.photo_url && flightToEdit.photo_url.length > 0) {
          previewText.textContent = `Bereits ${flightToEdit.photo_url.length} Foto(s) zu diesem Flug gespeichert.`;
          previewContainer.classList.remove("hidden");
        } else {
          previewContainer.classList.add("hidden");
        }

        // Zeichne die Route des aktuell ausgew√§hlten Flugs auf der Karte
        window.drawRouteOnMap(
          flightToEdit.depLat,
          flightToEdit.depLon,
          flightToEdit.arrLat,
          flightToEdit.arrLon,
          flightToEdit.departure,
          flightToEdit.arrival,
          flightToEdit.depName,
          flightToEdit.arrName
        );

        // Formular mit den Flugdaten f√ºllen
        document.getElementById("departure").value = flightToEdit.departure;
        document.getElementById("arrival").value = flightToEdit.arrival;
        document.getElementById("flightDate").value = flightToEdit.date;
        document.getElementById("flightClass").value = flightToEdit.class;
        document.getElementById("flightNumber").value = flightToEdit.flightNumber;
		document.getElementById("airline").value = flightToEdit.airline || '';
        document.getElementById("aircraftType").value = flightToEdit.aircraftType;
        document.getElementById("notes").value = flightToEdit.notes;
        document.getElementById("price").value = typeof flightToEdit.price === "number" ? flightToEdit.price : "";
        document.getElementById("currency").value = flightToEdit.currency || "";
		document.getElementById("registration").value = flightToEdit.registration || '';

        // Bearbeitungszustand setzen
        currentlyEditingFlightData = flightToEdit;

        // UI f√ºr den Bearbeitungsmodus anpassen
        const logButton = document.getElementById("log-button");
        logButton.textContent = "√Ñnderungen speichern";
        document
          .getElementById("cancel-edit-button")
          .classList.remove("hidden");

        updateFlightDetails(); // Berechnet Distanz/Zeit f√ºr die geladenen Flugh√§fen

        // Zum Formular scrollen f√ºr eine bessere User Experience
        document
          .getElementById("log-button")
          .scrollIntoView({ behavior: "smooth", block: "center" });
      };

      /**
       * Schaltet die Kartenansicht zwischen dem letzten Flug und allen Fl√ºgen um.
       */
      window.toggleAllRoutesView = async function () {
		stopAnimation();
        isAllRoutesViewActive = !isAllRoutesViewActive; // Zustand umkehren
        const btn = document.getElementById("toggle-map-view-btn");

        if (isAllRoutesViewActive) {
          // Zur Gesamtansicht wechseln
          let allFlights = await getFlights();
          allFlights = resequenceAndAssignNumbers(allFlights);

          drawAllRoutesOnMap(allFlights);
          btn.textContent = getTranslation('flights.showSingleRoute'); // KORRIGIERT
        } else {
          // Zur√ºck zur Einzelansicht wechseln
          renderFlights(); // Stellt den Standardzustand wieder her
          btn.textContent = getTranslation('flights.showAllRoutes'); // KORRIGIERT
        }
      };

      /**
       * Zeichnet alle Flugrouten UND Flughafen-Marker auf die Karte,
       * und gruppiert dabei identische Routen.
       * @param {Array<Object>} flights - Ein Array mit allen Flug-Objekten.
       */
      window.drawAllRoutesOnMap = function (flights) {
        const mapInfo = document.getElementById("map-info");
        routeLayer.clearLayers();

        if (!flights || flights.length === 0) {
          mapInfo.textContent = getTranslation('flights.mapNoFlights'); // KORRIGIERT
          map.setView([20, 0], 2);
          return;
        }

        const routeGroups = {};
        // Ein Objekt, um alle einzigartigen Flugh√§fen zu sammeln
        const uniqueAirports = {};

        // Alle Fl√ºge durchgehen, um Routen zu gruppieren UND Flugh√§fen zu sammeln
        flights.forEach((flight) => {
          if (flight.depLat && flight.arrLat) {
            // --- Routen gruppieren (wie bisher) ---
            const routeKey = [flight.departure, flight.arrival]
              .sort()
              .join("-");
            if (!routeGroups[routeKey]) {
              routeGroups[routeKey] = {
                latLngs: [
                  [flight.depLat, flight.depLon],
                  [flight.arrLat, flight.arrLon],
                ],
                flightNumbers: [],
              };
            }
            routeGroups[routeKey].flightNumbers.push(flight.flightLogNumber);

            // --- Einzigartige Flugh√§fen sammeln ---
            if (!uniqueAirports[flight.departure]) {
              uniqueAirports[flight.departure] = {
                name: flight.depName,
                lat: flight.depLat,
                lon: flight.depLon,
              };
            }
            if (!uniqueAirports[flight.arrival]) {
              uniqueAirports[flight.arrival] = {
                name: flight.arrName,
                lat: flight.arrLat,
                lon: flight.arrLon,
              };
            }
          }
        });

        const bounds = [];

        // 1. Linien f√ºr die gruppierten Routen zeichnen
        Object.values(routeGroups).forEach((group) => {
          const flightCount = group.flightNumbers.length;

          // Wir berechnen die Linienst√§rke. Basis = 1.5, +0.5 f√ºr jeden weiteren Flug auf der Route.
          // Mit Math.min begrenzen wir die maximale Dicke auf einen sinnvollen Wert (z.B. 8).
          const weight = Math.min(1.5 + (flightCount - 1) * 0.5, 8);
          const opacity = 0.6 + flightCount * 0.05; // Linien werden auch etwas deckender

          const flightPath = L.polyline(group.latLngs, {
            color: "#312E81",
            weight: weight, // Dynamische St√§rke
            opacity: opacity, // Dynamische Deckkraft
          });
          const labelText = group.flightNumbers
            .sort((a, b) => a - b)
            .map((n) => `#${n}`)
            .join(", ");
          flightPath.bindTooltip(labelText, {
            permanent: true,
            direction: "center",
            className: "flight-number-label",
          });
          flightPath.addTo(routeLayer);
          bounds.push(group.latLngs[0]);
          bounds.push(group.latLngs[1]);
        });

        // 2. Marker f√ºr alle einzigartigen Flugh√§fen zeichnen
        Object.keys(uniqueAirports).forEach((iataCode) => {
          const airport = uniqueAirports[iataCode];
          const marker = L.marker([airport.lat, airport.lon]);
          marker.bindPopup(`<b>${airport.name}</b> (${iataCode})`);
          marker.addTo(routeLayer);
        });

        if (bounds.length > 0) {
          map.fitBounds(bounds, { padding: [40, 40] });
        }

        // KORRIGIERT
		mapInfo.textContent = getTranslation('flights.mapOverview')
			.replace('{count}', Object.keys(routeGroups).length);
      };
	  
		/**
         * Eine einfache Hilfsfunktion, um eine Pause in async-Funktionen zu erzeugen.
         * @param {number} ms - Die Wartezeit in Millisekunden.
         */
        const delay = ms => new Promise(res => setTimeout(res, ms));
		
		/**
         * Stoppt die laufende Reise-Chronik-Animation komplett und setzt sie zur√ºck.
         */
        function stopAnimation() {
    animationState = 'stopped';
    animationStartIndex = 0;    

    const btn = document.getElementById('play-chronicle-btn');
    if (btn) {
        btn.disabled = false;
        btn.innerHTML = getTranslation('flights.playChronicle'); // KORRIGIERT
    }
}
		
		/**
         * Erstellt eine Liste von Zwischenpunkten zwischen einem Start- und Endpunkt.
         * @param {number} startLat - Start-Latitude
         * @param {number} startLng - Start-Longitude
         * @param {number} endLat - Ziel-Latitude
         * @param {number} endLng - Ziel-Longitude
         * @param {number} steps - Die Anzahl der Segmente, in die die Linie geteilt wird.
         * @returns {Array<Array<number>>} Eine Liste von [lat, lng] Koordinatenpaaren.
         */
        function interpolatePoints(startLat, startLng, endLat, endLng, steps) {
            const points = [];
            const deltaLat = (endLat - startLat) / steps;
            const deltaLng = (endLng - startLng) / steps;

            for (let i = 0; i <= steps; i++) {
                points.push([
                    startLat + (deltaLat * i),
                    startLng + (deltaLng * i)
                ]);
            }
            return points;
        }

        /**
         * Startet, pausiert oder setzt die Reise-Chronik-Animation fort.
         */
        async function animateTravelChronicle() {
            const btn = document.getElementById('play-chronicle-btn');

            // --- KORREKTUR F√úR DEN ZOOM-FIX ---
            // Wir f√ºhren den "Weckruf" aus, den "Alle Routen anzeigen" sonst macht.
            if (animationState === 'stopped') { 
                // Nur ausf√ºhren, wenn wir GANZ neu starten
                map.invalidateSize(); // Gr√∂√üe neu berechnen
                map.setView([20, 0], 2); // Auf neutrale Position zoomen
                await delay(150); // Gib der Karte 150ms Zeit, den Zoom zu verarbeiten
            }
            // --- ENDE KORREKTUR ---

            if (animationState === 'running') {
                animationState = 'paused';
                btn.innerHTML = getTranslation('flights.continueChronicle');
                return; 
            }

            if (animationState === 'paused') {
                animationState = 'running';
                btn.innerHTML = getTranslation('flights.pauseChronicle');
                runAnimationLoop(); 
                return;
            }

            animationState = 'running';
            animationStartIndex = 0; 
            btn.innerHTML = getTranslation('flights.pauseChronicle');
            
            // Die invalidateSize/delay-Logik von hier wurde nach oben verschoben,
            // damit sie VOR der 'running'-Pr√ºfung passiert.
            
            runAnimationLoop(); 
        }

        /**
         * Die Haupt-Animationsschleife (ausgelagert f√ºr Pause/Fortsetzen).
         */
        async function runAnimationLoop() {
            const mapInfo = document.getElementById('map-info');
            
            // Nur beim allerersten Start (Reset) die Karte leeren
            if (animationStartIndex === 0) { 
                routeLayer.clearLayers();
                map.setView([20, 0], 2);
                await delay(100); // Kurze Pause nach dem Reset
            }

            const allFlights = await getFlights();
            if (allFlights.length === 0) {
                mapInfo.textContent = 'Keine Fl√ºge zum Animieren vorhanden.';
                stopAnimation();
                return;
            }

            const sortedFlights = resequenceAndAssignNumbers(allFlights);
            const chronicleColors = ['#312E81', '#10B981', '#E11D48', '#14B8A6', '#D97706'];

            try {
                // Starte die Schleife bei dem Flug, bei dem pausiert wurde (oder 0)
                for (let i = animationStartIndex; i < sortedFlights.length; i++) {
                    
                    // KORREKTUR 2 (PAUSE-FIX):
                    // Die Pr√ºfung findet jetzt VOR dem Zeichnen des n√§chsten Flugs statt.
                    if (animationState !== 'running') {
                        animationStartIndex = i; // Speichere den Index des N√ÑCHSTEN Flugs
                        
                        if (animationState === 'paused') {
                             mapInfo.textContent = `Animation pausiert. Bereit f√ºr Flug #${sortedFlights[i].flightLogNumber}.`;
                        }
                        return; // Beende die Funktion, die Schleife wird hier unterbrochen
                    }

                    const flight = sortedFlights[i];
                    const color = chronicleColors[i % chronicleColors.length];

                    if (flight.depLat && flight.arrLat) {
                        mapInfo.textContent = `Flug ${flight.flightLogNumber} / ${sortedFlights.length}: ${flight.date} von ${flight.departure} nach ${flight.arrival}`;

                        L.marker([flight.depLat, flight.depLon]).addTo(routeLayer);
                        L.marker([flight.arrLat, flight.arrLon]).addTo(routeLayer);
                        
                        // Der Zoom-Fix (durch das Warten in animateTravelChronicle) sollte jetzt greifen
                        map.fitBounds([[flight.depLat, flight.depLon], [flight.arrLat, flight.arrLon]], { padding: [50, 50] });

                        const animationSteps = 40;
                        const animationDurationMs = 3000; 
                        const delayPerStep = animationDurationMs / animationSteps;
                        const points = interpolatePoints(flight.depLat, flight.depLon, flight.arrLat, flight.arrLon, animationSteps);
                        
                        const animatedPath = L.polyline([], { color: color, weight: 2.5, opacity: 0.8 }).addTo(routeLayer);
                        const decorator = L.polylineDecorator(animatedPath, {
                            patterns: [ { offset: '100%', repeat: 0, symbol: L.Symbol.arrowHead({ pixelSize: 12, pathOptions: { color: color, fillOpacity: 1, weight: 0 } }) } ]
                        }).addTo(routeLayer);

                        const iconHtml = `<span style="color: ${color};">#${flight.flightLogNumber}</span>`;
                        const flightMarkerIcon = L.divIcon({ html: iconHtml, className: 'animated-flight-marker', iconSize: [30, 20] });
                        const flightMarker = L.marker(points[0], { icon: flightMarkerIcon }).addTo(routeLayer);

                        // Diese innere Schleife l√§uft jetzt immer bis zum Ende durch
                        for (let p = 0; p < points.length; p++) {
                            animatedPath.addLatLng(points[p]);
                            decorator.setPaths(animatedPath); 
                            flightMarker.setLatLng(points[p]); 
                            await delay(delayPerStep);
                        }
                        
                        const centerLatLng = animatedPath.getCenter();
                        flightMarker.setLatLng(centerLatLng);
                    }
                } // Ende der 'for'-Schleife

                if (animationState === 'running') {
                    mapInfo.textContent = `Reise-Chronik abgeschlossen. ${sortedFlights.length} Fl√ºge angezeigt.`;
                }
            } catch (error) {
                console.error("Fehler bei der Reise-Chronik Animation:", error);
                mapInfo.textContent = "Animation fehlgeschlagen.";
            } finally {
                // Setzt den Zustand zur√ºck, WENN die Animation nicht pausiert wurde
                if (animationState !== 'paused') {
                    stopAnimation();
                }
            }
        }

      // *** Hauptfunktion (jetzt f√ºr Loggen & Aktualisieren) ***
      window.logFlight = async function () {
        if (currentlyEditingFlightData !== null) {
          await updateFlight();
          return;
        }

		const logButton = document.getElementById("log-button");
        logButton.textContent = "Speichere...";
        logButton.disabled = true;

        const {
          data: { user },
        } = await supabaseClient.auth.getUser();
        if (!user) {
          showMessage("Fehler", "Nicht eingeloggt. Bitte neu laden.", "error");
          logButton.disabled = false;
          return;
        }

        const photoFiles = document.getElementById("flightPhoto").files;
        const photoUrls = await uploadFlightPhotos(photoFiles);

        const depCodeInput = document
          .getElementById("departure")
          .value.trim()
          .toUpperCase();
        const arrCodeInput = document
          .getElementById("arrival")
          .value.trim()
          .toUpperCase();
        let departureAirport =
          findAirport(depCodeInput) ||
          (await window.fetchExternalAirport(depCodeInput));
        let arrivalAirport =
          findAirport(arrCodeInput) ||
          (await window.fetchExternalAirport(arrCodeInput));

        if (!departureAirport || !arrivalAirport) {
          showMessage(
            "Fehler",
            "Mindestens ein Flughafen-Code wurde nicht gefunden.",
            "error"
          );
          logButton.textContent = "Flug loggen und speichern";
          logButton.disabled = false;
          return;
        }

        await cacheAndSaveAirport(departureAirport);
        await cacheAndSaveAirport(arrivalAirport);

        const distance = calculateDistance(
          departureAirport.lat,
          departureAirport.lon,
          arrivalAirport.lat,
          arrivalAirport.lon
        );
        const newFlightId = new Date().getTime();
		
		const flightClass = document.getElementById("flightClass").value;
		const calculatedCO2 = calculateCO2(distance, flightClass);

        // KORREKTE LOGIK F√úR PREIS
        const priceInput = document.getElementById("price").value;

        const newFlightForSupabase = {
          flight_id: newFlightId,
          user_id: user.id,
          date:
            document.getElementById("flightDate").value ||
            new Date().toISOString().slice(0, 10),
          departure: departureAirport.code,
          arrival: arrivalAirport.code,
          distance: Math.round(distance),
          time: estimateFlightTime(distance),
          class: document.getElementById("flightClass").value,
		  co2_kg: calculatedCO2,
          flightNumber: document.getElementById("flightNumber").value.trim(),
		  airline: document.getElementById("airline").value.trim(),
          aircraftType: document.getElementById("aircraftType").value.trim(),
          notes: document.getElementById("notes").value.trim(),
          depLat: departureAirport.lat,
          depLon: departureAirport.lon,
          arrLat: arrivalAirport.lat,
          arrLon: arrivalAirport.lon,
          depName: departureAirport.name,
          arrName: arrivalAirport.name,
          photo_url: photoUrls,
          price:
            priceInput !== "" && !isNaN(parseFloat(priceInput))
              ? parseFloat(priceInput)
              : null,
          currency:
            document.getElementById("currency").value.trim().toUpperCase() ||
            null,
		  registration: document.getElementById("registration").value.trim().toUpperCase() || null,
        };

        const { error } = await supabaseClient
          .from("flights")
          .insert(newFlightForSupabase);

        if (error) {
          showMessage(
            "Speicherfehler",
            "Der Flug konnte nicht in der Datenbank gespeichert werden.",
            "error"
          );
          console.error("Supabase Insert Error:", error);
        } else {
          showMessage(
            "Erfolg!",
            `Flug von ${departureAirport.name} nach ${arrivalAirport.name} erfolgreich geloggt.`,
            "success"
          );
          resetForm();
          renderFlights(null, newFlightId);
        }
        logButton.textContent = "Flug loggen und speichern";
        logButton.disabled = true;
      };

      /**
       * Aktualisiert die Paginierungs-UI (Button-Zust√§nde, Seitenzahlanzeige).
       * @param {Array<Object>} allFlights - Das komplette, ungefilterte Array aller Fl√ºge.
       */
      function updatePaginationUI(allFlights) {
        const pageInfo = document.getElementById("page-info");
        const prevBtn = document.getElementById("prev-page-btn");
        const nextBtn = document.getElementById("next-page-btn");
        const paginationControls = document.getElementById(
          "pagination-controls"
        );

        const totalPages = Math.ceil(allFlights.length / ITEMS_PER_PAGE);

        if (totalPages <= 1) {
          paginationControls.style.display = "none"; // Verstecke Steuerung, wenn nicht ben√∂tigt
          return;
        }
		
		// Stelle sicher, dass die Leiste sichtbar ist, wenn sie gebraucht wird.
            paginationControls.style.display = "flex";

        // Dynamischen Text verwenden
		pageInfo.textContent = getTranslation('flights.pageInfo')
        .replace('{currentPage}', currentPage)
        .replace('{totalPages}', totalPages);

		prevBtn.disabled = currentPage === 1;
		nextBtn.disabled = currentPage === totalPages;
      }

      /**
       * Wechselt zur n√§chsten Seite.
       */
      function nextPage() {
        renderFlights(null, null, currentPage + 1);
      }

      /**
       * Wechselt zur vorherigen Seite.
       */
      function prevPage() {
        renderFlights(null, null, currentPage - 1);
      }

      /**
       * Speichert die √Ñnderungen eines bestehenden Fluges in Supabase.
       */
      async function updateFlight() {
        const logButton = document.getElementById("log-button");
        logButton.textContent = "Aktualisiere...";
        logButton.disabled = true;

        let photoUrls = currentlyEditingFlightData.photo_url || [];
        const newPhotoFiles = document.getElementById("flightPhoto").files;

        if (newPhotoFiles.length > 0) {
          if (photoUrls && photoUrls.length > 0) {
            const oldFilePaths = photoUrls.map((url) =>
              url.substring(url.lastIndexOf("public/") + 7)
            );
            await supabaseClient.storage
              .from("flight-photos")
              .remove(oldFilePaths);
          }
          photoUrls = await uploadFlightPhotos(newPhotoFiles);
        }

        const depCodeInput = document
          .getElementById("departure")
          .value.trim()
          .toUpperCase();
        const arrCodeInput = document
          .getElementById("arrival")
          .value.trim()
          .toUpperCase();
        let departureAirport =
          findAirport(depCodeInput) ||
          (await window.fetchExternalAirport(depCodeInput));
        let arrivalAirport =
          findAirport(arrCodeInput) ||
          (await window.fetchExternalAirport(arrCodeInput));

        if (!departureAirport || !arrivalAirport) {
          showMessage(
            "Flug nicht speicherbar",
            "Mindestens ein Flughafen-Code wurde nicht gefunden.",
            "error"
          );
          resetForm();
          return;
        }

        await cacheAndSaveAirport(departureAirport);
        await cacheAndSaveAirport(arrivalAirport);

        const distance = calculateDistance(
          departureAirport.lat,
          departureAirport.lon,
          arrivalAirport.lat,
          arrivalAirport.lon
        );

		const flightClass = document.getElementById("flightClass").value;
		const calculatedCO2 = calculateCO2(distance, flightClass);

        // KORREKTE LOGIK F√úR PREIS
        const priceInput = document.getElementById("price").value;

        const updatedFlightForSupabase = {
          date: document.getElementById("flightDate").value,
          departure: departureAirport.code,
          arrival: arrivalAirport.code,
          distance: Math.round(distance),
          time: estimateFlightTime(distance),
          class: document.getElementById("flightClass").value,
		  co2_kg: calculatedCO2,
          flightNumber: document.getElementById("flightNumber").value.trim(),
          aircraftType: document.getElementById("aircraftType").value.trim(),
          notes: document.getElementById("notes").value.trim(),
          depLat: departureAirport.lat,
          depLon: departureAirport.lon,
          arrLat: arrivalAirport.lat,
          arrLon: arrivalAirport.lon,
          depName: departureAirport.name,
          arrName: arrivalAirport.name,
          photo_url: photoUrls,
          price:
            priceInput !== "" && !isNaN(parseFloat(priceInput))
              ? parseFloat(priceInput)
              : null,
          currency:
            document.getElementById("currency").value.trim().toUpperCase() ||
            null,
		  registration: document.getElementById("registration").value.trim().toUpperCase() || null,
        };

        const { error } = await supabaseClient
          .from("flights")
          .update(updatedFlightForSupabase)
          .eq("flight_id", currentlyEditingFlightData.id);

        if (error) {
          showMessage(
            "Update-Fehler",
            "Die √Ñnderungen konnten nicht gespeichert werden.",
            "error"
          );
          console.error("Supabase Update Error:", error);
        } else {
          showMessage(
            "Erfolg!",
            "Die Flugdaten wurden erfolgreich aktualisiert.",
            "success"
          );
        }
        const flightIdToFocus = currentlyEditingFlightData.id;
        resetForm();
        renderFlights(null, flightIdToFocus);
      }

      // *** Rendern und L√∂schen ***
      window.deleteFlight = async function (id) {
        // Eine Best√§tigung ist bei L√∂schaktionen immer eine gute Idee
        if (
          !confirm(
            "Sind Sie sicher, dass Sie diesen Flug endg√ºltig l√∂schen m√∂chten?"
          )
        ) {
          return;
        }

        const { error } = await supabaseClient
          .from("flights")
          .delete()
          .eq("flight_id", id);

        if (error) {
          showMessage(
            "L√∂schfehler",
            "Der Flug konnte nicht gel√∂scht werden.",
            "error"
          );
          console.error("Supabase Delete Error:", error);
        } else {
          showMessage("Erfolg!", "Der Flug wurde gel√∂scht.", "success");
          renderFlights(); // Lade die Liste einfach neu
        }
      };

      window.renderFlights = async function (
        flightsToRender,
        flightIdToFocus,
        page = 1
      ) {
        stopAnimation();
		currentPage = page;

        isAllRoutesViewActive = false;
        document.getElementById("toggle-map-view-btn").textContent =
      getTranslation('flights.showAllRoutes');

        let allFlights = flightsToRender || (await getFlights());

        // NEU: Nummerierung nach dem Laden der Daten anwenden
        allFlights = resequenceAndAssignNumbers(allFlights);

        if (allFlights.length > 0) {
          const sortKey = currentSort.key;
          const direction = currentSort.direction === "asc" ? 1 : -1;

          allFlights.sort((a, b) => {
            const valA = a[sortKey];
            const valB = b[sortKey];
            let comparison = 0;

            if (typeof valA === "number") {
              comparison = valA - valB;
            } else if (sortKey === "date") {
              // KORREKTUR: Hier stand f√§lschlicherweise b[sortKey]
              comparison = new Date(valA) - new Date(valB);
            } else {
              comparison = (valA || "").localeCompare(valB || "");
            }
            return comparison * direction;
          });
        }
        updateCharts(allFlights); // Ruft die Charts mit der Standard-Jahresansicht auf
        updatePaginationUI(allFlights);
        updateStatisticsDisplay(allFlights);

        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const paginatedFlights = allFlights.slice(startIndex, endIndex);

        let flightForMap = null;
        if (flightIdToFocus) {
          flightForMap = allFlights.find((f) => f.id === flightIdToFocus);
        }
        if (!flightForMap && allFlights.length > 0) {
          flightForMap = paginatedFlights[0] || allFlights[0]; // Nimm den ersten der aktuellen Seite
        }

        if (flightForMap) {
          window.drawRouteOnMap(
            flightForMap.depLat,
            flightForMap.depLon,
            flightForMap.arrLat,
            flightForMap.arrLon,
            flightForMap.departure,
            flightForMap.arrival,
            flightForMap.depName,
            flightForMap.arrName
          );
        } else {
          window.drawRouteOnMap();
        }

        const flightList = document.getElementById("flight-log-list");
        flightList.innerHTML = "";

        if (paginatedFlights.length === 0 && currentPage === 1) {
          flightList.innerHTML = `<p id="no-flights-message" class="log-placeholder text-gray-500 italic text-center py-4">${getTranslation('flights.noFlights')}</p>`;
} else {
          paginatedFlights.forEach((flight) => {
            const depName =
              airportData[flight.departure]?.name || flight.departure;
            const arrName = airportData[flight.arrival]?.name || flight.arrival;

            // Rufe die Hilfsfunktion auf, um die Farbe zu bestimmen
            const milestoneColor = getMilestoneColor(flight.flightLogNumber);

            const flightElement = document.createElement("div");
            flightElement.className =
              "bg-white dark:bg-gray-800 p-3 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 hover:shadow-lg transition flex justify-between items-start";

            // KORRIGIERTER innerHTML Block
            flightElement.innerHTML = `
            <div class="flex items-start gap-4 flex-grow">
                <div class="flex-shrink-0 ${milestoneColor} text-white w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm" title="${getTranslation('flights.flightNumberTitle')}">
                    #${flight.flightLogNumber || "-"}
                </div>
                <div class="flex-grow">
                    <p class="text-base md:text-lg font-bold text-indigo-700 dark:text-indigo-400">
                        ${depName} (${flight.departure}) ‚ûî ${arrName} (${flight.arrival})
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                        üìÖ ${flight.date} | ‚è±Ô∏è ${flight.time} | üìè ${flight.distance.toLocaleString("de-DE")} km
                    </p>
                    <p class="text-sm font-semibold text-red-600 dark:text-red-400 mt-1">
                        ${getTranslation('flights.co2Info').replace('{co2}', flight.co2_kg ? flight.co2_kg.toLocaleString('de-DE') : 'k.A.')}
                    </p>
                    ${
                      (flight.flightNumber || flight.airline || flight.aircraftType)
                        ? `<p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                              ${getTranslation('flights.flightDetails')
                                  .replace('{flightNumber}', flight.flightNumber || '-')
                                  .replace('{airline}', flight.airline || '-')
                                  .replace('{aircraftType}', flight.aircraftType || '-')}
                          </p>`
                        : ""
                    }
                        ${
                          flight.photo_url && flight.photo_url.length > 0
                            ? `<div class="mt-2 flex gap-2">${flight.photo_url
                                .map(
                                  (url) => `
                                <a href="${url}" target="_blank">
                                    <img src="${url}" alt="Flugfoto" class="h-12 w-12 rounded-md object-cover shadow-sm hover:scale-110 transition">
                                </a>`
                                )
                                .join("")}
                               </div>`
                            : ""
                        }
                        ${
                          flight.notes
                            ? `<p class="text-xs text-gray-700 dark:text-gray-300 italic mt-2 border-l-2 border-indigo-400 pl-2">
                                  ${flight.notes}
                              </p>`
                            : ""
                        }
                    </div>
                </div>
                <div class="flex flex-col md:flex-row items-center ml-2">
                <button onclick="editFlight(${flight.id})" class="p-2 text-blue-500 hover:text-blue-700 transition" title="${getTranslation('flights.editTitle')}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                    </button>
                    <button onclick="deleteFlight(${flight.id})" class="p-2 text-red-500 hover:text-red-700 transition" title="${getTranslation('flights.deleteTitle')}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `;
            flightList.appendChild(flightElement);
          });
        }

        updateSortButtonUI();
      };

      /**
       * Sortiert Fl√ºge chronologisch nach Datum und weist sequenzielle Flugbuch-Nummern zu.
       * @param {Array<Object>} flights - Das Array der Flug-Objekte.
       * @returns {Array<Object>} Das sortierte und neu nummerierte Array.
       */
      function resequenceAndAssignNumbers(flights) {
        // 1. Sortiere die Fl√ºge. Prim√§res Kriterium ist das Datum (aufsteigend).
        // Als zweites Kriterium dient die technische ID, um eine stabile Reihenfolge
        // bei Fl√ºgen am selben Tag zu gew√§hrleisten.
        const sortedFlights = flights.sort((a, b) => {
          const dateComparison = new Date(a.date) - new Date(b.date);
          if (dateComparison !== 0) {
            return dateComparison;
          }
          return a.id - b.id; // Fallback-Sortierung f√ºr Fl√ºge am gleichen Tag
        });

        // 2. Weise die neuen, sequenziellen Flugbuch-Nummern zu.
        sortedFlights.forEach((flight, index) => {
          flight.flightLogNumber = index + 1;
        });

        return sortedFlights;
      }

      /**
       * Zeichnet die Flugroute mit Markern auf die interaktive Leaflet-Karte.
       */
      window.drawRouteOnMap = async function (
        depLat,
        depLon,
        arrLat,
        arrLon,
        depCode,
        arrCode,
        depName,
        arrName
      ) {
        var mapInfo = document.getElementById("map-info");
        routeLayer.clearLayers();

        if (!depLat || !arrLat) {
            // Setze statischen Text und entferne alte Daten-Attribute
            mapInfo.textContent = getTranslation('mapInfo'); // z.B. "Kein Flug geloggt..."
            mapInfo.removeAttribute('data-dynamic-depName');
            map.setView([20, 0], 2);
            return;
        }

        /**
		// NEU: Wetterdaten f√ºr Start und Ziel gleichzeitig abrufen
        const [depWeather, arrWeather] = await Promise.all([
          window.fetchWeatherByCoords(depLat, depLon),
          window.fetchWeatherByCoords(arrLat, arrLon),
        ]);
		*/

        // Popup-Inhalte mit Wetterinformationen erstellen
        const depPopupContent = `<b>Abflug:</b> ${depName} (${depCode})`;
        const arrPopupContent = `<b>Ankunft:</b> ${arrName} (${arrCode})`;
		

        const depMarker = L.marker([depLat, depLon]).bindPopup(depPopupContent);
        const arrMarker = L.marker([arrLat, arrLon]).bindPopup(arrPopupContent);
		


        const flightPath = L.polyline(
          [
            [depLat, depLon],
            [arrLat, arrLon],
          ],
          { color: "#10B981", weight: 3 }
        );

        routeLayer.addLayer(depMarker);
        routeLayer.addLayer(arrMarker);
        routeLayer.addLayer(flightPath);

        map.fitBounds(
          [
            [depLat, depLon],
            [arrLat, arrLon],
          ],
          { padding: [50, 50] }
        );
       
	   // --- NEUE LOGIK HIER ---
        // 1. Speichere die dynamischen Teile als "data-" Attribute
        mapInfo.setAttribute('data-dynamic-depName', depName);
        mapInfo.setAttribute('data-dynamic-depCode', depCode);
        mapInfo.setAttribute('data-dynamic-arrName', arrName);
        mapInfo.setAttribute('data-dynamic-arrCode', arrCode);

        // 2. Hole die √úbersetzungsvorlage
        const template = getTranslation('mapVisualization'); 

        // 3. Ersetze die Platzhalter
        const translatedText = template
            .replace('{depName}', depName)
            .replace('{depCode}', depCode)
            .replace('{arrName}', arrName)
            .replace('{arrCode}', arrCode);

        // 4. Setze den fertigen Text
        mapInfo.textContent = translatedText;
    };

      /**
       * Aktualisiert die UI der Sortier-Buttons, um den aktiven Zustand anzuzeigen.
       */
      function updateSortButtonUI() {
        // Entferne zuerst alle aktiven Zust√§nde und Pfeile
        document.querySelectorAll(".sort-btn").forEach((btn) => {
          btn.classList.remove("active");
          btn.textContent = btn.textContent.replace(/ [‚ñ≤‚ñº]/, "");
        });

        // Setze den aktiven Zustand und Pfeil f√ºr den aktuellen Sortier-Button
        const activeButton = document.getElementById(
          `sort-btn-${currentSort.key}`
        );
        if (activeButton) {
          activeButton.classList.add("active");
          activeButton.textContent +=
            currentSort.direction === "asc" ? " ‚ñ≤" : " ‚ñº";
        }
      }

      /**
       * Wendet die in der Filterleiste eingegebenen Kriterien an und rendert die Ergebnisliste neu.
       */
      window.applyFilters = async function () {
        // 'async' hinzugef√ºgt
        currentPage = 1;
        const allFlights = await getFlights(); // 'await' hinzugef√ºgt

        const depFilter = document
          .getElementById("filter-departure")
          .value.trim()
          .toUpperCase();
        const arrFilter = document
          .getElementById("filter-arrival")
          .value.trim()
          .toUpperCase();
        const dateFrom = document.getElementById("filter-date-from").value;
        const dateTo = document.getElementById("filter-date-to").value;

        let filteredFlights = allFlights;

        if (depFilter) {
          filteredFlights = filteredFlights.filter((flight) =>
            flight.departure.toUpperCase().includes(depFilter)
          );
        }
        if (arrFilter) {
          filteredFlights = filteredFlights.filter((flight) =>
            flight.arrival.toUpperCase().includes(arrFilter)
          );
        }
        if (dateFrom) {
          filteredFlights = filteredFlights.filter(
            (flight) => flight.date >= dateFrom
          );
        }
        if (dateTo) {
          filteredFlights = filteredFlights.filter(
            (flight) => flight.date <= dateTo
          );
        }

        renderFlights(filteredFlights);
      };

      /**
       * Setzt alle Filterfelder zur√ºck und zeigt wieder die vollst√§ndige Flugliste an.
       */
      window.resetFilters = function () {
        currentPage = 1; // Zur√ºck zu Seite 1
        // Setze die Werte der Input-Felder zur√ºck
        document.getElementById("filter-departure").value = "";
        document.getElementById("filter-arrival").value = "";
        document.getElementById("filter-date-from").value = "";
        document.getElementById("filter-date-to").value = "";

        // Rufe renderFlights ohne Argument auf, um alle Fl√ºge anzuzeigen
        renderFlights();
      };

      /**
       * Setzt den Sortierschl√ºssel und die Richtung und rendert die Liste neu.
       * @param {string} sortKey - Die Eigenschaft, nach der sortiert werden soll (z.B. 'date').
       */
      window.setSortOrder = function (sortKey) {
        currentPage = 1; // Zur√ºck zu Seite 1
        if (currentSort.key === sortKey) {
          // Wenn derselbe Button geklickt wird, kehre die Richtung um
          currentSort.direction =
            currentSort.direction === "asc" ? "desc" : "asc";
        } else {
          // Bei einem neuen Button, setze den Schl√ºssel und starte mit aufsteigender Sortierung
          currentSort.key = sortKey;
          currentSort.direction = "asc";
        }
        // Rendere die Flugliste mit der neuen Sortierung neu
        applyFilters();
      };

      /**
       * Ruft Wetterdaten f√ºr gegebene Koordinaten ab.
       * @param {number} lat - Latitude.
       * @param {number} lon - Longitude.
       * @returns {Promise<object|null>} Ein Promise, das mit dem Wetterobjekt oder null aufgel√∂st wird.
       */
	   /**
      window.fetchWeatherByCoords = async function (lat, lon) {
        try {
          //          const response = await fetch(`/.netlify/functions/fetch-weather?lat=${lat}&lon=${lon}` );

          const response = await fetch(
            `https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-weather?lat=${lat}&lon=${lon}`
          );

          if (!response.ok) {
            console.error(
              `Fehler beim Abrufen des Wetters f√ºr Koordinaten ${lat},${lon}:`,
              response.statusText
            );
            return null;
          }

          const data = await response.json();

          // Die API gibt direkt ein Objekt zur√ºck, keine Liste, wenn sie erfolgreich ist.
          if (data && typeof data.temp !== "undefined") {
            return data;
          }

          return null;
        } catch (error) {
          console.error(
            "Netzwerkfehler beim Aufruf der Wetter-Funktion:",
            error
          );
          return null;
        }
      };
	  */
	  
	  /**
         * Ruft Flughafendaten von der Netlify-Funktion ab.
         * Verwendet IMMER Standard-Browser-Fetch, da wir wissen, dass es funktioniert.
         */
        window.fetchExternalAirport = async function(input) {
            const normalizedInput = input.trim();
            if (normalizedInput.length < 3) return [];
            
            const url = `https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-airport?query=${encodeURIComponent(normalizedInput)}`;

            // Es gibt keinen "if (Capacitor)"-Check mehr. Wir verwenden immer fetch().
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    console.warn(`API-Abfrage f√ºr '${input}' fehlgeschlagen: Status ${response.status}`);
                    return [];
                }
                const apiData = await response.json(); // apiData ist [{iata: "...", name: "...", ...}]

                // Wir m√ºssen die rohen API-Daten in unser {code: ...} Format umwandeln.
                return apiData.map(result => ({
                    code: result.iata || result.icao, // Nimm IATA, ODER nimm ICAO
                        name: result.name,
                        city: result.city,
                        lat: parseFloat(result.latitude),
                        lon: parseFloat(result.longitude)
                }))
				.filter(airport => airport.code);
            } catch (error) {
                console.error("Netzwerkfehler beim Aufruf der Flughafen-Funktion (Fetch):", error);
                return [];
            }
        };
	  
	  /**
         * Ruft den Namen einer Airline anhand ihres IATA-Codes ab.
         * @param {string} iataCode - Der IATA-Code (z.B. "EW").
         * @returns {Promise<string|null>} Der Name der Airline oder null.
         */
        async function fetchAirlineName(iataCode) {
            try {
                const response = await fetch(`https://aesthetic-strudel-ecfe50.netlify.app/.netlify/functions/fetch-airline-details?iata_code=${iataCode}`);
                if (!response.ok) {
                    throw new Error('Airline-Daten konnten nicht geladen werden');
                }
                const result = await response.json();
                
                // KORREKTUR: Die API-Antwort ist { success: true, data: [...] }
                if (result.data && result.data.length > 0) {
                    // Die API gibt jetzt dank des korrekten Parameters nur den exakten Treffer zur√ºck.
                    return result.data[0].name; // Gibt den Namen zur√ºck, z.B. "Eurowings"
                }
                return null; // Kein Treffer gefunden
            } catch (error) {
                console.error("Fehler beim Abrufen des Airline-Namens:", error);
                return null;
            }
        }

      // =================================================================
      // DER EINZIGE DOMContentLoaded-LISTENER GANZ AM ENDE
      // =================================================================

      document.addEventListener("DOMContentLoaded", async function () {
		
		const preferredLanguage = localStorage.getItem('preferredLanguage') || 'de';
		await setLanguage(preferredLanguage);
		
        // Event-Listener NUR f√ºr die Auth-Formulare
        document
          .getElementById("login-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            const { error } = await supabaseClient.auth.signInWithPassword({
              email,
              password,
            });
            if (error) {
              document.getElementById("auth-error").textContent = error.message;
            }
            // KEIN 'else' Block hier. onAuthStateChange k√ºmmert sich um den Erfolg.
          });

        document
          .getElementById("register-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("register-email").value;
            const password = document.getElementById("register-password").value;
            const { error } = await supabaseClient.auth.signUp({
              email,
              password,
            });
            if (error) {
              document.getElementById("auth-error").textContent = error.message;
            } else {
              showMessage(
                "Registrierung erfolgreich!",
                "Bitte best√§tige deine E-Mail-Adresse, um dich einzuloggen.",
                "success"
              );
            }
          });

        document
          .getElementById("request-reset-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("reset-email").value;
            const { error } = await supabaseClient.auth.resetPasswordForEmail(
              email,
              { redirectTo: window.location.origin }
            );
            if (error) {
              showMessage("Fehler", error.message, "error");
            } else {
              showMessage(
                "E-Mail gesendet",
                "Wenn ein Benutzer mit dieser E-Mail existiert, wurde ein Link zum Zur√ºcksetzen gesendet.",
                "success"
              );
            }
          });

        document
          .getElementById("update-password-form")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById(
              "update-password-input"
            ).value;
            if (newPassword.length < 6) {
              showMessage(
                "Fehler",
                "Das Passwort muss mindestens 6 Zeichen lang sein.",
                "error"
              );
              return;
            }
            const { error } = await supabaseClient.auth.updateUser({
              password: newPassword,
            });
            if (error) {
              showMessage(
                "Fehler",
                "Passwort konnte nicht aktualisiert werden: " + error.message,
                "error"
              );
            } else {
              showMessage(
                "Erfolg!",
                "Dein Passwort wurde ge√§ndert. Du kannst dich jetzt einloggen.",
                "success"
              );
              backToLogin();
            }
          });

        // Haupt-Logik: Reagiere auf √Ñnderungen des Login-Status
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          if (event === "PASSWORD_RECOVERY") {
            showAuth();
            showPasswordResetForm();
            document
              .getElementById("request-reset-form")
              .classList.add("hidden");
            document
              .getElementById("update-password-form")
              .classList.remove("hidden");
            showMessage(
              "Willkommen zur√ºck!",
              "Bitte gib jetzt dein neues Passwort ein.",
              "info"
            );
          } else if (session) {
            // Dieser Block wird bei INITIAL_SESSION (Seitenaufruf im eingeloggten Zustand)
            // UND bei SIGNED_IN (direkt nach dem Login) ausgef√ºhrt.
            await initializeApp();
          } else {
            // Dieser Block wird bei SIGNED_OUT ausgef√ºhrt.
            showAuth();
          }
        });
      });
    </script>
  </body>
</html>
